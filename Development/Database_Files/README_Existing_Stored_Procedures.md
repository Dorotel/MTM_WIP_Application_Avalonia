# Existing Stored Procedures

## Overview
This file contains all existing stored procedures that are currently deployed and in use within the MTM WIP Application. These procedures are considered **production code** and should **NOT BE MODIFIED** directly in this file.

## ?? CRITICAL RULES ??

### **DO NOT EDIT THIS FILE**
- This file serves as a **READ-ONLY** reference of existing stored procedures
- Any modifications to existing procedures must be placed in `Updated_Stored_Procedures.sql`
- New procedures must be added to `New_Stored_Procedures.sql`
- This maintains clear separation between existing, updated, and new database code

### **NO HARD-CODED MySQL COMMANDS**
- All database operations in the application **MUST** use stored procedures
- Direct SQL commands in application code are **PROHIBITED**
- Any database interaction must go through defined stored procedures
- This ensures data security, performance optimization, and maintainability

---

## Stored Procedure Categories

### Batch Number Management
These procedures handle the assignment and management of batch numbers for inventory tracking.

#### `assign_BatchNumber_Step0`
**Purpose**: Initializes batch number assignment process by setting all existing records to 'MIGRATED' status.
- **Parameters**: None
- **Returns**: None (UPDATE operations)
- **Usage**: First step in batch number migration process
- **Tables Modified**: `inv_inventory`, `inv_transaction`, `inv_inventory_batch_seq`

#### `assign_BatchNumber_Step1`
**Purpose**: Assigns sequential batch numbers to inventory records and creates corresponding transactions.
- **Parameters**: None
- **Returns**: None (Cursor-based processing)
- **Usage**: Second step - processes inventory records marked as 'MIGRATED'
- **Business Logic**: 
  - Reads inventory records in ID order
  - Assigns sequential batch numbers with zero-padding (10 digits)
  - Creates IN transactions for each inventory item
  - Removes duplicate transactions before inserting
  - Updates sequence tracking

#### `assign_BatchNumber_Step2`
**Purpose**: Assigns batch numbers to remaining IN transactions that weren't processed in Step1.
- **Parameters**: None
- **Returns**: None (Cursor-based processing)
- **Usage**: Third step - handles remaining MIGRATED transactions
- **Business Logic**: Continues batch number sequence from Step1

#### `assign_BatchNumber_Step3`
**Purpose**: Matches IN transactions to OUT transactions for batch traceability (limited processing).
- **Parameters**: None
- **Returns**: Loop count and updated row count
- **Usage**: Fourth step - creates transaction linkages
- **Limitations**: Processes maximum 1000 records per execution
- **Business Logic**: 
  - Matches OUT transactions to IN transactions by part and location
  - Uses chronological order for FIFO matching
  - Tracks progress to allow resumption

#### `assign_BatchNumber_Step4`
**Purpose**: Matches IN transactions to TRANSFER transactions for batch traceability.
- **Parameters**: None  
- **Returns**: Loop count and updated row count
- **Usage**: Fifth step - handles transfer transaction matching
- **Business Logic**: Similar to Step3 but for TRANSFER transaction types

---

### Inventory Management

#### `inv_inventory_Add_Item`
**Purpose**: Adds new inventory items with automatic batch number assignment.
- **Parameters**: 
  - `p_PartID` (VARCHAR(100)): Part identifier
  - `p_Location` (VARCHAR(100)): Storage location
  - `p_Operation` (VARCHAR(100)): Manufacturing operation
  - `p_Quantity` (INT): Quantity to add
  - `p_ItemType` (VARCHAR(200)): Type of inventory item
  - `p_User` (VARCHAR(100)): User performing action
  - `p_Notes` (VARCHAR(1000)): Additional notes
- **Returns**: None
- **Business Logic**: 
  - Generates next batch number using sequence table
  - Inserts into both inventory and transaction tables
  - Maintains data consistency between tables

#### `inv_inventory_Fix_BatchNumbers`
**Purpose**: Repairs missing batch numbers in existing inventory records.
- **Parameters**: 
  - `p_Status` (OUT INT): Success/failure indicator
  - `p_ErrorMsg` (OUT VARCHAR(255)): Error message if failure
- **Returns**: Status and error message
- **Business Logic**: 
  - Finds records with NULL batch numbers
  - Assigns sequential batch numbers
  - Uses transaction control for data safety

#### `inv_inventory_Get_ByPartID`
**Purpose**: Retrieves all inventory records for a specific part.
- **Parameters**: `p_PartID` (VARCHAR(300)): Part identifier
- **Returns**: Recordset of matching inventory items
- **Usage**: Part lookup and inventory inquiries

#### `inv_inventory_Get_ByPartIDandOperation`
**Purpose**: Retrieves inventory records filtered by part and operation.
- **Parameters**: 
  - `p_PartID` (VARCHAR(300)): Part identifier
  - `o_Operation` (VARCHAR(300)): Operation number
- **Returns**: Recordset of matching inventory items
- **Usage**: Operation-specific inventory queries

#### `inv_inventory_Get_ByUser`
**Purpose**: Retrieves inventory records by user, ordered by last update.
- **Parameters**: `p_User` (VARCHAR(100)): Username
- **Returns**: Recordset ordered by LastUpdated DESC
- **Usage**: User activity tracking and recent work display

#### `inv_inventory_Remove_Item`
**Purpose**: Removes inventory items with comprehensive validation and transaction recording.
- **Parameters**: 
  - `p_PartID` (VARCHAR(300)): Part identifier
  - `p_Location` (VARCHAR(100)): Location
  - `p_Operation` (VARCHAR(100)): Operation
  - `p_Quantity` (INT): Quantity to remove
  - `p_ItemType` (VARCHAR(100)): Item type
  - `p_User` (VARCHAR(100)): User performing action
  - `p_BatchNumber` (VARCHAR(100)): Batch number
  - `p_Notes` (VARCHAR(1000)): Notes
  - `p_Status` (OUT INT): Success/failure indicator
  - `p_ErrorMsg` (OUT VARCHAR(255)): Error message
- **Returns**: Status and error message
- **Business Logic**: 
  - Validates quantity > 0
  - Checks for existing records
  - Attempts exact match first, then fuzzy match
  - Records OUT transaction
  - Comprehensive error handling

#### `inv_inventory_Remove_Item_1_1`
**Purpose**: Alternative version of remove item procedure (duplicate functionality).
- **Parameters**: Same as `inv_inventory_Remove_Item`
- **Note**: Appears to be duplicate - may need consolidation

#### `inv_inventory_Transfer_Part`
**Purpose**: Transfers entire inventory record to new location.
- **Parameters**: 
  - `in_BatchNumber` (VARCHAR(300)): Batch identifier
  - `in_PartID` (VARCHAR(300)): Part identifier
  - `in_Operation` (VARCHAR(100)): Operation
  - `in_NewLocation` (VARCHAR(100)): Destination location
- **Business Logic**: Updates location and timestamp for matching records

#### `inv_inventory_Transfer_Quantity`
**Purpose**: Transfers partial quantity to new location, splitting inventory record.
- **Parameters**: 
  - `in_BatchNumber` (VARCHAR(255)): Batch identifier
  - `in_PartID` (VARCHAR(255)): Part identifier
  - `in_Operation` (VARCHAR(255)): Operation
  - `in_TransferQuantity` (INT): Amount to transfer
  - `in_OriginalQuantity` (INT): Original total quantity
  - `in_NewLocation` (VARCHAR(255)): Destination location
  - `in_User` (VARCHAR(255)): User performing transfer
- **Business Logic**: 
  - Validates transfer quantity
  - Reduces original record quantity
  - Creates new record at destination

---

### Transaction Management

#### `inv_transaction_Add`
**Purpose**: Creates new inventory transaction records.
- **Parameters**: 
  - `in_TransactionType` (ENUM('IN','OUT','TRANSFER')): Transaction type
  - `in_PartID` (VARCHAR(300)): Part identifier
  - `in_BatchNumber` (VARCHAR(100)): Batch number
  - `in_FromLocation` (VARCHAR(300)): Source location
  - `in_ToLocation` (VARCHAR(100)): Destination location
  - `in_Operation` (VARCHAR(100)): Operation
  - `in_Quantity` (INT): Quantity
  - `in_Notes` (VARCHAR(1000)): Notes
  - `in_User` (VARCHAR(100)): User
  - `in_ItemType` (VARCHAR(100)): Item type
  - `in_ReceiveDate` (DATETIME): Transaction date
- **Returns**: None
- **Usage**: Direct transaction logging

---

### Logging and Error Management

#### `log_changelog_Get_Current`
**Purpose**: Retrieves the most recent changelog entry.
- **Parameters**: None
- **Returns**: Latest version record
- **Usage**: Application version checking and changelog display

#### `log_error_Add_Error`
**Purpose**: Comprehensive error logging with full diagnostic information.
- **Parameters**: 
  - `p_User` (VARCHAR(100)): User associated with error
  - `p_Severity` (VARCHAR(50)): Error severity level
  - `p_ErrorType` (VARCHAR(100)): Error category
  - `p_ErrorMessage` (TEXT): Error description
  - `p_StackTrace` (TEXT): Full stack trace
  - `p_ModuleName` (VARCHAR(100)): Application module
  - `p_MethodName` (VARCHAR(100)): Method name
  - `p_AdditionalInfo` (TEXT): Extra diagnostic data
  - `p_MachineName` (VARCHAR(100)): Computer name
  - `p_OSVersion` (VARCHAR(100)): Operating system
  - `p_AppVersion` (VARCHAR(50)): Application version
  - `p_ErrorTime` (DATETIME): When error occurred
  - `p_Status` (OUT INT): Success/failure indicator
  - `p_ErrorMsg` (OUT VARCHAR(255)): Status message
- **Returns**: Status and message
- **Business Logic**: Comprehensive error logging with transaction safety

#### `log_error_Delete_All`
**Purpose**: Removes all error log entries.
- **Parameters**: 
  - `p_Status` (OUT INT): Success/failure indicator
  - `p_ErrorMsg` (OUT VARCHAR(255)): Status message
- **Returns**: Status and message
- **Usage**: Log maintenance and cleanup

#### `log_error_Delete_ById`
**Purpose**: Removes specific error log entry.
- **Parameters**: 
  - `p_Id` (INT): Error log ID to delete
  - `p_Status` (OUT INT): Success/failure indicator
  - `p_ErrorMsg` (OUT VARCHAR(255)): Status message
- **Returns**: Status and message

#### `log_error_Get_All`
**Purpose**: Retrieves all error log entries with count.
- **Parameters**: 
  - `p_Status` (OUT INT): Success/failure indicator
  - `p_ErrorMsg` (OUT VARCHAR(255)): Status message
- **Returns**: All error records ordered by date DESC

#### `log_error_Get_ByDateRange`
**Purpose**: Retrieves error logs within date range.
- **Parameters**: 
  - `p_StartDate` (DATETIME): Range start
  - `p_EndDate` (DATETIME): Range end
  - `p_Status` (OUT INT): Success/failure indicator
  - `p_ErrorMsg` (OUT VARCHAR(255)): Status message
- **Returns**: Filtered error records

#### `log_error_Get_ByUser`
**Purpose**: Retrieves error logs for specific user.
- **Parameters**: 
  - `p_User` (VARCHAR(100)): Username
  - `p_Status` (OUT INT): Success/failure indicator
  - `p_ErrorMsg` (OUT VARCHAR(255)): Status message
- **Returns**: User-specific error records

#### `log_error_Get_Unique`
**Purpose**: Retrieves unique combinations of method and error message.
- **Parameters**: 
  - `p_Status` (OUT INT): Success/failure indicator
  - `p_ErrorMsg` (OUT VARCHAR(255)): Status message
- **Returns**: Distinct error patterns
- **Usage**: Error analysis and pattern identification

---

### Master Data Management

#### Master Data Item Types
- `md_item_types_Add_ItemType`: Adds new item type
- `md_item_types_Delete_ByID`: Removes item type by ID
- `md_item_types_Delete_ByType`: Removes item type by name
- `md_item_types_Get_All`: Retrieves all item types
- `md_item_types_Update_ItemType`: Updates existing item type

#### Master Data Locations
- `md_locations_Add_Location`: Adds new location
- `md_locations_Delete_ByLocation`: Removes location
- `md_locations_Get_All`: Retrieves all locations
- `md_locations_Update_Location`: Updates existing location

#### Master Data Operations
- `md_operation_numbers_Add_Operation`: Adds new operation
- `md_operation_numbers_Delete_ByOperation`: Removes operation
- `md_operation_numbers_Get_All`: Retrieves all operations
- `md_operation_numbers_Update_Operation`: Updates existing operation

#### Master Data Parts
- `md_part_ids_Add_Part`: Adds new part
- `md_part_ids_Delete_ByItemNumber`: Removes part
- `md_part_ids_Get_All`: Retrieves all parts
- `md_part_ids_Get_ByItemNumber`: Retrieves specific part
- `md_part_ids_Update_Part`: Updates existing part

---

### System Maintenance

#### `maint_InsertMissingUserUiSettings`
**Purpose**: Ensures all users have UI settings records.
- **Business Logic**: Creates default UI settings for users missing them

#### `maint_reload_part_ids_and_operation_numbers`
**Purpose**: Rebuilds master data from source systems.
- **Parameters**: 
  - `p_Status` (OUT INT): Success/failure indicator
  - `p_ErrorMsg` (OUT VARCHAR(255)): Status message
- **Business Logic**: 
  - Rebuilds `md_part_ids` from external part_requirement table
  - Regenerates operation numbers from part data
  - Comprehensive transaction handling

#### `sp_ReassignBatchNumbers`
**Purpose**: Complete batch number reassignment for existing data.
- **Business Logic**: 
  - Processes all transactions lacking batch numbers
  - Maintains chronological order
  - Updates sequence tracking

---

### User Management

#### User Account Management
- `usr_users_Add_User`: Creates new user account with MySQL user creation
- `usr_users_Delete_User`: Removes user account and MySQL user
- `usr_users_Exists`: Checks if user exists
- `usr_users_Get_All`: Retrieves all users
- `usr_users_Get_ByUser`: Retrieves specific user
- `usr_users_Update_User`: Updates user information

#### User Interface Settings
- `usr_ui_settings_Get`: Retrieves user UI settings
- `usr_ui_settings_GetShortcutsJson`: Gets keyboard shortcuts
- `usr_ui_settings_SetJsonSetting`: Updates specific UI setting
- `usr_ui_settings_SetShortcutsJson`: Updates shortcuts
- `usr_ui_settings_SetThemeJson`: Updates theme settings

---

### System Features

#### Quick Transaction Buttons
- `sys_last_10_transactions_Get_ByUser`: Retrieves user's quick buttons
- `sys_last_10_transactions_AddQuickButton_1`: Adds new quick button
- `sys_last_10_transactions_Move_1`: Reorders buttons
- `sys_last_10_transactions_RemoveAndShift_ByUser_1`: Removes button
- `sys_last_10_transactions_Update_ByUserAndPosition_1`: Updates button
- Multiple variants exist for different implementation approaches

#### Role Management
- `sys_roles_Get_ById`: Retrieves role definition
- `sys_user_roles_Add`: Assigns role to user
- `sys_user_roles_Delete`: Removes role assignment
- `sys_user_roles_Update`: Updates user role

---

## Critical Integration Points

### Application Layer Dependencies
All these stored procedures are called by:
- **Services Layer**: `DatabaseService`, `InventoryService`, `UserService`
- **Helper Classes**: `Helper_Database_StoredProcedure`
- **Business Logic**: Various business operation classes

### Transaction Safety
Most procedures include:
- Transaction management (BEGIN/COMMIT/ROLLBACK)
- Error handling with proper exception propagation
- Status return codes and error messages
- Data validation before modification

### Performance Considerations
- Cursor-based processing for large datasets
- Indexed access patterns
- Batch size limitations for long-running operations
- Progress tracking for resumable operations

### Security Features
- Parameter validation
- SQL injection prevention through parameterization
- User tracking for all modifications
- Audit trail maintenance

## Usage in Application Code

### Correct Usage Pattern
```csharp
// CORRECT: Using stored procedure
var result = await DatabaseService.ExecuteStoredProcedureAsync(
    "inv_inventory_Add_Item",
    parameters
);
```

### ? PROHIBITED Usage Pattern
```csharp
// WRONG: Hard-coded SQL is prohibited
var sql = "INSERT INTO inv_inventory (PartID, Location, Quantity) VALUES (@part, @loc, @qty)";
var result = await connection.ExecuteAsync(sql, parameters);
```

## Documentation Maintenance

### When Adding New Procedures
1. Add to `New_Stored_Procedures.sql`
2. Document in this README under appropriate category
3. Update application service layers to use new procedure
4. Add to deployment scripts

### When Modifying Existing Procedures
1. Copy original to this file (if not already present)
2. Place modified version in `Updated_Stored_Procedures.sql`
3. Document changes and migration requirements
4. Update application code to handle any interface changes

This comprehensive collection of stored procedures provides complete database functionality for the MTM WIP Application while maintaining strict separation between data and application logic.