# Copilot Continuation Prompt - Advanced Inventory View

> **Generated by MTM Audit System** - Version 1.0  
> **Target Branch**: master  
> **Feature**: Advanced Inventory View - Enhanced Multi-Mode Inventory Operations  
> **Gap Report Date**: 2025-01-27 14:32:00 UTC

## Context Summary

The Advanced Inventory View implementation has progressed to 65% completion with excellent foundational architecture. The current implementation includes:

- ‚úÖ **Solid MVVM Foundation**: `AdvancedInventoryViewModel` with 100% MVVM Community Toolkit compliance
- ‚úÖ **MTM Architecture Compliance**: Perfect theme integration, proper service registration, dependency injection patterns
- ‚úÖ **Basic UI Structure**: Avalonia AXAML with correct syntax, ScrollViewer layout, comprehensive styling
- ‚ùå **Critical Missing Features**: CollapsiblePanel integration, multi-mode interface, database connectivity, Excel integration

**Previous Progress**: The team has successfully established the architectural foundation with proper MTM patterns, but needs focused implementation work to complete the three specialized modes specified in the implementation plan.

## üéØ Immediate Focus Areas (Critical Priority)

### 1. CollapsiblePanel Integration (CRITICAL - 2 hours)
**Current State**: Basic Border controls used instead of CollapsiblePanel components
**Required Implementation**: 
```xml
<!-- CRITICAL: Replace existing Border in AdvancedInventoryView.axaml -->
<CollapsiblePanel x:Name="ModeSelectionPanel" 
                  IsExpanded="{Binding IsModeSelectionExpanded}"
                  Header="Mode & Entry">
  <!-- Mode selection and entry forms content -->
</CollapsiblePanel>

<CollapsiblePanel x:Name="AnalyticsPanel"
                  IsExpanded="{Binding IsAnalyticsExpanded}"
                  Header="Analytics & Status">  
  <!-- Analytics content -->
</CollapsiblePanel>
```

### 2. Multi-Mode Interface Implementation (CRITICAL - 2 hours)
**Current State**: Single interface shown - missing three specialized modes
**Required Implementation**:
```xml
<!-- Add to AdvancedInventoryView.axaml -->
<StackPanel Orientation="Vertical" Spacing="8">
  <RadioButton Content="Multiple Times Mode" 
               IsChecked="{Binding IsMultipleTimesMode}"
               ToolTip.Tip="Add same item multiple times" />
  <RadioButton Content="Multiple Locations Mode" 
               IsChecked="{Binding IsMultipleLocationsMode}" 
               ToolTip.Tip="Add item to multiple locations" />
  <RadioButton Content="Excel Import Mode" 
               IsChecked="{Binding IsExcelImportMode}"
               ToolTip.Tip="Import from Excel file" />
</StackPanel>

<!-- Conditional visibility for each mode -->
<Border IsVisible="{Binding IsMultipleTimesMode}">
  <!-- Multiple Times specific controls -->
</Border>
<Border IsVisible="{Binding IsMultipleLocationsMode}">
  <!-- Multiple Locations specific controls --> 
</Border>
<Border IsVisible="{Binding IsExcelImportMode}">
  <!-- Excel Import specific controls -->
</Border>
```

### 3. Database Integration (CRITICAL - 2 hours)
**Current State**: All commands use `await Task.Delay()` placeholders  
**Required Implementation**:
```csharp
// CRITICAL: Replace in AdvancedInventoryViewModel.cs
[RelayCommand(CanExecute = nameof(CanAddMultipleTimes))]
private async Task AddMultipleTimesAsync()
{
    try
    {
        IsBusy = true;
        StatusMessage = "Adding multiple transactions...";
        
        var parameters = new MySqlParameter[]
        {
            new("p_PartID", SelectedPartID),
            new("p_Operation", SelectedOperation),
            new("p_Location", SelectedLocation),
            new("p_Quantity", Quantity),
            new("p_RepeatTimes", RepeatTimes),
            new("p_User", _applicationState.CurrentUser ?? "System")
        };

        var result = await Helper_Database_StoredProcedure.ExecuteDataTableWithStatus(
            connectionString,
            "inv_inventory_Add_MultipleTransactions", 
            parameters
        );

        if (result.Status == 1)
        {
            StatusMessage = $"Successfully added {RepeatTimes} transactions";
            ResetMultipleTimesCommand.Execute(null);
        }
        else
        {
            await Services.ErrorHandling.HandleErrorAsync(
                new InvalidOperationException($"Database operation failed with status: {result.Status}"),
                "Add Multiple Transactions Failed"
            );
        }
    }
    catch (Exception ex)
    {
        await Services.ErrorHandling.HandleErrorAsync(ex, "Add Multiple Transactions");
    }
    finally
    {
        IsBusy = false;
    }
}
```

## üèóÔ∏è MTM Architecture Requirements (MUST FOLLOW)

### MVVM Community Toolkit Patterns (MAINTAIN - Already Correct)
```csharp
// ‚úÖ CURRENT IMPLEMENTATION IS CORRECT - DO NOT CHANGE
[ObservableObject]
public partial class AdvancedInventoryViewModel : BaseViewModel
{
    [ObservableProperty] 
    private string selectedPartID = string.Empty;
    
    [RelayCommand(CanExecute = nameof(CanAddMultipleTimes))]
    private async Task AddMultipleTimesAsync() { }
}
```

### Avalonia AXAML Requirements (MAINTAIN - Already Correct)
```xml
<!-- ‚úÖ CURRENT SYNTAX IS CORRECT - DO NOT CHANGE -->
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="MTM_WIP_Application_Avalonia.Views.AdvancedInventoryView">
  <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
    <Grid x:Name="MainContainer" RowDefinitions="*,Auto">
      <!-- CORRECT: x:Name usage, RowDefinitions, ScrollViewer root -->
    </Grid>
  </ScrollViewer>
</UserControl>
```

### Database Access Patterns (CRITICAL - MUST IMPLEMENT)
```csharp
// ‚úÖ REQUIRED PATTERN - Replace all Task.Delay() placeholders
private async Task LoadMasterDataAsync()
{
    try
    {
        var partResult = await Helper_Database_StoredProcedure.ExecuteDataTableWithStatus(
            connectionString, "md_part_ids_Get_All", Array.Empty<MySqlParameter>()
        );
        
        if (partResult.Status == 1)
        {
            PartIDOptions.Clear();
            foreach (DataRow row in partResult.Data.Rows)
            {
                PartIDOptions.Add(row["PartID"].ToString() ?? string.Empty);
            }
        }
        else
        {
            await Services.ErrorHandling.HandleErrorAsync(
                new InvalidOperationException($"Failed to load parts: {partResult.Status}"),
                "Master Data Loading"
            );
        }
    }
    catch (Exception ex)
    {
        await Services.ErrorHandling.HandleErrorAsync(ex, "Load Master Data");
    }
}
```

## üîÑ Current Implementation Status

### ‚úÖ Completed Components (MAINTAIN AS-IS)
1. **AdvancedInventoryViewModel.cs** - Property structure, command declarations, MVVM compliance
2. **AdvancedInventoryView.axaml.cs** - Code-behind with proper dependency injection
3. **ServiceCollectionExtensions.cs** - ViewModel registration as TryAddTransient
4. **Theme Integration** - Perfect DynamicResource bindings throughout AXAML

### üîÑ Partially Implemented (COMPLETE THESE)
1. **AdvancedInventoryView.axaml** - Layout foundation exists, needs CollapsiblePanel + multi-mode UI
2. **Command Implementations** - All declared with CanExecute, need database integration  
3. **Master Data Loading** - Properties defined, need stored procedure calls
4. **Error Handling** - Basic try-catch exists, need Services.ErrorHandling integration

### ‚ùå Missing Components (CREATE THESE)
1. **PreviewTransaction.cs** - Model for transaction preview grid
2. **ExcelInventoryRecord.cs** - Model for Excel import data
3. **Mode Selection Logic** - RadioButton bindings and conditional visibility
4. **Preview DataGrid Implementation** - Comprehensive transaction preview with columns

## üìã Implementation Priority Order

### Phase 1: Critical Infrastructure (4 hours)
1. **CollapsiblePanel Integration** - Replace Border controls
2. **Multi-Mode RadioButtons** - Add mode selection UI
3. **Database Connectivity** - Replace Task.Delay() with stored procedures
4. **Error Handling Integration** - Add Services.ErrorHandling calls

### Phase 2: Feature Completion (4 hours)  
5. **Preview System** - Implement transaction preview DataGrid
6. **Excel Integration** - File selection and ClosedXML processing
7. **Master Data Auto-loading** - Load Part IDs, Operations, Locations on startup
8. **Conditional Mode Controls** - Show/hide controls based on mode selection

### Phase 3: Polish & Testing (2 hours)
9. **Progress Reporting** - Enhanced progress feedback for long operations
10. **Validation Enhancement** - Comprehensive input validation
11. **Integration Testing** - Verify all modes function correctly
12. **MTM Compliance Verification** - Final architecture pattern validation

## üö® Critical Compliance Checks

### Database Access (MUST USE STORED PROCEDURES ONLY)
- [ ] Replace ALL `await Task.Delay()` calls with `Helper_Database_StoredProcedure.ExecuteDataTableWithStatus()`
- [ ] Use existing stored procedures: `md_part_ids_Get_All`, `md_operations_Get_All`, `md_locations_Get_All`
- [ ] NO direct SQL queries or string concatenation
- [ ] Return empty collections on failure (NO fallback data)

### MVVM Community Toolkit (MAINTAIN CURRENT PATTERNS)
- [ ] Keep ALL `[ObservableObject]`, `[ObservableProperty]`, `[RelayCommand]` patterns
- [ ] NO ReactiveUI patterns (correctly absent)
- [ ] Maintain BaseViewModel inheritance
- [ ] Keep constructor dependency injection with ArgumentNullException.ThrowIfNull

### Avalonia AXAML Syntax (MAINTAIN CURRENT COMPLIANCE)
- [ ] Keep `xmlns="https://github.com/avaloniaui"` namespace
- [ ] Keep `x:Name` usage on Grid definitions (NOT `Name`)
- [ ] Maintain `RowDefinitions="*,Auto"` pattern
- [ ] Keep ScrollViewer as root element
- [ ] Keep ALL DynamicResource bindings for theme system

### Error Handling (MUST IMPLEMENT)
- [ ] Replace try-catch with `await Services.ErrorHandling.HandleErrorAsync(ex, context)`
- [ ] Add structured logging with context information  
- [ ] Provide user-friendly error messages
- [ ] Handle database failures gracefully

## üí° Code Examples for Current Context

### CollapsiblePanel Implementation
```xml
<!-- Replace current Border structure in AdvancedInventoryView.axaml -->
<Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="6">
  <!-- Left Panel: Mode & Entry -->
  <CollapsiblePanel Grid.Column="0" 
                    IsExpanded="{Binding IsModeSelectionExpanded}"
                    Header="Mode & Entry"
                    MinWidth="200">
    <!-- Current entry form content goes here -->
  </CollapsiblePanel>
  
  <!-- Center Panel: Preview (static) -->
  <Border Grid.Column="1" Background="{DynamicResource MTM_Shared_Logic.CardBackgroundBrush}">
    <!-- Current preview grid content -->
  </Border>
  
  <!-- Right Panel: Analytics -->
  <CollapsiblePanel Grid.Column="2"
                    IsExpanded="{Binding IsAnalyticsExpanded}" 
                    Header="Analytics"
                    MinWidth="180">
    <!-- Analytics content -->
  </CollapsiblePanel>
</Grid>
```

### Mode Selection Implementation  
```xml
<!-- Add to left panel content -->
<Border Background="{DynamicResource MTM_Shared_Logic.PrimaryAction}" CornerRadius="4" Padding="8" Margin="0,0,0,8">
  <StackPanel Orientation="Vertical" Spacing="6">
    <TextBlock Text="Operation Mode" Foreground="{DynamicResource MTM_Shared_Logic.OverlayTextBrush}" 
               FontWeight="SemiBold" FontSize="10" />
    <RadioButton Content="Multiple Times" IsChecked="{Binding IsMultipleTimesMode}" 
                 Foreground="{DynamicResource MTM_Shared_Logic.OverlayTextBrush}" />
    <RadioButton Content="Multiple Locations" IsChecked="{Binding IsMultipleLocationsMode}"
                 Foreground="{DynamicResource MTM_Shared_Logic.OverlayTextBrush}" />
    <RadioButton Content="Excel Import" IsChecked="{Binding IsExcelImportMode}"
                 Foreground="{DynamicResource MTM_Shared_Logic.OverlayTextBrush}" />
  </StackPanel>
</Border>
```

### Database Integration Pattern
```csharp
// Master data loading in ViewModel constructor
private async Task InitializeDataAsync()
{
    try
    {
        // Load Part IDs
        var partResult = await Helper_Database_StoredProcedure.ExecuteDataTableWithStatus(
            _configurationService.GetConnectionString(), 
            "md_part_ids_Get_All", 
            Array.Empty<MySqlParameter>()
        );
        
        if (partResult.Status == 1)
        {
            PartIDOptions.Clear();
            foreach (DataRow row in partResult.Data.Rows)
            {
                PartIDOptions.Add(row["PartID"].ToString() ?? string.Empty);
            }
        }
        
        // Load Operations
        var operationResult = await Helper_Database_StoredProcedure.ExecuteDataTableWithStatus(
            _configurationService.GetConnectionString(), 
            "md_operation_numbers_Get_All", 
            Array.Empty<MySqlParameter>()
        );
        
        if (operationResult.Status == 1)
        {
            OperationOptions.Clear();
            foreach (DataRow row in operationResult.Data.Rows)
            {
                OperationOptions.Add(row["OperationNumber"].ToString() ?? string.Empty);
            }
        }
        
        // Load Locations
        var locationResult = await Helper_Database_StoredProcedure.ExecuteDataTableWithStatus(
            _configurationService.GetConnectionString(), 
            "md_locations_Get_All", 
            Array.Empty<MySqlParameter>()
        );
        
        if (locationResult.Status == 1)
        {
            LocationOptions.Clear();
            AvailableLocations.Clear();
            foreach (DataRow row in locationResult.Data.Rows)
            {
                var location = row["Location"].ToString() ?? string.Empty;
                LocationOptions.Add(location);
                AvailableLocations.Add(location);
            }
        }
    }
    catch (Exception ex)
    {
        await Services.ErrorHandling.HandleErrorAsync(ex, "Initialize Advanced Inventory Data");
    }
}
```

## üîç Testing & Validation Checklist

### Functional Validation
- [ ] Mode selection RadioButtons switch interface correctly
- [ ] Each mode shows appropriate controls (Multiple Times, Multiple Locations, Excel)
- [ ] CollapsiblePanel expand/collapse functions properly
- [ ] Database operations complete successfully (no Task.Delay placeholders)
- [ ] Master data loads from stored procedures on startup
- [ ] Error handling provides user feedback via Services.ErrorHandling

### MTM Pattern Compliance  
- [ ] MVVM Community Toolkit patterns maintained
- [ ] Avalonia AXAML syntax follows MTM standards
- [ ] Theme integration works across all theme variants
- [ ] Service registration and dependency injection functional
- [ ] Stored procedures used exclusively for database access

### User Experience Validation
- [ ] Interface clearly shows three distinct modes
- [ ] CollapsiblePanel provides efficient workflow navigation
- [ ] Preview system shows pending transactions before commit
- [ ] Progress indicators keep users informed during operations
- [ ] Error messages are clear and actionable

## üöÄ Execution Instruction

**Priority Focus**: Implement CollapsiblePanel integration and multi-mode interface as the critical path to achieving the implementation plan requirements. The current foundation is excellent - focus on bridging the gap between the basic single-mode interface and the comprehensive three-mode system specified in the plan.

**Key Success Factors**: 
1. Maintain all existing MTM architectural compliance
2. Replace Task.Delay() placeholders with actual database operations
3. Implement the CollapsiblePanel paradigm specified in the implementation plan
4. Add comprehensive multi-mode interface with RadioButton selection

#github-pull-request_copilot-coding-agent

---

@copilot Complete the Advanced Inventory View implementation following the detailed patterns above. Focus on the critical priorities: 1) Replace Border controls with CollapsiblePanel components in AdvancedInventoryView.axaml, 2) Add multi-mode RadioButton interface with conditional visibility, 3) Replace all Task.Delay() placeholders in AdvancedInventoryViewModel.cs with Helper_Database_StoredProcedure.ExecuteDataTableWithStatus() calls, and 4) Integrate Services.ErrorHandling.HandleErrorAsync() for all error handling. Maintain 100% MTM architecture compliance while implementing the three specialized modes (Multiple Times, Multiple Locations, Excel Import) as specified in the implementation plan. The foundation is solid - focus on feature completion and database connectivity.
