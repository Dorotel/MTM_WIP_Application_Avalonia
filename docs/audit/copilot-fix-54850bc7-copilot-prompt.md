# Copilot Continuation Prompt - Theme V2 Full Implementation

> **Generated by MTM Audit System** - Version 1.0  
> **Last Updated**: 2024-01-27 10:45:00 UTC  
> **Branch**: `copilot/fix-54850bc7-e6dd-49d5-b25c-b8b8bf4efc2e`  
> **GitHub PR**: #88 "Theme V2 ‚Äî Full Implementation Plan and Resource Foundation"

---

## üéØ Session Context & Objectives

**Referenced Files**: Following MTM copilot-instructions.md - all required instruction files, context files, templates, and patterns are automatically referenced for this response.

### Current Status
- ‚úÖ **Implementation Plan**: Comprehensive 908-line plan completed at `docs/ways-of-work/plan/theme-v2/full-rebuild/implementation-plan.md`
- ‚ùå **Implementation Progress**: 15% complete - Foundation architecture completely missing
- üéØ **Immediate Goal**: Complete Task 1.1 Foundation Architecture (Priority P0-Critical)

### Development Context
Working on GitHub PR #88 implementing a semantic token-based theme system for MTM WIP Application using Avalonia UI 11.3.4 with ThemeVariant support, MVVM Community Toolkit patterns, and MySQL persistence.

---

## üèóÔ∏è Critical Implementation Requirements

### MANDATORY: Avalonia UI 11.3.4 Patterns
```csharp
// ‚úÖ CORRECT: Use MVVM Community Toolkit source generators
[ObservableObject]
public partial class ThemeServiceV2 : IThemeServiceV2
{
    [ObservableProperty]
    private string currentTheme = "Light";

    [RelayCommand]
    private async Task SwitchThemeAsync(string themeId) { /* implementation */ }
}
```

### MANDATORY: Theme Resource Architecture
```xml
<!-- ‚úÖ CORRECT: Semantic token structure in Resources/ThemesV2/ -->
<ResourceDictionary xmlns="https://github.com/avaloniaui">
    <!-- Color Primitives -->
    <Color x:Key="ThemeV2.Color.Blue.50">#EFF6FF</Color>
    
    <!-- Semantic Roles -->
    <StaticResource x:Key="ThemeV2.Color.Background.Primary" 
                    ResourceKey="{ThemeVariant Light=ThemeV2.Color.Blue.50, Dark=ThemeV2.Color.Gray.900}" />
</ResourceDictionary>
```

### MANDATORY: MySQL Database Integration
```csharp
// ‚úÖ CORRECT: Use existing stored procedure pattern
var result = await Helper_Database_StoredProcedure.ExecuteDataTableWithStatus(
    connectionString,
    "theme_user_preferences_Set",  // New stored procedure required
    new MySqlParameter[] {
        new("p_UserId", userId),
        new("p_ThemeId", themeId)
    }
);
```

---

## üìã Immediate Tasks (Next Session Focus)

### Task 1.1: Foundation Architecture (P0-Critical, 4-5 hours)

**Create these files in exact order:**

1. **`Resources/ThemesV2/Tokens.axaml`** - Color primitive definitions
   ```xml
   <!-- Color Primitives: Blue, Gray, Red, Green, Yellow tonal ramps -->
   <!-- HSL-based system for consistent hover/pressed/disabled states -->
   <!-- WCAG 2.1 AA compliant contrast ratios -->
   ```

2. **`Resources/ThemesV2/Semantic.axaml`** - Role-based semantic mapping
   ```xml
   <!-- Background, Surface, Primary, Secondary, Accent semantic roles -->
   <!-- Interactive state definitions (hover, pressed, disabled) -->
   <!-- Typography and spacing semantic tokens -->
   ```

3. **`Resources/ThemesV2/Theme.Light.axaml`** - Light theme variant
   ```xml
   <!-- Light theme semantic token assignments -->
   <!-- OS integration with ThemeVariant="Light" -->
   ```

4. **`Resources/ThemesV2/Theme.Dark.axaml`** - Dark theme variant
   ```xml
   <!-- Dark theme semantic token assignments -->
   <!-- OS integration with ThemeVariant="Dark" -->
   ```

5. **`Resources/ThemesV2/BaseStyles.axaml`** - Control styling definitions
   ```xml
   <!-- Button, TextBox, ComboBox styles using semantic tokens -->
   <!-- MTM-specific control styling (CustomDataGrid, CollapsiblePanel) -->
   ```

### Task 1.2: Service Implementation (P0-Critical, 3-4 hours)

**Create these service files:**

1. **`Services/IThemeServiceV2.cs`** - Service interface
   ```csharp
   public interface IThemeServiceV2 : INotifyPropertyChanged
   {
       string CurrentTheme { get; }
       Task<ServiceResult> SetThemeAsync(string themeId);
       Task<ServiceResult> InitializeAsync();
       event EventHandler<ThemeChangedEventArgs> ThemeChanged;
   }
   ```

2. **`Services/ThemeServiceV2.cs`** - Core implementation
   ```csharp
   [ObservableObject]
   public partial class ThemeServiceV2 : IThemeServiceV2
   {
       // Avalonia 11.3.4 ThemeVariant integration
       // MySQL persistence via stored procedures
       // OS theme detection and synchronization
   }
   ```

3. **`Models/ThemeModels.cs`** - Theme data models
   ```csharp
   public record ThemeInfo(string Id, string DisplayName, bool IsDark);
   public record ThemeChangedEventArgs(ThemeInfo Previous, ThemeInfo Current);
   ```

---

## üé® Design System Specifications

### Color System Requirements
- **Tonal Ramps**: 50, 100, 200, 300, 400, 500, 600, 700, 800, 900 for each color family
- **Color Families**: Blue (primary), Gray (neutral), Red (error), Green (success), Yellow (warning)
- **Contrast Compliance**: All combinations must meet WCAG 2.1 AA (4.5:1 normal text, 3:1 large text)
- **Interactive States**: 10% darker for hover, 20% darker for pressed, 60% opacity for disabled

### Semantic Token Architecture
```
ThemeV2.Color.Background.Primary    ‚Üí Surface colors
ThemeV2.Color.Surface.Secondary     ‚Üí Card/panel backgrounds  
ThemeV2.Color.Content.Primary       ‚Üí Primary text
ThemeV2.Color.Content.Secondary     ‚Üí Secondary text
ThemeV2.Color.Action.Primary        ‚Üí Primary buttons
ThemeV2.Color.Action.Secondary      ‚Üí Secondary buttons
ThemeV2.Color.Border.Default        ‚Üí Default borders
ThemeV2.Color.State.Hover           ‚Üí Interactive hover states
```

---

## üóÑÔ∏è Database Integration Requirements

### Required Stored Procedures
Create these MySQL stored procedures following MTM patterns:

```sql
-- Theme preference storage
DELIMITER //
CREATE PROCEDURE theme_user_preferences_Set(
    IN p_UserId VARCHAR(50),
    IN p_ThemeId VARCHAR(50)
)
BEGIN
    -- Store user theme preference
    -- Follow existing MTM stored procedure patterns
END //

CREATE PROCEDURE theme_user_preferences_Get(
    IN p_UserId VARCHAR(50)
)  
BEGIN
    -- Retrieve user theme preference
    -- Return Status and Data like existing procedures
END //
DELIMITER ;
```

---

## üîß Technical Implementation Patterns

### MTM Service Registration Pattern
```csharp
// In ServiceCollectionExtensions.cs
public static IServiceCollection AddThemeServices(this IServiceCollection services)
{
    services.TryAddSingleton<IThemeServiceV2, ThemeServiceV2>();
    return services;
}
```

### Avalonia App.axaml Integration
```xml
<Application.Styles>
    <StyleInclude Source="avares://MTM_WIP_Application_Avalonia/Resources/ThemesV2/BaseStyles.axaml"/>
    <FluentTheme />
</Application.Styles>
```

### ViewModel Theme Integration
```csharp
[ObservableObject]
public partial class SomeViewModel : BaseViewModel
{
    private readonly IThemeServiceV2 _themeService;
    
    public SomeViewModel(IThemeServiceV2 themeService) : base(logger)
    {
        _themeService = themeService;
        _themeService.ThemeChanged += OnThemeChanged;
    }
}
```

---

## üß™ Testing Requirements

### Unit Test Structure
```csharp
public class ThemeServiceV2Tests : IAsyncLifetime
{
    [Fact]
    public async Task SetThemeAsync_ValidTheme_ShouldUpdateCurrentTheme()
    {
        // Arrange
        var service = CreateThemeService();
        
        // Act  
        var result = await service.SetThemeAsync("Dark");
        
        // Assert
        result.IsSuccess.Should().BeTrue();
        service.CurrentTheme.Should().Be("Dark");
    }
}
```

### Integration Test Requirements
- Theme switching updates all UI elements
- Database persistence works correctly
- OS theme detection functions properly
- Performance meets <200ms switching threshold

---

## üìÅ Expected File Structure After Implementation

```
Resources/ThemesV2/
‚îú‚îÄ‚îÄ Tokens.axaml              ‚úÖ Color primitives & tonal ramps
‚îú‚îÄ‚îÄ Semantic.axaml            ‚úÖ Role-based semantic mapping
‚îú‚îÄ‚îÄ Theme.Light.axaml         ‚úÖ Light theme implementation  
‚îú‚îÄ‚îÄ Theme.Dark.axaml          ‚úÖ Dark theme implementation
‚îî‚îÄ‚îÄ BaseStyles.axaml          ‚úÖ Control styling definitions

Services/
‚îú‚îÄ‚îÄ IThemeServiceV2.cs        ‚úÖ Service interface
‚îú‚îÄ‚îÄ ThemeServiceV2.cs         ‚úÖ Core service implementation
‚îî‚îÄ‚îÄ Models/
    ‚îî‚îÄ‚îÄ ThemeModels.cs        ‚úÖ Theme data models

Database/
‚îî‚îÄ‚îÄ StoredProcedures/
    ‚îú‚îÄ‚îÄ theme_user_preferences_Set.sql    ‚úÖ Theme preference storage
    ‚îî‚îÄ‚îÄ theme_user_preferences_Get.sql    ‚úÖ Theme preference retrieval
```

---

## ‚ö†Ô∏è Critical Implementation Notes

### AVOID These Common Mistakes
- ‚ùå **Never use `Name` on Grid** - Use `x:Name` only (AVLN2000 prevention)
- ‚ùå **Never use ReactiveUI patterns** - Use MVVM Community Toolkit exclusively
- ‚ùå **Never use direct SQL** - Use `Helper_Database_StoredProcedure.ExecuteDataTableWithStatus()` only
- ‚ùå **Never hardcode colors** - Use semantic tokens exclusively
- ‚ùå **Never ignore OS theme changes** - Implement proper OS integration

### ENSURE These Patterns
- ‚úÖ **Use `xmlns="https://github.com/avaloniaui"`** in all AXAML files
- ‚úÖ **Use `[ObservableProperty]` and `[RelayCommand]`** in ViewModels
- ‚úÖ **Use `DynamicResource`** for theme-aware UI bindings
- ‚úÖ **Use `await ErrorHandling.HandleErrorAsync()`** for error management
- ‚úÖ **Use `ArgumentNullException.ThrowIfNull()`** for parameter validation

---

## üéØ Session Success Criteria

### Completion Targets for Next Session
1. **Foundation Files**: All 5 ThemesV2 AXAML files created and functional
2. **Service Interface**: IThemeServiceV2 defined with proper MVVM Community Toolkit integration
3. **Database Schema**: Theme preference stored procedures ready for deployment
4. **Basic Integration**: Theme switching working in development environment

### Validation Steps
1. Build succeeds without errors
2. Theme resources load correctly in Avalonia designer
3. Basic light/dark switching functional
4. No AVLN2000 compilation errors
5. Follows all MTM architectural patterns

---

## üìù Next Session Workflow

1. **Start with Foundation**: Create `Resources/ThemesV2/` directory structure
2. **Build Incrementally**: Add files in dependency order (Tokens ‚Üí Semantic ‚Üí Variants ‚Üí Styles)
3. **Test Each Step**: Verify each file loads correctly before proceeding
4. **Follow MTM Patterns**: Use established naming conventions and architectural patterns
5. **Document Progress**: Update implementation plan with completed sections

**Estimated Time**: 6-8 hours for complete foundation architecture and basic service implementation.

---

*This continuation prompt was generated by the MTM Audit System. All specifications follow established MTM architectural patterns and Avalonia UI 11.3.4 best practices.*
