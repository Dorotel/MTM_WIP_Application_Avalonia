# Copilot Continuation Prompt - Advanced CustomDataGrid Column Management

> **Generated by MTM Audit System** - Version 1.0  
> **Target Branch**: copilot/fix-d1343396-8581-4090-a1cf-f95565ecf584  
> **Feature**: Advanced CustomDataGrid Column Sorting & Management Implementation  
> **Gap Report Date**: 2025-09-18 14:30:00

## Context Summary

The MTM CustomDataGrid implementation is 85% complete with excellent foundational work:

**COMPLETED (Phase 2)**: Column sorting is fully implemented with multi-column support, visual indicators, and manufacturing-specific business rules. All acceptance criteria verified and tested.

**IN PROGRESS (Phase 3a)**: Column Management Panel UI is complete with comprehensive checkbox interface, manufacturing business rules, and animation logic. However, **critical integration gaps prevent the feature from functioning end-to-end**.

**CRITICAL ISSUES**: The gear icon shows the panel and checkboxes can be toggled, but changes don't actually apply to the grid columns. Configuration doesn't persist across sessions. The UI exists but lacks backend integration.

## üéØ Immediate Focus Areas (Critical Priority)

### 1. Missing ColumnConfigurationService (BLOCKING)

**Problem**: Service is referenced in PRD and code comments but doesn't exist. Configuration persistence is completely missing.

**Solution Required**: Create `Services/ColumnConfigurationService.cs` with proper MTM patterns:

```csharp
// REQUIRED: Full service implementation following MTM dependency injection patterns
[ObservableObject]
public partial class ColumnConfigurationService : IColumnConfigurationService
{
    private readonly IConfigurationService _configurationService;
    private readonly ILogger<ColumnConfigurationService> _logger;
    
    public ColumnConfigurationService(IConfigurationService configurationService, ILogger<ColumnConfigurationService> logger)
    {
        ArgumentNullException.ThrowIfNull(configurationService);
        ArgumentNullException.ThrowIfNull(logger);
        _configurationService = configurationService;
        _logger = logger;
    }
    
    public async Task<ColumnConfiguration> LoadConfigurationAsync(string gridId, string userId)
    {
        // Implementation using existing ConfigurationService JSON persistence patterns
    }
}
```

**Service Registration Required**: Update `Extensions/ServiceCollectionExtensions.cs`:

```csharp
services.TryAddScoped<IColumnConfigurationService, ColumnConfigurationService>();
```

### 2. Column Management Event Integration (BLOCKING)

**Problem**: In `CustomDataGrid.axaml.cs` line ~825, events are commented out but not subscribed.

**Current Code Gap**:

```csharp
// Line 825 - Events are initialized but NOT subscribed
if (_columnManagementPanel != null)
{
    _columnManagementPanel.ColumnVisibilityChanged += OnColumnVisibilityChanged; // NOT IMPLEMENTED
    _columnManagementPanel.CloseRequested += (s, e) => HideColumnManagementPanel(); // MISSING
}
```

**Required Fix**: Complete event subscription and handler implementation.

### 3. Column Visibility Application Logic (BLOCKING)  

**Problem**: No logic exists to actually hide/show grid columns based on panel toggles.

**Current State**: `OnColumnVisibilityChanged` method does not exist in CustomDataGrid.axaml.cs.

**Required Implementation**:

- Method to map column IDs to actual grid column definitions
- Logic to toggle `IsVisible` or `Width` properties on grid columns
- Header visibility synchronization

## üèóÔ∏è MTM Architecture Requirements (MUST FOLLOW)

### MVVM Community Toolkit Patterns (MANDATORY)

```csharp
// ‚úÖ REQUIRED: Use [ObservableObject] for ColumnConfigurationService
[ObservableObject]
public partial class ColumnConfigurationService : IColumnConfigurationService
{
    [ObservableProperty]
    private ColumnConfiguration currentConfiguration = new();
    
    [RelayCommand]
    private async Task SaveConfigurationAsync(ColumnConfiguration config)
    {
        // Implementation with Services.ErrorHandling.HandleErrorAsync usage
    }
}
```

### Service Integration Pattern (MANDATORY)

```csharp
// ‚úÖ REQUIRED: Constructor dependency injection with validation
public ColumnConfigurationService(IConfigurationService configService, ILogger<ColumnConfigurationService> logger)
{
    ArgumentNullException.ThrowIfNull(configService);
    ArgumentNullException.ThrowIfNull(logger);
    _configurationService = configService;
    _logger = logger;
}
```

### Manufacturing Business Rules (MANDATORY)

```csharp
// ‚úÖ REQUIRED: Manufacturing column visibility rules
private static readonly string[] RequiredColumns = { "Operation", "PartId" };

private bool CanColumnBeHidden(string columnId)
{
    return !RequiredColumns.Contains(columnId);
}
```

### Configuration Persistence Pattern (MANDATORY)

```csharp
// ‚úÖ REQUIRED: Use existing ConfigurationService JSON pattern
public async Task SaveConfigurationAsync(string gridId, string userId, ColumnConfiguration config)
{
    try
    {
        var configKey = $"CustomDataGrid_{gridId}_{userId}";
        var jsonData = JsonSerializer.Serialize(config);
        await _configurationService.SaveSettingAsync(configKey, jsonData);
    }
    catch (Exception ex)
    {
        await Services.ErrorHandling.HandleErrorAsync(ex, "Failed to save column configuration");
        throw;
    }
}
```

## üîÑ Current Implementation Status

### ‚úÖ FULLY COMPLETE FILES

- `Controls/CustomDataGrid/SortConfiguration.cs` - Complete sorting logic
- `Controls/CustomDataGrid/SortManager.cs` - Multi-column sorting with performance
- `Controls/CustomDataGrid/ColumnManagementPanel.axaml` - Complete UI with MTM theming
- `Controls/CustomDataGrid/ColumnManagementPanel.axaml.cs` - Complete event handling and UI logic

### üîÑ NEEDS INTEGRATION COMPLETION

- `Controls/CustomDataGrid/CustomDataGrid.axaml.cs` - Event subscription and visibility application missing
- `Extensions/ServiceCollectionExtensions.cs` - Service registration required

### ‚ùå MISSING FILES

- `Services/ColumnConfigurationService.cs` - CRITICAL missing service

### üö® SPECIFIC CODE LOCATIONS NEEDING ATTENTION

**File**: `Controls/CustomDataGrid/CustomDataGrid.axaml.cs`
**Lines**: ~825-830 (InitializeColumnManagement method)
**Issue**: Event subscription commented out, handlers not implemented
**Fix**: Subscribe to all ColumnManagementPanel events with proper error handling

**File**: `Controls/CustomDataGrid/CustomDataGrid.axaml.cs`
**Missing**: `OnColumnVisibilityChanged` method implementation
**Required**: Method to process visibility changes and apply to grid

## üìã Implementation Priority Order

### Phase 1: Service Layer (CRITICAL - 2 hours)

1. Create `Services/ColumnConfigurationService.cs` with full interface implementation
2. Register service in `Extensions/ServiceCollectionExtensions.cs`
3. Add JSON serialization/deserialization for ColumnConfiguration

### Phase 2: Event Integration (CRITICAL - 1.5 hours)  

1. Complete event subscription in `InitializeColumnManagement()` method
2. Implement `OnColumnVisibilityChanged` event handler
3. Add `OnShowAllColumns`, `OnHideAllColumns`, `OnResetColumnLayout` handlers

### Phase 3: Column Visibility Application (CRITICAL - 2 hours)

1. Research Avalonia Grid column visibility patterns
2. Implement `ApplyColumnVisibility` method for actual grid updates  
3. Synchronize header visibility with grid column visibility
4. Add manufacturing business rule validation

### Phase 4: Configuration Persistence (HIGH - 1 hour)

1. Load configuration on grid initialization  
2. Save configuration on any visibility change
3. Implement reset to defaults functionality

### Phase 5: Testing & Polish (MEDIUM - 1 hour)

1. Integration testing with manufacturing test data
2. Address compiler warnings from gap report
3. Update implementation status documentation

## üö® Critical Compliance Checks

- [ ] ColumnConfigurationService uses [ObservableObject] and proper MTM patterns
- [ ] Service registration follows TryAdd pattern in ServiceCollectionExtensions
- [ ] All async operations use Services.ErrorHandling.HandleErrorAsync for consistency
- [ ] Operation and PartId columns cannot be hidden (manufacturing business rule)
- [ ] Configuration persistence uses existing ConfigurationService JSON patterns
- [ ] Event handlers include proper logging with ILogger<CustomDataGrid>
- [ ] Column visibility changes maintain grid performance (no layout thrashing)

## üí° Code Examples for Current Context

### Event Handler Implementation Template

```csharp
// Add to CustomDataGrid.axaml.cs
private async void OnColumnVisibilityChanged(object sender, ColumnVisibilityChangedEventArgs e)
{
    try
    {
        _logger.LogDebug("Applying column visibility change: {ColumnId} = {IsVisible}", e.ColumnId, e.IsVisible);
        
        // Apply visibility to grid column
        await ApplyColumnVisibility(e.ColumnId, e.IsVisible);
        
        // Save configuration if service is available
        if (_columnConfigurationService != null)
        {
            var currentConfig = await BuildCurrentConfiguration();
            await _columnConfigurationService.SaveConfigurationAsync("CustomDataGrid", GetCurrentUserId(), currentConfig);
        }
    }
    catch (Exception ex)
    {
        await Services.ErrorHandling.HandleErrorAsync(ex, $"Failed to apply column visibility for {e.ColumnId}");
    }
}
```

### Column Visibility Application Pattern

```csharp
// Add to CustomDataGrid.axaml.cs  
private async Task ApplyColumnVisibility(string columnId, bool isVisible)
{
    // Find header and data column elements
    var headerElement = this.Find<Border>($"{columnId}Header");
    var dataColumnDefinition = GetGridColumnDefinition(columnId);
    
    if (headerElement != null)
    {
        headerElement.IsVisible = isVisible;
    }
    
    if (dataColumnDefinition != null)
    {
        // For Avalonia, use Width instead of IsVisible for ColumnDefinition
        dataColumnDefinition.Width = isVisible ? new GridLength(1, GridUnitType.Star) : new GridLength(0);
    }
    
    // Update all data rows to reflect column visibility
    await UpdateDataRowColumnVisibility(columnId, isVisible);
}
```

## üîç Testing & Validation Checklist

### End-to-End Testing Requirements

- [ ] Gear icon opens column management panel with smooth animation
- [ ] Column checkboxes reflect actual grid column visibility state  
- [ ] Toggling checkbox immediately applies visibility change to grid
- [ ] Operation and PartId checkboxes are disabled (cannot be hidden)
- [ ] "Show All" button makes all columns visible
- [ ] "Hide All" button hides non-essential columns only
- [ ] "Reset" button restores manufacturing-optimized defaults
- [ ] Configuration persists across application restarts
- [ ] Multi-user configuration isolation (different users, different configs)

### Performance Validation

- [ ] Column visibility changes complete in <100ms
- [ ] Panel animations maintain 60fps smoothness
- [ ] Configuration loading/saving completes in <50ms
- [ ] No memory leaks during extended usage
- [ ] Virtual scrolling performance unaffected by column management

### Manufacturing Business Rules Validation

- [ ] Operation column always visible (business critical)
- [ ] PartId column always visible (business critical)
- [ ] Column order maintains manufacturing workflow priority
- [ ] Minimum 2 columns always visible (prevent empty grid)
- [ ] Configuration validation prevents invalid states

## üöÄ Execution Instruction

**Focus on completing the 3 critical gaps in priority order to achieve full Phase 3a functionality. All UI infrastructure is complete - the work is primarily service layer implementation and event integration.**

**Start with ColumnConfigurationService creation, then wire the events, then implement column visibility application logic. Each step has clear requirements and patterns to follow.**

# github-pull-request_copilot-coding-agent

---

@copilot I need to complete the MTM CustomDataGrid Phase 3a Column Management implementation. The UI is complete but lacks backend integration. Please focus on the 3 critical gaps identified above:

1. **Create ColumnConfigurationService** - Missing service for configuration persistence using MTM patterns and existing ConfigurationService integration
2. **Wire Column Management Events** - Complete event subscription in CustomDataGrid.InitializeColumnManagement() method  
3. **Implement Column Visibility Application** - Add logic to actually hide/show grid columns when checkboxes are toggled

Use the MTM architecture patterns specified above, follow the manufacturing business rules (Operation/PartId cannot be hidden), and ensure all async operations use Services.ErrorHandling.HandleErrorAsync for consistency. The implementation should integrate with existing ConfigurationService for persistence and maintain the high-performance virtual scrolling characteristics of the grid.
