<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MainViewViewModel - Technical Documentation</title>
    <link rel="stylesheet" href="../../../styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üèóÔ∏è MainViewViewModel - Technical Documentation</h1>
            <div class="nav-links">
                <a href="../../../PlainEnglish/FileDefinitions/ViewModels/MainViewViewModel.html" class="nav-link plain-english">üìñ Plain English Version</a>
                <a href="../../../index.html" class="nav-link">üè† Documentation Home</a>
            </div>
        </header>

        <main class="content">
            <!-- Technical Overview -->
            <section class="doc-section">
                <h2>üîß Technical Implementation</h2>
                <div class="code-block">
                    <h3>Namespace & Dependencies</h3>
                    <pre><code>namespace MTM_WIP_Application_Avalonia.ViewModels
using ReactiveUI;
using Microsoft.Extensions.Logging;
using MTM_WIP_Application_Avalonia.Services.Interfaces.INavigationService;
using System.Reactive;
using System.Collections.ObjectModel;</code></pre>
                </div>

                <div class="technical-details">
                    <h3>Class Definition</h3>
                    <ul>
                        <li><strong>Base Class:</strong> BaseViewModel (ReactiveUI foundation)</li>
                        <li><strong>Pattern:</strong> Main Content Coordinator with Tab Management</li>
                        <li><strong>DI Dependencies:</strong> INavigationService, ILogger&lt;MainViewViewModel&gt;</li>
                        <li><strong>Purpose:</strong> Central hub for main application content areas</li>
                        <li><strong>Scope:</strong> Application lifetime singleton coordination</li>
                    </ul>
                </div>
            </section>

            <!-- Observable Properties -->
            <section class="doc-section">
                <h2>üîÑ Observable Properties</h2>
                <div class="property-grid">
                    <div class="property-item">
                        <h4>SelectedTabIndex (int)</h4>
                        <p><strong>Reactive Property:</strong> Currently active tab in main interface</p>
                        <p><strong>Range:</strong> 0-4 (Inventory, Add, Remove, Transfer, History)</p>
                        <p><strong>UI Binding:</strong> TabControl SelectedIndex</p>
                        <p><strong>Navigation:</strong> Drives content switching logic</p>
                    </div>

                    <div class="property-item">
                        <h4>CurrentTabName (string)</h4>
                        <p><strong>Derived Property:</strong> Human-readable name of active tab</p>
                        <p><strong>Source:</strong> Computed from SelectedTabIndex</p>
                        <p><strong>UI Display:</strong> Breadcrumb, status bar, window title</p>
                    </div>

                    <div class="property-item">
                        <h4>IsLoading (bool)</h4>
                        <p><strong>Reactive Property:</strong> Indicates tab content loading state</p>
                        <p><strong>UI Impact:</strong> Shows/hides progress indicators</p>
                        <p><strong>Coordination:</strong> Manages loading state across child ViewModels</p>
                    </div>

                    <div class="property-item">
                        <h4>TabViewModels (ObservableCollection)</h4>
                        <p><strong>Collection Property:</strong> Child ViewModels for each tab</p>
                        <p><strong>Contents:</strong> InventoryTabViewModel, AddItemViewModel, etc.</p>
                        <p><strong>Lifecycle:</strong> Managed for optimal memory usage</p>
                    </div>

                    <div class="property-item">
                        <h4>QuickButtonsViewModel</h4>
                        <p><strong>Child Property:</strong> Quick action buttons panel</p>
                        <p><strong>Always Active:</strong> Persistent across all tabs</p>
                        <p><strong>Communication:</strong> Event-driven coordination with tabs</p>
                    </div>

                    <div class="property-item">
                        <h4>NotificationMessage (string)</h4>
                        <p><strong>Reactive Property:</strong> User notification display</p>
                        <p><strong>Auto-clear:</strong> Clears after timeout period</p>
                        <p><strong>UI Binding:</strong> Notification banner or toast</p>
                    </div>

                    <div class="property-item">
                        <h4>HasUnsavedChanges (bool)</h4>
                        <p><strong>Computed Property:</strong> Any child ViewModel has unsaved changes</p>
                        <p><strong>Navigation Guard:</strong> Prevents accidental data loss</p>
                        <p><strong>UI Indicator:</strong> Visual cue for unsaved work</p>
                    </div>
                </div>
            </section>

            <!-- Reactive Commands -->
            <section class="doc-section">
                <h2>‚ö° Reactive Commands</h2>
                <div class="command-grid">
                    <div class="command-item">
                        <h4>NavigateToTabCommand</h4>
                        <p><strong>Type:</strong> ReactiveCommand&lt;int, Unit&gt;</p>
                        <p><strong>Parameter:</strong> Target tab index</p>
                        <p><strong>Implementation:</strong></p>
                        <div class="code-block">
                            <pre><code>NavigateToTabCommand = ReactiveCommand.CreateFromTask&lt;int&gt;(async tabIndex =>
{
    if (HasUnsavedChanges)
    {
        var result = await ShowConfirmationDialog(
            "Unsaved Changes", 
            "You have unsaved changes. Do you want to continue?");
        if (!result) return;
    }
    
    await SaveCurrentTabState();
    SelectedTabIndex = tabIndex;
    await LoadTabContent(tabIndex);
}, canNavigate);</code></pre>
                        </div>
                    </div>

                    <div class="command-item">
                        <h4>RefreshCurrentTabCommand</h4>
                        <p><strong>Type:</strong> ReactiveCommand&lt;Unit, Unit&gt;</p>
                        <p><strong>Purpose:</strong> Refreshes active tab content from database</p>
                        <p><strong>Delegation:</strong> Calls refresh on current child ViewModel</p>
                    </div>

                    <div class="command-item">
                        <h4>SaveAllChangesCommand</h4>
                        <p><strong>Type:</strong> ReactiveCommand&lt;Unit, Unit&gt;</p>
                        <p><strong>Purpose:</strong> Saves all pending changes across all tabs</p>
                        <p><strong>Coordination:</strong> Iterates through all child ViewModels</p>
                    </div>

                    <div class="command-item">
                        <h4>ShowNotificationCommand</h4>
                        <p><strong>Type:</strong> ReactiveCommand&lt;string, Unit&gt;</p>
                        <p><strong>Purpose:</strong> Displays user notifications</p>
                        <p><strong>Auto-clear:</strong> Notification disappears after 5 seconds</p>
                    </div>
                </div>
            </section>

            <!-- Tab Management System -->
            <section class="doc-section">
                <h2>üìë Advanced Tab Management</h2>
                <div class="code-block">
                    <h3>Tab Lifecycle Management</h3>
                    <pre><code>// Tab Index Enumeration
public enum TabIndex
{
    Inventory = 0,
    AddItem = 1,
    RemoveItem = 2,
    TransferItem = 3,
    TransactionHistory = 4
}

// Tab Content Loading
private async Task LoadTabContent(int tabIndex)
{
    IsLoading = true;
    
    try
    {
        var viewModel = GetOrCreateTabViewModel(tabIndex);
        
        if (viewModel is ILoadableViewModel loadable)
        {
            await loadable.LoadDataAsync();
        }
        
        // Update window title and breadcrumb
        CurrentTabName = GetTabName(tabIndex);
        
        // Notify navigation service
        _navigationService.NotifyNavigated(CurrentTabName);
    }
    catch (Exception ex)
    {
        Logger.LogError(ex, "Failed to load tab content for index {TabIndex}", tabIndex);
        await ShowNotificationCommand.Execute("Failed to load tab content");
    }
    finally
    {
        IsLoading = false;
    }
}

// Tab State Persistence
private async Task SaveCurrentTabState()
{
    var currentViewModel = GetCurrentTabViewModel();
    
    if (currentViewModel is ISaveableViewModel saveable)
    {
        await saveable.SaveStateAsync();
    }
}</code></pre>
                </div>

                <div class="tab-management">
                    <h3>Tab Coordination Features</h3>
                    <ul>
                        <li><strong>Lazy Loading:</strong> Tab ViewModels created only when accessed</li>
                        <li><strong>State Persistence:</strong> Maintains form state when switching tabs</li>
                        <li><strong>Memory Management:</strong> Disposes unused tab ViewModels</li>
                        <li><strong>Change Detection:</strong> Tracks unsaved changes across all tabs</li>
                        <li><strong>Cross-Tab Communication:</strong> Coordinates updates between related tabs</li>
                    </ul>
                </div>
            </section>

            <!-- Event-Driven Communication -->
            <section class="doc-section">
                <h2>üì° Event-Driven Communication System</h2>
                <div class="code-block">
                    <h3>Quick Action Integration</h3>
                    <pre><code>// Quick Button Event Handling
QuickButtonsViewModel.QuickActionExecuted += OnQuickActionExecuted;

private async void OnQuickActionExecuted(object sender, QuickActionExecutedEventArgs e)
{
    // Determine target tab based on action type
    var targetTab = e.ActionType switch
    {
        QuickActionType.AddStock => TabIndex.AddItem,
        QuickActionType.RemoveStock => TabIndex.RemoveItem,
        QuickActionType.TransferStock => TabIndex.TransferItem,
        _ => SelectedTabIndex
    };
    
    // Navigate to appropriate tab
    await NavigateToTabCommand.Execute((int)targetTab);
    
    // Pre-populate form fields
    var targetViewModel = GetTabViewModel(targetTab);
    if (targetViewModel is IFormViewModel form)
    {
        form.PopulateFromQuickAction(e);
    }
}

// Cross-Tab Data Synchronization
private void SetupCrossTabCommunication()
{
    // Inventory changes update history tab
    inventoryTabViewModel.InventoryChanged += (s, e) =>
    {
        if (GetTabViewModel(TabIndex.TransactionHistory) is TransactionHistoryViewModel historyVM)
        {
            historyVM.RefreshCommand.Execute(null);
        }
    };
    
    // Transaction completion updates inventory display
    addItemViewModel.TransactionCompleted += UpdateInventoryDisplay;
    removeItemViewModel.TransactionCompleted += UpdateInventoryDisplay;
    transferItemViewModel.TransactionCompleted += UpdateInventoryDisplay;
}</code></pre>
                </div>

                <div class="communication-patterns">
                    <h3>Communication Patterns</h3>
                    <ul>
                        <li><strong>Event Aggregation:</strong> Centralized event handling for cross-tab updates</li>
                        <li><strong>Weak References:</strong> Event subscriptions use weak references to prevent leaks</li>
                        <li><strong>Command Delegation:</strong> Forwards commands to appropriate child ViewModels</li>
                        <li><strong>State Synchronization:</strong> Keeps related tabs in sync automatically</li>
                    </ul>
                </div>
            </section>

            <!-- Navigation Integration -->
            <section class="doc-section">
                <h2>üß≠ Navigation Service Integration</h2>
                <div class="code-block">
                    <h3>Navigation Service Coordination</h3>
                    <pre><code>// Navigation Request Handling
public void NavigateToView(string viewName, object parameter = null)
{
    var tabIndex = viewName.ToLowerInvariant() switch
    {
        "inventory" => TabIndex.Inventory,
        "additem" or "add" => TabIndex.AddItem,
        "removeitem" or "remove" => TabIndex.RemoveItem,
        "transferitem" or "transfer" => TabIndex.TransferItem,
        "history" or "transactions" => TabIndex.TransactionHistory,
        _ => SelectedTabIndex
    };
    
    NavigateToTabCommand.Execute((int)tabIndex);
    
    // Pass navigation parameters to target ViewModel
    if (parameter != null)
    {
        var targetViewModel = GetTabViewModel(tabIndex);
        if (targetViewModel is IParameterizedViewModel parameterized)
        {
            parameterized.ReceiveParameter(parameter);
        }
    }
}

// Breadcrumb Navigation
private readonly ObservableAsPropertyHelper&lt;string&gt; _breadcrumb;
public string Breadcrumb => _breadcrumb.Value;

public MainViewViewModel(...)
{
    _breadcrumb = this.WhenAnyValue(vm => vm.SelectedTabIndex)
        .Select(index => GenerateBreadcrumb(index))
        .ToProperty(this, vm => vm.Breadcrumb, initialValue: "MTM WIP > Dashboard");
}

private string GenerateBreadcrumb(int tabIndex)
{
    var tabName = GetTabName(tabIndex);
    return $"MTM WIP > {tabName}";
}</code></pre>
                </div>
            </section>

            <!-- State Management -->
            <section class="doc-section">
                <h2>üíæ Advanced State Management</h2>
                <div class="state-management">
                    <h3>Application State Coordination</h3>
                    <div class="code-block">
                        <pre><code>// Application State Integration
private void SetupStateManagement()
{
    // Save tab state when switching
    this.WhenAnyValue(vm => vm.SelectedTabIndex)
        .Skip(1) // Skip initial value
        .Subscribe(async newIndex =>
        {
            await SaveCurrentTabState();
            await LoadTabContent(newIndex);
        });
    
    // Auto-save periodically
    Observable.Interval(TimeSpan.FromMinutes(5))
        .ObserveOn(RxApp.MainThreadScheduler)
        .Subscribe(async _ => await AutoSaveAllTabs());
}

// Session Recovery
public async Task RestoreSessionAsync()
{
    try
    {
        var savedState = await _applicationStateService.GetSavedStateAsync("MainView");
        if (savedState != null)
        {
            SelectedTabIndex = savedState.LastActiveTab;
            await RestoreTabStates(savedState.TabStates);
        }
    }
    catch (Exception ex)
    {
        Logger.LogWarning(ex, "Failed to restore session state");
    }
}

public async Task SaveSessionAsync()
{
    var state = new MainViewState
    {
        LastActiveTab = SelectedTabIndex,
        TabStates = await CollectTabStates(),
        Timestamp = DateTime.UtcNow
    };
    
    await _applicationStateService.SaveStateAsync("MainView", state);
}</code></pre>
                    </div>

                    <h3>State Features</h3>
                    <ul>
                        <li><strong>Session Persistence:</strong> Restores last active tab on startup</li>
                        <li><strong>Auto-Save:</strong> Periodic saving of all tab states</li>
                        <li><strong>Unsaved Changes Tracking:</strong> Prevents data loss during navigation</li>
                        <li><strong>State Recovery:</strong> Recovers from unexpected application closure</li>
                    </ul>
                </div>
            </section>

            <!-- Error Handling -->
            <section class="doc-section">
                <h2>üö® Centralized Error Handling</h2>
                <div class="error-handling">
                    <div class="code-block">
                        <h3>Global Error Management</h3>
                        <pre><code>// Global Exception Handling
private void SetupErrorHandling()
{
    // Aggregate all child ViewModel errors
    var allErrors = TabViewModels
        .SelectMany(vm => vm.ThrownExceptions)
        .Merge(NavigateToTabCommand.ThrownExceptions)
        .Merge(RefreshCurrentTabCommand.ThrownExceptions);
    
    allErrors.Subscribe(async ex =>
    {
        Logger.LogError(ex, "Unhandled error in MainView");
        
        var errorMessage = ex switch
        {
            DatabaseConnectionException => "Database connection lost. Please check your connection.",
            ValidationException valEx => $"Validation error: {valEx.Message}",
            UnauthorizedException => "You don't have permission to perform this action.",
            _ => "An unexpected error occurred. Please try again."
        };
        
        await ShowNotificationCommand.Execute(errorMessage);
        
        // Attempt recovery
        await AttemptErrorRecovery(ex);
    });
}

// Error Recovery Strategies
private async Task AttemptErrorRecovery(Exception ex)
{
    switch (ex)
    {
        case DatabaseConnectionException:
            // Attempt to reconnect and refresh current tab
            await RefreshCurrentTabCommand.Execute();
            break;
            
        case ValidationException:
            // Clear form and reset to known good state
            var currentVM = GetCurrentTabViewModel();
            if (currentVM is IResettableViewModel resettable)
            {
                resettable.ResetToDefaults();
            }
            break;
    }
}</code></pre>
                    </div>

                    <h3>Error Recovery Features</h3>
                    <ul>
                        <li><strong>Automatic Recovery:</strong> Attempts to recover from common errors</li>
                        <li><strong>User Notification:</strong> Friendly error messages for all error types</li>
                        <li><strong>State Preservation:</strong> Maintains user work during error recovery</li>
                        <li><strong>Logging Integration:</strong> Comprehensive error logging for debugging</li>
                    </ul>
                </div>
            </section>

            <!-- Performance Optimization -->
            <section class="doc-section">
                <h2>‚ö° Performance Optimization</h2>
                <div class="performance-notes">
                    <h3>Memory Management</h3>
                    <ul>
                        <li><strong>Lazy Loading:</strong> Tab ViewModels created only when needed</li>
                        <li><strong>ViewModel Disposal:</strong> Inactive tabs disposed to free memory</li>
                        <li><strong>Event Cleanup:</strong> All event subscriptions properly disposed</li>
                        <li><strong>Weak References:</strong> Cross-tab event handling uses weak references</li>
                    </ul>

                    <h3>UI Responsiveness</h3>
                    <ul>
                        <li><strong>Background Loading:</strong> Tab content loaded on background thread</li>
                        <li><strong>Progressive Enhancement:</strong> UI responsive during data loading</li>
                        <li><strong>Debounced Updates:</strong> Rapid tab switching optimized</li>
                        <li><strong>Virtualization:</strong> Large data sets use UI virtualization</li>
                    </ul>
                </div>
            </section>

            <!-- Integration Points -->
            <section class="doc-section">
                <h2>üîó System Integration Points</h2>
                <div class="integration-grid">
                    <div class="integration-item">
                        <h4>MainWindowViewModel</h4>
                        <p>Parent window coordinator with menu and status integration</p>
                        <p>Provides window-level services and application lifecycle</p>
                    </div>

                    <div class="integration-item">
                        <h4>NavigationService</h4>
                        <p>Centralized navigation coordination across application</p>
                        <p>Handles deep linking and external navigation requests</p>
                    </div>

                    <div class="integration-item">
                        <h4>ApplicationStateService</h4>
                        <p>Session persistence and application state management</p>
                        <p>User preference and UI state persistence</p>
                    </div>

                    <div class="integration-item">
                        <h4>All Tab ViewModels</h4>
                        <p>Manages lifecycle and coordination of all child ViewModels</p>
                        <p>Provides cross-tab communication and state synchronization</p>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>üèóÔ∏è Technical Documentation | üè≠ MTM WIP Application | ‚ö° Powered by Avalonia UI + ReactiveUI</p>
            <div class="footer-links">
                <a href="../../../PlainEnglish/FileDefinitions/ViewModels/MainViewViewModel.html">üìñ Plain English Version</a>
                <a href="../../../Technical/index.html">üìö Technical Documentation Index</a>
                <a href="../../../index.html">üè† Documentation Home</a>
            </div>
        </footer>
    </div>
</body>
</html>