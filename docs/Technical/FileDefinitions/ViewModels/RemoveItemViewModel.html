<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RemoveItemViewModel - Technical Documentation</title>
    <link rel="stylesheet" href="../../../styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üìã RemoveItemViewModel - Technical Documentation</h1>
            <div class="nav-links">
                <a href="../../../PlainEnglish/FileDefinitions/ViewModels/RemoveItemViewModel.html" class="nav-link plain-english">üìñ Plain English Version</a>
                <a href="../../../index.html" class="nav-link">üè† Documentation Home</a>
            </div>
        </header>

        <main class="content">
            <!-- Technical Overview -->
            <section class="doc-section">
                <h2>üîß Technical Implementation</h2>
                <div class="code-block">
                    <h3>Namespace & Dependencies</h3>
                    <pre><code>namespace MTM_WIP_Application_Avalonia.ViewModels
using ReactiveUI;
using Microsoft.Extensions.Logging;
using MTM.Services.IInventoryService;
using System.Reactive;</code></pre>
                </div>

                <div class="technical-details">
                    <h3>Class Definition</h3>
                    <ul>
                        <li><strong>Base Class:</strong> BaseViewModel (ReactiveUI foundation)</li>
                        <li><strong>Pattern:</strong> MVVM with Reactive Extensions</li>
                        <li><strong>DI Dependencies:</strong> IInventoryService, ILogger&lt;RemoveItemViewModel&gt;</li>
                        <li><strong>Purpose:</strong> Handles inventory removal operations with validation</li>
                    </ul>
                </div>
            </section>

            <!-- Observable Properties -->
            <section class="doc-section">
                <h2>üîÑ Observable Properties</h2>
                <div class="property-grid">
                    <div class="property-item">
                        <h4>PartId (string)</h4>
                        <p><strong>Reactive Property:</strong> Two-way binding for part identification</p>
                        <p><strong>Validation:</strong> Required, non-empty string</p>
                        <p><strong>UI Binding:</strong> TextBox for part scanning/entry</p>
                    </div>

                    <div class="property-item">
                        <h4>Operation (string)</h4>
                        <p><strong>Reactive Property:</strong> Manufacturing operation number</p>
                        <p><strong>Range:</strong> "90", "100", "110", etc. (workflow steps)</p>
                        <p><strong>UI Binding:</strong> ComboBox or TextBox selection</p>
                    </div>

                    <div class="property-item">
                        <h4>Quantity (int)</h4>
                        <p><strong>Reactive Property:</strong> Amount to remove from inventory</p>
                        <p><strong>Validation:</strong> Must be positive integer, ‚â§ available stock</p>
                        <p><strong>UI Binding:</strong> NumericUpDown with validation indicators</p>
                    </div>

                    <div class="property-item">
                        <h4>Location (string)</h4>
                        <p><strong>Reactive Property:</strong> Source location for removal</p>
                        <p><strong>Validation:</strong> Must exist in location master</p>
                        <p><strong>UI Binding:</strong> ComboBox with location lookup</p>
                    </div>

                    <div class="property-item">
                        <h4>IsLoading (bool)</h4>
                        <p><strong>Reactive Property:</strong> Indicates async operation in progress</p>
                        <p><strong>UI Impact:</strong> Disables controls, shows progress indicators</p>
                    </div>

                    <div class="property-item">
                        <h4>AvailableStock (int)</h4>
                        <p><strong>Computed Property:</strong> Current stock for PartId + Operation + Location</p>
                        <p><strong>Updates:</strong> When PartId, Operation, or Location changes</p>
                        <p><strong>UI Display:</strong> Read-only indicator for validation</p>
                    </div>
                </div>
            </section>

            <!-- Reactive Commands -->
            <section class="doc-section">
                <h2>‚ö° Reactive Commands</h2>
                <div class="command-grid">
                    <div class="command-item">
                        <h4>RemoveStockCommand</h4>
                        <p><strong>Type:</strong> ReactiveCommand&lt;Unit, Unit&gt;</p>
                        <p><strong>CanExecute:</strong> All fields valid + Quantity ‚â§ AvailableStock</p>
                        <p><strong>Implementation:</strong></p>
                        <div class="code-block">
                            <pre><code>RemoveStockCommand = ReactiveCommand.CreateFromTask(async () =>
{
    try 
    {
        var result = await _inventoryService.RemoveStockAsync(
            PartId, Operation, Quantity, Location, CurrentUserId);
            
        if (result.IsSuccess)
        {
            // Update UI, clear form, show success
            await RefreshAvailableStock();
            ClearForm();
        }
        else
        {
            // Show error message
        }
    }
    catch (Exception ex)
    {
        Logger.LogError(ex, "Failed to remove stock");
    }
}, canExecuteRemove);</code></pre>
                        </div>
                    </div>

                    <div class="command-item">
                        <h4>ClearFormCommand</h4>
                        <p><strong>Type:</strong> ReactiveCommand&lt;Unit, Unit&gt;</p>
                        <p><strong>Purpose:</strong> Resets all input fields to defaults</p>
                        <p><strong>Always Enabled:</strong> No preconditions required</p>
                    </div>

                    <div class="command-item">
                        <h4>RefreshStockCommand</h4>
                        <p><strong>Type:</strong> ReactiveCommand&lt;Unit, Unit&gt;</p>
                        <p><strong>Purpose:</strong> Updates AvailableStock from database</p>
                        <p><strong>Trigger:</strong> Manual refresh or when location/part changes</p>
                    </div>
                </div>
            </section>

            <!-- Validation Logic -->
            <section class="doc-section">
                <h2>‚úÖ Validation Implementation</h2>
                <div class="code-block">
                    <h3>Reactive Validation Chain</h3>
                    <pre><code>// Can Execute Logic
var canExecuteRemove = this.WhenAnyValue(
    vm => vm.PartId,
    vm => vm.Operation, 
    vm => vm.Quantity,
    vm => vm.Location,
    vm => vm.AvailableStock,
    vm => vm.IsLoading,
    (partId, operation, quantity, location, available, loading) =>
        !string.IsNullOrWhiteSpace(partId) &&
        !string.IsNullOrWhiteSpace(operation) &&
        !string.IsNullOrWhiteSpace(location) &&
        quantity > 0 &&
        quantity <= available &&
        !loading);

// Stock Availability Check
this.WhenAnyValue(vm => vm.PartId, vm => vm.Operation, vm => vm.Location)
    .Where(x => !string.IsNullOrWhiteSpace(x.Item1) && 
                !string.IsNullOrWhiteSpace(x.Item2) && 
                !string.IsNullOrWhiteSpace(x.Item3))
    .Throttle(TimeSpan.FromMilliseconds(500))
    .ObserveOn(RxApp.MainThreadScheduler)
    .Subscribe(async _ => await RefreshAvailableStock());</code></pre>
                </div>

                <div class="validation-rules">
                    <h3>Business Validation Rules</h3>
                    <ul>
                        <li><strong>Stock Sufficiency:</strong> Quantity ‚â§ AvailableStock</li>
                        <li><strong>Location Existence:</strong> Location must be valid in system</li>
                        <li><strong>Operation Validity:</strong> Operation must be valid workflow step</li>
                        <li><strong>Part Existence:</strong> PartId must exist in parts master</li>
                        <li><strong>Positive Quantity:</strong> Must be greater than 0</li>
                    </ul>
                </div>
            </section>

            <!-- Database Operations -->
            <section class="doc-section">
                <h2>üóÑÔ∏è Database Integration</h2>
                <div class="database-operations">
                    <h3>Service Layer Calls</h3>
                    <div class="code-block">
                        <pre><code>// Remove Stock Operation (via IInventoryService)
await _inventoryService.RemoveStockAsync(
    partId: PartId,
    operation: Operation,
    quantity: Quantity, 
    location: Location,
    userId: CurrentUserId);

// Stock Lookup Operation
var stockLevel = await _inventoryService.GetStockLevelAsync(
    PartId, Operation, Location);

AvailableStock = stockLevel?.Quantity ?? 0;</code></pre>
                    </div>

                    <h3>Expected Stored Procedures</h3>
                    <ul>
                        <li><strong>inv_inventory_Remove_Stock:</strong> Main removal operation</li>
                        <li><strong>inv_inventory_Get_StockLevel:</strong> Stock availability lookup</li>
                        <li><strong>sys_audit_Log_Transaction:</strong> Audit trail logging</li>
                    </ul>
                </div>
            </section>

            <!-- Error Handling -->
            <section class="doc-section">
                <h2>üö® Error Handling Strategy</h2>
                <div class="error-handling">
                    <h3>Exception Categories</h3>
                    <ul>
                        <li><strong>Insufficient Stock:</strong> User-friendly message with available quantity</li>
                        <li><strong>Database Errors:</strong> Logged with fallback UI message</li>
                        <li><strong>Validation Errors:</strong> Real-time feedback via reactive validation</li>
                        <li><strong>Network/Connection:</strong> Retry options with offline indication</li>
                    </ul>

                    <div class="code-block">
                        <h3>Centralized Error Handling</h3>
                        <pre><code>RemoveStockCommand.ThrownExceptions
    .Subscribe(ex =>
    {
        Logger.LogError(ex, "Remove stock operation failed");
        
        var userMessage = ex switch
        {
            InsufficientStockException => 
                $"Only {AvailableStock} units available",
            ValidationException valEx => valEx.Message,
            _ => "Unable to remove stock. Please try again."
        };
        
        ShowErrorMessage(userMessage);
    });</code></pre>
                    </div>
                </div>
            </section>

            <!-- UI Integration -->
            <section class="doc-section">
                <h2>üé® UI Integration Patterns</h2>
                <div class="ui-integration">
                    <h3>AXAML Binding Examples</h3>
                    <div class="code-block">
                        <pre><code>&lt;!-- Part ID Input with Validation --&gt;
&lt;TextBox Text="{Binding PartId}" 
         Watermark="Scan or enter Part ID"
         Classes.error="{Binding !IsPartIdValid}"/&gt;

&lt;!-- Quantity with Stock Validation --&gt;
&lt;NumericUpDown Value="{Binding Quantity}"
               Maximum="{Binding AvailableStock}"
               Minimum="1"
               IsEnabled="{Binding !IsLoading}"/&gt;

&lt;!-- Available Stock Display --&gt;
&lt;TextBlock Text="{Binding AvailableStock, StringFormat='Available: {0} units'}"
           Foreground="{Binding AvailableStock, 
                               Converter={StaticResource StockLevelToBrushConverter}}"/&gt;

&lt;!-- Remove Button --&gt;
&lt;Button Content="Remove Stock"
        Command="{Binding RemoveStockCommand}"
        Classes="danger primary"
        IsVisible="{Binding !IsLoading}"/&gt;

&lt;!-- Progress Indicator --&gt;
&lt;ProgressBar IsIndeterminate="True"
             IsVisible="{Binding IsLoading}"/&gt;</code></pre>
                    </div>

                    <h3>Event-Driven Communication</h3>
                    <ul>
                        <li><strong>StockRemoved Event:</strong> Notifies parent components of inventory changes</li>
                        <li><strong>ValidationFailed Event:</strong> Triggers UI validation feedback</li>
                        <li><strong>OperationCompleted Event:</strong> Updates related UI components</li>
                    </ul>
                </div>
            </section>

            <!-- Performance Considerations -->
            <section class="doc-section">
                <h2>‚ö° Performance & Optimization</h2>
                <div class="performance-notes">
                    <h3>Reactive Optimizations</h3>
                    <ul>
                        <li><strong>Throttling:</strong> Stock lookups throttled to 500ms to prevent excessive API calls</li>
                        <li><strong>Debouncing:</strong> Input validation debounced for responsive UI</li>
                        <li><strong>Caching:</strong> Location and operation lists cached for session</li>
                        <li><strong>Background Updates:</strong> Stock levels updated on background thread</li>
                    </ul>

                    <h3>Memory Management</h3>
                    <ul>
                        <li><strong>Subscription Disposal:</strong> All reactive subscriptions properly disposed</li>
                        <li><strong>Weak References:</strong> Event handlers use weak references to prevent leaks</li>
                        <li><strong>Command Cleanup:</strong> Commands disposed in ViewModel cleanup</li>
                    </ul>
                </div>
            </section>

            <!-- Integration Points -->
            <section class="doc-section">
                <h2>üîó Integration Points</h2>
                <div class="integration-grid">
                    <div class="integration-item">
                        <h4>QuickButtonsViewModel</h4>
                        <p>Receives pre-filled data from Quick Action buttons</p>
                        <p>Updates quick action history after successful removal</p>
                    </div>

                    <div class="integration-item">
                        <h4>InventoryTabViewModel</h4>
                        <p>Parent container managing tab state and coordination</p>
                        <p>Handles navigation between Add/Remove/Transfer operations</p>
                    </div>

                    <div class="integration-item">
                        <h4>TransactionHistoryViewModel</h4>
                        <p>Automatically refreshes after stock removal operations</p>
                        <p>Displays audit trail of removal transactions</p>
                    </div>

                    <div class="integration-item">
                        <h4>NavigationService</h4>
                        <p>Provides navigation back to inventory overview</p>
                        <p>Handles deep linking to specific part removal</p>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>üîß Technical Documentation | üè≠ MTM WIP Application | ‚ö° Powered by Avalonia UI + ReactiveUI</p>
            <div class="footer-links">
                <a href="../../../PlainEnglish/FileDefinitions/ViewModels/RemoveItemViewModel.html">üìñ Plain English Version</a>
                <a href="../../../Technical/index.html">üìö Technical Documentation Index</a>
                <a href="../../../index.html">üè† Documentation Home</a>
            </div>
        </footer>
    </div>
</body>
</html>