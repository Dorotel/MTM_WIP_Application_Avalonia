<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service_ErrorHandler.cs - Technical Documentation</title>
    <link rel="stylesheet" href="../../../styles.css">
    <style>
        .method-signature { background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 5px; font-family: 'Courier New', monospace; margin: 10px 0; }
        .parameter-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .parameter-table th, .parameter-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .parameter-table th { background-color: #f2f2f2; }
        .nav-button { display: inline-block; padding: 8px 16px; margin: 5px; background: linear-gradient(45deg, #1a1a1a, #333); color: #FFD700; text-decoration: none; border-radius: 5px; font-weight: bold; }
        .nav-button:hover { background: linear-gradient(45deg, #333, #555); }
        .code-example { background: #1e1e1e; color: #dcdcdc; padding: 15px; border-radius: 5px; margin: 10px 0; overflow-x: auto; }
        .static-class { background: #4CAF50; color: white; padding: 5px; border-radius: 3px; }
        .thread-safe { background: #2196F3; color: white; padding: 5px; border-radius: 3px; }
        .enum-definition { background: #f5f5f5; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .critical-feature { background: #FF5722; color: white; padding: 8px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-section">
            <h1>Service_ErrorHandler.cs</h1>
            <h2>Technical Implementation Documentation</h2>
            <p class="subtitle">Comprehensive error handling, logging, and duplicate detection system</p>
            
            <div class="navigation-section">
                <a href="../../../PlainEnglish/FileDefinitions/Services/Service_ErrorHandler.html" class="nav-button">üéØ Plain English View (Alt+P)</a>
                <a href="../../index.html" class="nav-button">üìÇ Back to Technical Index</a>
            </div>
        </div>

        <div class="content-section">
            <div class="summary-box">
                <h3>üîß Technical Overview</h3>
                <p>Static service class providing centralized error handling with file server and MySQL logging, duplicate detection via session caching, automatic categorization, and comprehensive configuration management. Uses CallerMemberName attributes for automatic source location tracking.</p>
            </div>

            <div class="section">
                <h3>üì¶ Core Classes</h3>
                
                <div class="static-class">Static Service Class</div>
                <div class="method-signature">
                    public static class Service_ErrorHandler
                    {
                        private static readonly Dictionary&lt;string, HashSet&lt;string&gt;&gt; _sessionErrorCache = new();
                        private static readonly object _lockObject = new();
                    }
                </div>

                <div class="thread-safe">Thread-Safe Implementation</div>
                <p>Uses lock synchronization for thread-safe session cache management in multi-threaded environments.</p>
            </div>

            <div class="section">
                <h3>üö® Main Error Handling Method</h3>

                <h4>HandleException()</h4>
                <div class="method-signature">
                    public static void HandleException(
                        Exception exception,
                        ErrorSeverity severity,
                        string? source = null,
                        Dictionary&lt;string, object&gt;? additionalData = null,
                        [CallerMemberName] string callerMemberName = "",
                        [CallerFilePath] string callerFilePath = "",
                        [CallerLineNumber] int callerLineNumber = 0)
                </div>

                <table class="parameter-table">
                    <tr>
                        <th>Parameter</th>
                        <th>Type</th>
                        <th>Auto-Generated</th>
                        <th>Description</th>
                    </tr>
                    <tr>
                        <td>exception</td>
                        <td>Exception</td>
                        <td>‚ùå</td>
                        <td>The exception to handle and log</td>
                    </tr>
                    <tr>
                        <td>severity</td>
                        <td>ErrorSeverity</td>
                        <td>‚ùå</td>
                        <td>Low, Medium, High, or Critical severity level</td>
                    </tr>
                    <tr>
                        <td>source</td>
                        <td>string?</td>
                        <td>‚ùå</td>
                        <td>Optional control or component name where error occurred</td>
                    </tr>
                    <tr>
                        <td>additionalData</td>
                        <td>Dictionary&lt;string, object&gt;?</td>
                        <td>‚ùå</td>
                        <td>Optional key-value pairs for debugging context</td>
                    </tr>
                    <tr>
                        <td>callerMemberName</td>
                        <td>string</td>
                        <td>‚úÖ</td>
                        <td>Auto-populated method name via [CallerMemberName]</td>
                    </tr>
                    <tr>
                        <td>callerFilePath</td>
                        <td>string</td>
                        <td>‚úÖ</td>
                        <td>Auto-populated file path via [CallerFilePath]</td>
                    </tr>
                    <tr>
                        <td>callerLineNumber</td>
                        <td>int</td>
                        <td>‚úÖ</td>
                        <td>Auto-populated line number via [CallerLineNumber]</td>
                    </tr>
                </table>

                <div class="critical-feature">
                    üö® AUTOMATIC SOURCE TRACKING: Uses Caller* attributes to automatically capture method name, file path, and line number without performance impact
                </div>

                <h4>Processing Flow</h4>
                <div class="code-example">
<pre>
1. DetermineErrorCategory(exception) - Categorize based on exception type
2. GenerateErrorKey() - Create unique identifier for duplicate detection
3. IsNewError() - Check session cache for duplicates
4. If new error:
   a. CreateErrorEntry() - Build comprehensive error record
   b. LoggingUtility.LogToFileServer() - Write to network file system
   c. LoggingUtility.LogToMySQL() - Write to database
   d. AddToSessionCache() - Mark as logged to prevent duplicates
5. Fallback error handling if logging itself fails
</pre>
                </div>
            </div>

            <div class="section">
                <h3>üè∑Ô∏è Error Categorization System</h3>

                <h4>DetermineErrorCategory()</h4>
                <div class="method-signature">
                    private static ErrorCategory DetermineErrorCategory(Exception exception)
                </div>
                
                <div class="code-example">
<pre>
return exception switch
{
    _ when exception.GetType().FullName?.Contains("MySql") == true => ErrorCategory.MySQL,
    _ when exception.GetType().FullName?.Contains("Network") == true => ErrorCategory.Network,
    _ when exception.GetType().FullName?.Contains("UI") == true => ErrorCategory.UI,
    ArgumentException => ErrorCategory.BusinessLogic,
    InvalidOperationException => ErrorCategory.BusinessLogic,
    _ => ErrorCategory.Other
};
</pre>
                </div>

                <p><strong>Categorization Logic:</strong></p>
                <ul>
                    <li><strong>MySQL:</strong> Exception type name contains "MySql"</li>
                    <li><strong>Network:</strong> Exception type name contains "Network"</li>
                    <li><strong>UI:</strong> Exception type name contains "UI"</li>
                    <li><strong>BusinessLogic:</strong> ArgumentException, InvalidOperationException</li>
                    <li><strong>Other:</strong> Default category for unmatched exceptions</li>
                </ul>
            </div>

            <div class="section">
                <h3>üîÑ Duplicate Detection System</h3>

                <h4>Session Cache Management</h4>
                <div class="method-signature">
                    private static readonly Dictionary&lt;string, HashSet&lt;string&gt;&gt; _sessionErrorCache = new();
                </div>

                <p><strong>Cache Structure:</strong></p>
                <ul>
                    <li><strong>Key:</strong> ErrorCategory.ToString() (e.g., "UI", "MySQL")</li>
                    <li><strong>Value:</strong> HashSet&lt;string&gt; of unique error keys for that category</li>
                    <li><strong>Thread Safety:</strong> All cache operations protected by lock(_lockObject)</li>
                </ul>

                <h4>Error Key Generation</h4>
                <div class="method-signature">
                    private static string GenerateErrorKey(Exception exception, string memberName, string filePath, int lineNumber)
                </div>
                
                <div class="code-example">
<pre>
return $"{exception.GetType().Name}_{memberName}_{System.IO.Path.GetFileName(filePath)}_{lineNumber}";

// Example output: "ArgumentNullException_SaveInventory_InventoryService.cs_125"
</pre>
                </div>

                <h4>Session Management Methods</h4>
                <div class="code-example">
<pre>
// Clear all session errors (call at application start)
public static void ClearSessionCache()

// Get count of unique errors for a category this session
public static int GetSessionErrorCount(ErrorCategory category)
</pre>
                </div>
            </div>

            <div class="section">
                <h3>üìä Error Entry Data Structure</h3>

                <h4>ErrorEntry Class</h4>
                <div class="method-signature">
                    public class ErrorEntry
                    {
                        public DateTime Timestamp { get; set; }
                        public string UserId { get; set; } = string.Empty;
                        public string MachineName { get; set; } = string.Empty;
                        public ErrorCategory Category { get; set; }
                        public ErrorSeverity Severity { get; set; }
                        public string ErrorMessage { get; set; } = string.Empty;
                        public string FileName { get; set; } = string.Empty;
                        public string MethodName { get; set; } = string.Empty;
                        public int LineNumber { get; set; }
                        public string StackTrace { get; set; } = string.Empty;
                        public string? source { get; set; }
                        public string AdditionalData { get; set; } = string.Empty;
                        public string ExceptionType { get; set; } = string.Empty;
                    }
                </div>

                <p><strong>Data Sources:</strong></p>
                <ul>
                    <li><strong>Timestamp:</strong> DateTime.Now</li>
                    <li><strong>UserId:</strong> Retrieved from application context</li>
                    <li><strong>MachineName:</strong> Environment.MachineName</li>
                    <li><strong>FileName:</strong> Path.GetFileName(callerFilePath)</li>
                    <li><strong>StackTrace:</strong> exception.StackTrace</li>
                    <li><strong>ExceptionType:</strong> exception.GetType().FullName</li>
                </ul>
            </div>

            <div class="section">
                <h3>‚öôÔ∏è Configuration Management</h3>

                <h4>ErrorHandlingConfiguration Class</h4>
                <div class="method-signature">
                    public static class ErrorHandlingConfiguration
                    {
                        private static string _fileServerBasePath = @"\\FileServer\Logs";
                        private static string _mySqlConnectionString = "";
                        private static bool _enableFileServerLogging = true;
                        private static bool _enableMySqlLogging = true;
                        private static bool _enableConsoleLogging = false;
                    }
                </div>

                <table class="parameter-table">
                    <tr>
                        <th>Setting</th>
                        <th>Default Value</th>
                        <th>Purpose</th>
                    </tr>
                    <tr>
                        <td>FileServerBasePath</td>
                        <td>\\FileServer\Logs</td>
                        <td>Network location for error log files</td>
                    </tr>
                    <tr>
                        <td>MySqlConnectionString</td>
                        <td>""</td>
                        <td>Database connection for error logging</td>
                    </tr>
                    <tr>
                        <td>EnableFileServerLogging</td>
                        <td>true</td>
                        <td>Toggle file system logging</td>
                    </tr>
                    <tr>
                        <td>EnableMySqlLogging</td>
                        <td>true</td>
                        <td>Toggle database logging</td>
                    </tr>
                    <tr>
                        <td>EnableConsoleLogging</td>
                        <td>false</td>
                        <td>Toggle console output for debugging</td>
                    </tr>
                </table>

                <h4>Configuration Methods</h4>
                <div class="code-example">
<pre>
// Load from app.config/appsettings.json
public static void LoadFromConfiguration()

// Validate current settings
public static bool ValidateConfiguration()

// Reset to factory defaults
public static void ResetToDefaults()

// Get fallback local path when file server unavailable
public static string FallbackLocalPath =>
    Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
        "MTM_WIP_Application", "Logs");
</pre>
                </div>
            </div>

            <div class="section">
                <h3>üöÄ Initialization System</h3>

                <h4>ErrorHandlingInitializer Class</h4>
                <div class="method-signature">
                    public static class ErrorHandlingInitializer
                </div>

                <h4>Key Initialization Methods</h4>
                <div class="code-example">
<pre>
// Full production initialization
public static bool Initialize(string? fileServerPath = null, string? mySqlConnectionString = null)

// Development/testing initialization (local files only)
public static bool InitializeForDevelopment()

// Test the error handling system
public static bool RunSystemTest()

// Get current system status
public static string GetSystemStatus()

// Clean shutdown procedures
public static void Shutdown()
</pre>
                </div>

                <div class="critical-feature">
                    ‚ö° INITIALIZATION SEQUENCE: LoadConfiguration() ‚Üí ValidateConfiguration() ‚Üí UpdateLoggingUtility() ‚Üí ClearSessionCache() ‚Üí SystemTest()
                </div>
            </div>

            <div class="section">
                <h3>üí¨ User Message Generation</h3>

                <h4>ErrorMessageProvider Class</h4>
                <div class="method-signature">
                    public static class ErrorMessageProvider
                </div>

                <h4>Message Translation System</h4>
                <div class="code-example">
<pre>
// Get user-friendly message for error category
public static string GetUserFriendlyMessage(ErrorCategory category)

// Get recommended actions for user
public static string GetRecommendedActions(ErrorCategory category)

// Get message specific to exception type
public static string GetExceptionSpecificMessage(string exceptionType)

// Get complete user message with severity indicator
public static string GetCompleteUserMessage(ErrorCategory category, string exceptionType, ErrorSeverity severity)

// Determine if error should be shown to user
public static bool ShouldShowToUser(ErrorSeverity severity, ErrorCategory category)
</pre>
                </div>

                <h4>Predefined Messages</h4>
                <div class="code-example">
<pre>
private static readonly Dictionary&lt;ErrorCategory, string&gt; _categoryMessages = new()
{
    { ErrorCategory.UI, "A display issue occurred. The application will continue to work..." },
    { ErrorCategory.BusinessLogic, "A processing error occurred. Please check your input..." },
    { ErrorCategory.MySQL, "A database connection issue occurred. Your changes may not..." },
    { ErrorCategory.Network, "A network connection issue occurred. Please check..." },
    { ErrorCategory.Other, "An unexpected error occurred. Please try again or..." }
};
</pre>
                </div>
            </div>

            <div class="section">
                <h3>üìù Enumeration Definitions</h3>

                <div class="enum-definition">
                    <h4>ErrorCategory Enum</h4>
                    <ul>
                        <li><strong>UI:</strong> User interface related errors</li>
                        <li><strong>BusinessLogic:</strong> Application workflow and validation errors</li>
                        <li><strong>MySQL:</strong> Database related errors</li>
                        <li><strong>Network:</strong> Communication and connectivity errors</li>
                        <li><strong>Other:</strong> All other unclassified errors</li>
                    </ul>
                </div>

                <div class="enum-definition">
                    <h4>ErrorSeverity Enum</h4>
                    <ul>
                        <li><strong>Low:</strong> Minor issues, don't significantly impact functionality</li>
                        <li><strong>Medium:</strong> Impact functionality but allow continued operation</li>
                        <li><strong>High:</strong> Significantly impact functionality</li>
                        <li><strong>Critical:</strong> Prevent normal application operation</li>
                    </ul>
                </div>
            </div>

            <div class="section">
                <h3>üîó Integration Patterns</h3>

                <h4>Usage Example</h4>
                <div class="code-example">
<pre>
try
{
    // Some operation that might fail
    await DoSomethingAsync();
}
catch (Exception ex)
{
    // Handle with automatic source location tracking
    Service_ErrorHandler.HandleException(ex, ErrorSeverity.High,
        source: "DataEntryForm_SaveButton",
        additionalData: new Dictionary&lt;string, object&gt;
        {
            ["UserId"] = currentUser.Id,
            ["RecordId"] = recordId,
            ["Operation"] = "SaveInventoryData"
        });

    // Show user-friendly message
    var category = DetermineErrorCategory(ex);
    var userMessage = ErrorMessageProvider.GetCompleteUserMessage(category, ex.GetType().Name, ErrorSeverity.High);
    if (ErrorMessageProvider.ShouldShowToUser(ErrorSeverity.High, category))
    {
        ShowErrorDialog(userMessage);
    }
}
</pre>
                </div>

                <h4>Dependency Requirements</h4>
                <ul>
                    <li><strong>LoggingUtility:</strong> Handles actual file and database operations</li>
                    <li><strong>Application Context:</strong> Provides current user information</li>
                    <li><strong>Configuration System:</strong> Loads error handling preferences</li>
                    <li><strong>File System Access:</strong> For file server and fallback logging</li>
                </ul>
            </div>

            <div class="keyboard-shortcuts">
                <h3>‚å®Ô∏è Quick Navigation</h3>
                <ul>
                    <li><strong>Alt + P:</strong> Switch to Plain English Documentation</li>
                    <li><strong>Alt + T:</strong> Stay on Technical View</li>
                    <li><strong>Ctrl + F:</strong> Search this page</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.altKey && e.key === 'p') {
                e.preventDefault();
                window.location.href = '../../../PlainEnglish/FileDefinitions/Services/Service_ErrorHandler.html';
            } else if (e.altKey && e.key === 't') {
                e.preventDefault();
                // Already on Technical view
            }
        });
    </script>
</body>
</html>