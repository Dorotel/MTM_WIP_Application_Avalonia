<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DatabaseService - Technical Documentation | MTM WIP Application</title>
    <link rel="stylesheet" href="../../../styles.css">
    <style>
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            margin: 16px 0;
            overflow-x: auto;
        }
        .method-signature {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            margin: 8px 0;
        }
        .parameter-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        .parameter-table th,
        .parameter-table td {
            border: 1px solid #e1e8ed;
            padding: 8px 12px;
            text-align: left;
        }
        .parameter-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .critical-rule {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            border: 2px solid #e53e3e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .implementation-note {
            background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%);
            border-left: 4px solid #3b82f6;
            padding: 16px;
            margin: 16px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <nav class="breadcrumb">
                <a href="../../../index.html">üìö Documentation Hub</a>
                <span>‚Ä∫</span>
                <a href="../../index.html">üîß Technical</a>
                <span>‚Ä∫</span>
                <a href="../Services.html">‚öôÔ∏è Services</a>
                <span>‚Ä∫</span>
                <span>üóÑÔ∏è DatabaseService</span>
            </nav>
            <div class="header-actions">
                <a href="../../../PlainEnglish/FileDefinitions/Services/DatabaseService.html" class="btn btn-secondary">
                    üìñ Switch to Plain English
                </a>
            </div>
            <h1>üóÑÔ∏è DatabaseService Technical Documentation</h1>
            <p class="subtitle">Centralized database access with connection management and stored procedure enforcement</p>
        </header>

        <main>
            <!-- Critical Implementation Rule -->
            <section class="critical-rule">
                <h2>üö® CRITICAL IMPLEMENTATION RULE</h2>
                <p><strong>ALL database operations MUST use stored procedures - NO hard-coded SQL allowed.</strong></p>
                <p>DatabaseService enforces this rule through validation and logging. Any attempt to execute direct SQL will be blocked and logged as a security violation.</p>
            </section>

            <!-- Class Overview -->
            <section>
                <h2>üìã Class Overview</h2>
                
                <div class="code-block">
                    <strong>Namespace:</strong> MTM.Services<br>
                    <strong>Implements:</strong> IDatabaseService<br>
                    <strong>Dependencies:</strong> IConfiguration, ILogger&lt;DatabaseService&gt;
                </div>

                <div class="method-signature">
public class DatabaseService : IDatabaseService
{
    private readonly string _connectionString;
    private readonly ILogger&lt;DatabaseService&gt; _logger;
    private readonly int _commandTimeout;
    private readonly int _maxRetryAttempts;
}</div>

                <div class="card">
                    <h3>üîß Constructor Injection</h3>
                    <div class="method-signature">
public DatabaseService(IConfiguration configuration, ILogger&lt;DatabaseService&gt; logger)
</div>
                    <table class="parameter-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Type</th>
                                <th>Purpose</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>configuration</td>
                                <td>IConfiguration</td>
                                <td>Application configuration for connection strings and settings</td>
                            </tr>
                            <tr>
                                <td>logger</td>
                                <td>ILogger&lt;DatabaseService&gt;</td>
                                <td>Structured logging for all database operations</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Configuration -->
            <section>
                <h2>‚öôÔ∏è Configuration Requirements</h2>
                
                <div class="card">
                    <h3>üìù Required appsettings.json Structure</h3>
                    <div class="code-block">
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=MTM_WIP;Uid=username;Pwd=password;"
  },
  "Database": {
    "CommandTimeout": 30,
    "MaxRetryAttempts": 3,
    "ConnectionPool": {
      "MinPoolSize": 5,
      "MaxPoolSize": 100
    }
  }
}</div>
                </div>

                <div class="implementation-note">
                    <h3>üí° Implementation Note</h3>
                    <p>Configuration values are validated at startup. Missing DefaultConnection will throw ArgumentException during service registration.</p>
                </div>
            </section>

            <!-- Core Methods -->
            <section>
                <h2>üîß Core Methods</h2>

                <!-- Test Connection -->
                <div class="card">
                    <h3>üîå TestConnectionAsync</h3>
                    <div class="method-signature">
public async Task&lt;Result&lt;bool&gt;&gt; TestConnectionAsync(CancellationToken cancellationToken = default)
</div>
                    <p><strong>Purpose:</strong> Validates database connectivity and availability</p>
                    
                    <h4>üìã Implementation Details</h4>
                    <ul>
                        <li>Opens MySqlConnection using configured connection string</li>
                        <li>Executes simple connectivity test (stored procedure or SELECT 1)</li>
                        <li>Returns Result&lt;bool&gt; pattern for consistent error handling</li>
                        <li>Supports cancellation tokens for async operations</li>
                        <li>Logs connection attempts and results</li>
                    </ul>

                    <h4>üîÑ Return Values</h4>
                    <table class="parameter-table">
                        <thead>
                            <tr>
                                <th>Condition</th>
                                <th>Return Value</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Success</td>
                                <td>Result&lt;bool&gt;.Success(true)</td>
                                <td>Database is accessible and responding</td>
                            </tr>
                            <tr>
                                <td>Connection Failure</td>
                                <td>Result&lt;bool&gt;.Failure("error")</td>
                                <td>Database unavailable or connection string invalid</td>
                            </tr>
                            <tr>
                                <td>Timeout</td>
                                <td>Result&lt;bool&gt;.Failure("timeout")</td>
                                <td>Database responding too slowly</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Execute Stored Procedure -->
                <div class="card">
                    <h3>üìã ExecuteStoredProcedureAsync</h3>
                    <div class="method-signature">
public async Task&lt;Result&lt;T&gt;&gt; ExecuteStoredProcedureAsync&lt;T&gt;(
    string storedProcedureName,
    Dictionary&lt;string, object&gt; parameters = null,
    CancellationToken cancellationToken = default)
</div>
                    <p><strong>Purpose:</strong> Executes stored procedures with parameter validation and result mapping</p>
                    
                    <h4>üìã Parameters</h4>
                    <table class="parameter-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Type</th>
                                <th>Required</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>storedProcedureName</td>
                                <td>string</td>
                                <td>‚úÖ</td>
                                <td>Name of stored procedure to execute</td>
                            </tr>
                            <tr>
                                <td>parameters</td>
                                <td>Dictionary&lt;string, object&gt;</td>
                                <td>‚ùå</td>
                                <td>Input parameters for stored procedure</td>
                            </tr>
                            <tr>
                                <td>cancellationToken</td>
                                <td>CancellationToken</td>
                                <td>‚ùå</td>
                                <td>Cancellation support for long operations</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4>üõ°Ô∏è Security Features</h4>
                    <ul>
                        <li><strong>Stored Procedure Validation:</strong> Verifies procedure exists before execution</li>
                        <li><strong>Parameter Sanitization:</strong> Validates and escapes all input parameters</li>
                        <li><strong>SQL Injection Prevention:</strong> Uses parameterized queries exclusively</li>
                        <li><strong>Access Logging:</strong> Records all procedure calls with parameters</li>
                    </ul>
                </div>

                <!-- Execute with DataTable -->
                <div class="card">
                    <h3>üìä ExecuteDataTableAsync</h3>
                    <div class="method-signature">
public async Task&lt;Result&lt;DataTable&gt;&gt; ExecuteDataTableAsync(
    string storedProcedureName,
    Dictionary&lt;string, object&gt; parameters = null,
    CancellationToken cancellationToken = default)
</div>
                    <p><strong>Purpose:</strong> Executes stored procedures returning tabular data</p>
                    
                    <h4>üìã Use Cases</h4>
                    <ul>
                        <li><strong>Inventory Queries:</strong> sp_inventory_GetByLocation, sp_inventory_GetByPartID</li>
                        <li><strong>Transaction History:</strong> sp_transactions_GetByDateRange, sp_transactions_GetByUser</li>
                        <li><strong>Reporting Data:</strong> sp_reports_DailyInventory, sp_reports_TransactionSummary</li>
                        <li><strong>User Management:</strong> sp_users_GetAll, sp_users_GetByRole</li>
                    </ul>

                    <h4>üîÑ Integration with Helper_Database_StoredProcedure</h4>
                    <div class="implementation-note">
                        <p><strong>Legacy Compatibility:</strong> DatabaseService integrates with existing Helper_Database_StoredProcedure.ExecuteDataTableWithStatus() patterns while providing modern async/await support and Result&lt;T&gt; pattern.</p>
                    </div>
                </div>
            </section>

            <!-- Error Handling -->
            <section>
                <h2>üö® Error Handling & Resilience</h2>
                
                <div class="card">
                    <h3>üîÑ Retry Logic Implementation</h3>
                    <div class="code-block">
private async Task&lt;T&gt; ExecuteWithRetryAsync&lt;T&gt;(Func&lt;Task&lt;T&gt;&gt; operation)
{
    for (int attempt = 1; attempt &lt;= _maxRetryAttempts; attempt++)
    {
        try
        {
            return await operation();
        }
        catch (Exception ex) when (IsTransientError(ex) && attempt &lt; _maxRetryAttempts)
        {
            var delay = TimeSpan.FromSeconds(Math.Pow(2, attempt)); // Exponential backoff
            _logger.LogWarning("Database operation failed, retrying in {Delay}ms. Attempt {Attempt}/{MaxAttempts}",
                delay.TotalMilliseconds, attempt, _maxRetryAttempts);
            await Task.Delay(delay);
        }
    }
}</div>

                    <h4>üîç Transient Error Detection</h4>
                    <ul>
                        <li><strong>Network timeouts:</strong> Temporary connectivity issues</li>
                        <li><strong>Database overload:</strong> Temporary resource constraints</li>
                        <li><strong>Connection pool exhaustion:</strong> High concurrent load</li>
                        <li><strong>Deadlocks:</strong> Concurrent transaction conflicts</li>
                    </ul>
                </div>

                <div class="card">
                    <h3>üìù Comprehensive Logging</h3>
                    <div class="code-block">
// Example logging patterns
_logger.LogInformation("Executing stored procedure {ProcedureName} with {ParameterCount} parameters",
    storedProcedureName, parameters?.Count ?? 0);

_logger.LogWarning("Database operation retry attempt {Attempt} for procedure {ProcedureName}",
    attempt, storedProcedureName);

_logger.LogError(ex, "Database operation failed permanently for procedure {ProcedureName}",
    storedProcedureName);</div>

                    <h4>üîç Log Information Captured</h4>
                    <ul>
                        <li><strong>Operation timing:</strong> Execution duration for performance monitoring</li>
                        <li><strong>Parameter values:</strong> Sanitized parameter logging for debugging</li>
                        <li><strong>Error details:</strong> Exception messages and stack traces</li>
                        <li><strong>Connection status:</strong> Connection pool health and usage</li>
                    </ul>
                </div>
            </section>

            <!-- Performance Optimization -->
            <section>
                <h2>‚ö° Performance Optimization</h2>
                
                <div class="card">
                    <h3>üîó Connection Management</h3>
                    <ul>
                        <li><strong>Connection Pooling:</strong> Uses MySql.Data.MySqlClient connection pooling</li>
                        <li><strong>Proper Disposal:</strong> Using statements ensure connections are returned to pool</li>
                        <li><strong>Timeout Management:</strong> Configurable command timeouts prevent hanging operations</li>
                        <li><strong>Pool Monitoring:</strong> Logs connection pool usage and health metrics</li>
                    </ul>
                </div>

                <div class="card">
                    <h3>üìä Query Optimization</h3>
                    <ul>
                        <li><strong>Stored Procedure Only:</strong> Pre-compiled database procedures for optimal performance</li>
                        <li><strong>Parameter Reuse:</strong> Efficient parameter binding and reuse</li>
                        <li><strong>Result Caching:</strong> Optional result caching for frequently accessed data</li>
                        <li><strong>Batch Operations:</strong> Support for bulk operations to reduce round trips</li>
                    </ul>
                </div>
            </section>

            <!-- Integration Patterns -->
            <section>
                <h2>üîó Integration Patterns</h2>
                
                <div class="card">
                    <h3>üèóÔ∏è Dependency Injection Registration</h3>
                    <div class="code-block">
// In Program.cs or ServiceCollectionExtensions
services.AddScoped&lt;IDatabaseService, DatabaseService&gt;();

// Service dependencies
services.AddSingleton&lt;IConfiguration&gt;();
services.AddLogging();
services.Configure&lt;MTMSettings&gt;(configuration.GetSection("MTM"));</div>
                </div>

                <div class="card">
                    <h3>üìã Service Usage Pattern</h3>
                    <div class="code-block">
public class InventoryService : IInventoryService
{
    private readonly IDatabaseService _databaseService;
    
    public InventoryService(IDatabaseService databaseService)
    {
        _databaseService = databaseService;
    }
    
    public async Task&lt;Result&lt;List&lt;InventoryItem&gt;&gt;&gt; GetInventoryByLocationAsync(string location)
    {
        var parameters = new Dictionary&lt;string, object&gt;
        {
            ["Location"] = location
        };
        
        var result = await _databaseService.ExecuteStoredProcedureAsync&lt;List&lt;InventoryItem&gt;&gt;(
            "sp_inventory_GetByLocation", 
            parameters);
            
        return result;
    }
}</div>
                </div>
            </section>

            <!-- Testing -->
            <section>
                <h2>üß™ Testing & Validation</h2>
                
                <div class="card">
                    <h3>‚úÖ Unit Testing Patterns</h3>
                    <div class="code-block">
[Test]
public async Task TestConnectionAsync_ValidConnection_ReturnsSuccess()
{
    // Arrange
    var mockConfig = new Mock&lt;IConfiguration&gt;();
    var mockLogger = new Mock&lt;ILogger&lt;DatabaseService&gt;&gt;();
    mockConfig.Setup(x =&gt; x.GetConnectionString("DefaultConnection"))
             .Returns("valid connection string");
    
    var service = new DatabaseService(mockConfig.Object, mockLogger.Object);
    
    // Act
    var result = await service.TestConnectionAsync();
    
    // Assert
    Assert.IsTrue(result.IsSuccess);
    Assert.IsTrue(result.Value);
}</div>
                </div>

                <div class="card">
                    <h3>üß™ Integration Testing</h3>
                    <ul>
                        <li><strong>Connection validation:</strong> Test with real database connections</li>
                        <li><strong>Stored procedure execution:</strong> Validate parameter passing and result mapping</li>
                        <li><strong>Error handling:</strong> Test timeout, retry, and failure scenarios</li>
                        <li><strong>Performance testing:</strong> Load testing with multiple concurrent operations</li>
                    </ul>
                </div>
            </section>

            <!-- Quick Navigation -->
            <section>
                <h2>üß≠ Related Documentation</h2>
                <div class="grid-3">
                    <a href="../../../PlainEnglish/FileDefinitions/Services/DatabaseService.html" class="nav-card">
                        <h3>üìñ Plain English</h3>
                        <p>Business-friendly explanation</p>
                    </a>
                    <a href="InventoryService.html" class="nav-card">
                        <h3>üì¶ InventoryService</h3>
                        <p>Primary consumer of DatabaseService</p>
                    </a>
                    <a href="../Models/Result.html" class="nav-card">
                        <h3>üìä Result Pattern</h3>
                        <p>Return value pattern used by DatabaseService</p>
                    </a>
                </div>
            </section>
        </main>

        <footer>
            <p>üè≠ MTM WIP Application | DatabaseService Technical Documentation</p>
            <p>üîß Technical Documentation | <a href="../../../PlainEnglish/FileDefinitions/Services/DatabaseService.html">Switch to Plain English View</a></p>
        </footer>
    </div>
</body>
</html>