<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ApplicationStateService - Technical Documentation | MTM WIP Application</title>
    <link rel="stylesheet" href="../../../styles.css">
    <style>
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            margin: 16px 0;
            overflow-x: auto;
        }
        .method-signature {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            margin: 8px 0;
        }
        .parameter-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        .parameter-table th,
        .parameter-table td {
            border: 1px solid #e1e8ed;
            padding: 8px 12px;
            text-align: left;
        }
        .parameter-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .reactive-pattern {
            background: linear-gradient(135deg, #e6f3ff 0%, #cce7ff 100%);
            border-left: 4px solid #0066cc;
            padding: 16px;
            margin: 16px 0;
            border-radius: 4px;
        }
        .thread-safety {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            border: 2px solid #e53e3e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <nav class="breadcrumb">
                <a href="../../../index.html">üìö Documentation Hub</a>
                <span>‚Ä∫</span>
                <a href="../../index.html">üîß Technical</a>
                <span>‚Ä∫</span>
                <a href="../Services.html">‚öôÔ∏è Services</a>
                <span>‚Ä∫</span>
                <span>üåê ApplicationStateService</span>
            </nav>
            <div class="header-actions">
                <a href="../../../PlainEnglish/FileDefinitions/Services/ApplicationStateService.html" class="btn btn-secondary">
                    üìñ Switch to Plain English
                </a>
            </div>
            <h1>üåê ApplicationStateService Technical Documentation</h1>
            <p class="subtitle">Centralized state management with ReactiveUI patterns and thread-safe implementation</p>
        </header>

        <main>
            <!-- Class Overview -->
            <section>
                <h2>üìã Class Overview</h2>
                
                <div class="code-block">
                    <strong>Namespace:</strong> MTM.Services<br>
                    <strong>Implements:</strong> IApplicationStateService, ReactiveObject<br>
                    <strong>Dependencies:</strong> ILogger&lt;ApplicationStateService&gt;<br>
                    <strong>Thread Safety:</strong> ‚úÖ Thread-safe with ReaderWriterLockSlim
                </div>

                <div class="method-signature">
public class ApplicationStateService : ReactiveObject, IApplicationStateService
{
    private readonly ILogger&lt;ApplicationStateService&gt; _logger;
    private readonly ReaderWriterLockSlim _lock = new();
    
    // Reactive properties
    private User? _currentUser;
    private ConnectionStatus _connectionStatus = ConnectionStatus.Disconnected;
    private readonly Dictionary&lt;string, object&gt; _settings = new();

    // Reactive subjects for broadcasting changes
    private readonly Subject&lt;UserChangedEventArgs&gt; _userChangedSubject = new();
    private readonly Subject&lt;ConnectionStatusChangedEventArgs&gt; _connectionStatusChangedSubject = new();
    private readonly Subject&lt;SettingChangedEventArgs&gt; _settingChangedSubject = new();
}</div>

                <div class="card">
                    <h3>üîß Constructor</h3>
                    <div class="method-signature">
public ApplicationStateService(ILogger&lt;ApplicationStateService&gt; logger)
</div>
                    <p><strong>Purpose:</strong> Initializes the service with logging support and reactive infrastructure</p>
                    <ul>
                        <li>Sets up thread-safe locking mechanism</li>
                        <li>Initializes reactive subjects for event broadcasting</li>
                        <li>Configures default connection status (Disconnected)</li>
                        <li>Prepares settings dictionary for global state storage</li>
                    </ul>
                </div>
            </section>

            <!-- ReactiveUI Integration -->
            <section class="reactive-pattern">
                <h2>‚ö° ReactiveUI Integration Patterns</h2>
                
                <h3>üîÑ Reactive Properties</h3>
                <div class="code-block">
// Thread-safe reactive property with backing field
private User? _currentUser;
public User? CurrentUser
{
    get
    {
        _lock.EnterReadLock();
        try
        {
            return _currentUser;
        }
        finally
        {
            _lock.ExitReadLock();
        }
    }
    private set => this.RaiseAndSetIfChanged(ref _currentUser, value);
}</div>

                <h3>üì° Observable Streams</h3>
                <div class="code-block">
// Event streams for reactive subscriptions
public IObservable&lt;UserChangedEventArgs&gt; UserChanged =&gt; _userChangedSubject.AsObservable();
public IObservable&lt;ConnectionStatusChangedEventArgs&gt; ConnectionStatusChanged =&gt; _connectionStatusChangedSubject.AsObservable();
public IObservable&lt;SettingChangedEventArgs&gt; SettingChanged =&gt; _settingChangedSubject.AsObservable();

// Usage in ViewModels
public class InventoryViewModel : ReactiveObject
{
    public InventoryViewModel(IApplicationStateService appState)
    {
        // React to user changes
        appState.UserChanged
            .Where(args =&gt; args.NewUser != null)
            .Subscribe(args =&gt; RefreshUserSpecificData());
            
        // React to connection status changes
        appState.ConnectionStatusChanged
            .Subscribe(args =&gt; UpdateConnectionIndicator(args.NewStatus));
    }
}</div>
            </section>

            <!-- Thread Safety Implementation -->
            <section class="thread-safety">
                <h2>üîí Thread Safety Implementation</h2>
                
                <h3>üõ°Ô∏è ReaderWriterLockSlim Usage</h3>
                <div class="code-block">
private readonly ReaderWriterLockSlim _lock = new();

// Read operations (multiple readers allowed)
public ConnectionStatus ConnectionStatus
{
    get
    {
        _lock.EnterReadLock();
        try
        {
            return _connectionStatus;
        }
        finally
        {
            _lock.ExitReadLock();
        }
    }
}

// Write operations (exclusive access)
public async Task SetCurrentUserAsync(User? user)
{
    _lock.EnterWriteLock();
    try
    {
        var previousUser = _currentUser;
        _currentUser = user;
        
        // Notify after lock is released
        var args = new UserChangedEventArgs(previousUser, user);
        _userChangedSubject.OnNext(args);
        
        _logger.LogInformation("User changed from {PreviousUser} to {CurrentUser}",
            previousUser?.Username ?? "None", user?.Username ?? "None");
    }
    finally
    {
        _lock.ExitWriteLock();
    }
}</div>

                <h3>‚ö†Ô∏è Deadlock Prevention</h3>
                <ul>
                    <li><strong>Lock Ordering:</strong> Consistent lock acquisition order across all methods</li>
                    <li><strong>Timeout Support:</strong> Optional timeouts for lock acquisition</li>
                    <li><strong>Exception Safety:</strong> Finally blocks ensure locks are always released</li>
                    <li><strong>Event Broadcasting:</strong> Reactive notifications sent outside of lock scope</li>
                </ul>
            </section>

            <!-- Core Methods -->
            <section>
                <h2>üîß Core Methods</h2>

                <!-- User Management -->
                <div class="card">
                    <h3>üë§ User State Management</h3>
                    
                    <div class="method-signature">
public async Task SetCurrentUserAsync(User? user)
public async Task ClearCurrentUserAsync()
public bool IsUserLoggedIn =&gt; CurrentUser != null;
</div>

                    <h4>üìã SetCurrentUserAsync Implementation</h4>
                    <div class="code-block">
public async Task SetCurrentUserAsync(User? user)
{
    User? previousUser = null;
    
    _lock.EnterWriteLock();
    try
    {
        previousUser = _currentUser;
        
        // Validate user data
        if (user != null && string.IsNullOrWhiteSpace(user.Username))
        {
            throw new ArgumentException("User must have a valid username", nameof(user));
        }
        
        // Update reactive property (triggers UI updates)
        CurrentUser = user;
        
        // Update session tracking
        if (user != null)
        {
            SetSetting("SessionStartTime", DateTime.UtcNow);
            SetSetting("LastActivityTime", DateTime.UtcNow);
        }
        else
        {
            RemoveSetting("SessionStartTime");
            RemoveSetting("LastActivityTime");
        }
    }
    finally
    {
        _lock.ExitWriteLock();
    }
    
    // Broadcast change outside of lock
    var args = new UserChangedEventArgs(previousUser, user);
    _userChangedSubject.OnNext(args);
    
    _logger.LogInformation("User session {Action}: {Username}",
        user != null ? "Started" : "Ended",
        user?.Username ?? previousUser?.Username ?? "Unknown");
}</div>

                    <table class="parameter-table">
                        <thead>
                            <tr>
                                <th>Method</th>
                                <th>Purpose</th>
                                <th>Thread Safe</th>
                                <th>Reactive</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>SetCurrentUserAsync</td>
                                <td>Sets the active user and broadcasts change</td>
                                <td>‚úÖ</td>
                                <td>‚úÖ</td>
                            </tr>
                            <tr>
                                <td>ClearCurrentUserAsync</td>
                                <td>Logs out current user and clears session</td>
                                <td>‚úÖ</td>
                                <td>‚úÖ</td>
                            </tr>
                            <tr>
                                <td>IsUserLoggedIn</td>
                                <td>Quick check for authentication status</td>
                                <td>‚úÖ</td>
                                <td>‚úÖ</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Connection Status -->
                <div class="card">
                    <h3>üîå Connection Status Management</h3>
                    
                    <div class="method-signature">
public async Task SetConnectionStatusAsync(ConnectionStatus status)
public async Task&lt;bool&gt; TestConnectionsAsync()
</div>

                    <h4>üåê ConnectionStatus Enumeration</h4>
                    <div class="code-block">
public enum ConnectionStatus
{
    Disconnected = 0,    // No connectivity
    Connecting = 1,      // Attempting to connect
    Connected = 2,       // Fully operational
    Degraded = 3,        // Partial connectivity
    Error = 4            // Connection error state
}</div>

                    <h4>üìä Connection Health Monitoring</h4>
                    <div class="code-block">
public async Task&lt;bool&gt; TestConnectionsAsync()
{
    try
    {
        await SetConnectionStatusAsync(ConnectionStatus.Connecting);
        
        // Test database connectivity
        var dbResult = await _databaseService.TestConnectionAsync();
        
        // Test external services
        var servicesHealthy = await TestExternalServicesAsync();
        
        var newStatus = dbResult.IsSuccess && servicesHealthy
            ? ConnectionStatus.Connected
            : ConnectionStatus.Degraded;
            
        await SetConnectionStatusAsync(newStatus);
        
        return newStatus == ConnectionStatus.Connected;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Connection test failed");
        await SetConnectionStatusAsync(ConnectionStatus.Error);
        return false;
    }
}</div>
                </div>

                <!-- Settings Management -->
                <div class="card">
                    <h3>‚öôÔ∏è Global Settings Management</h3>
                    
                    <div class="method-signature">
public void SetSetting&lt;T&gt;(string key, T value)
public T? GetSetting&lt;T&gt;(string key)
public T GetSetting&lt;T&gt;(string key, T defaultValue)
public bool RemoveSetting(string key)
public IReadOnlyDictionary&lt;string, object&gt; GetAllSettings()
</div>

                    <h4>üíæ Type-Safe Settings Storage</h4>
                    <div class="code-block">
public void SetSetting&lt;T&gt;(string key, T value)
{
    if (string.IsNullOrWhiteSpace(key))
        throw new ArgumentException("Setting key cannot be null or empty", nameof(key));
        
    _lock.EnterWriteLock();
    try
    {
        var previousValue = _settings.TryGetValue(key, out var existing) ? existing : null;
        _settings[key] = value!;
        
        // Broadcast setting change
        var args = new SettingChangedEventArgs(key, previousValue, value);
        _settingChangedSubject.OnNext(args);
        
        _logger.LogDebug("Setting updated: {Key} = {Value}", key, value);
    }
    finally
    {
        _lock.ExitWriteLock();
    }
}

public T GetSetting&lt;T&gt;(string key, T defaultValue)
{
    _lock.EnterReadLock();
    try
    {
        if (_settings.TryGetValue(key, out var value) && value is T typedValue)
        {
            return typedValue;
        }
        return defaultValue;
    }
    finally
    {
        _lock.ExitReadLock();
    }
}</div>

                    <h4>üéØ Common Settings Usage Patterns</h4>
                    <div class="code-block">
// User preferences
appState.SetSetting("UI.Theme", "Purple");
appState.SetSetting("UI.DefaultLocation", "Warehouse-A");
appState.SetSetting("UI.RefreshInterval", TimeSpan.FromSeconds(30));

// Session data
appState.SetSetting("CurrentWorkOrder", workOrderId);
appState.SetSetting("SelectedPartIds", selectedParts);
appState.SetSetting("FilterCriteria", searchFilters);

// Feature flags
appState.SetSetting("Features.AdvancedReporting", true);
appState.SetSetting("Features.BulkOperations", user.Role == UserRole.Admin);

// Temporary state
appState.SetSetting("PendingTransactions", pendingList);
appState.SetSetting("DraftReports", unsavedReports);</div>
                </div>
            </section>

            <!-- Event Args Classes -->
            <section>
                <h2>üì° Event Argument Classes</h2>
                
                <div class="card">
                    <h3>üîÑ Change Event Arguments</h3>
                    
                    <div class="method-signature">
public class UserChangedEventArgs : EventArgs
{
    public User? PreviousUser { get; }
    public User? NewUser { get; }
    public DateTime Timestamp { get; }
    
    public UserChangedEventArgs(User? previousUser, User? newUser)
    {
        PreviousUser = previousUser;
        NewUser = newUser;
        Timestamp = DateTime.UtcNow;
    }
}

public class ConnectionStatusChangedEventArgs : EventArgs
{
    public ConnectionStatus PreviousStatus { get; }
    public ConnectionStatus NewStatus { get; }
    public DateTime Timestamp { get; }
    public string? ErrorMessage { get; }
}

public class SettingChangedEventArgs : EventArgs
{
    public string Key { get; }
    public object? PreviousValue { get; }
    public object? NewValue { get; }
    public DateTime Timestamp { get; }
}</div>
                </div>
            </section>

            <!-- Reactive Subscriptions -->
            <section>
                <h2>üîó Reactive Subscription Patterns</h2>
                
                <div class="card">
                    <h3>üìã ViewModel Integration</h3>
                    <div class="code-block">
public class BaseViewModel : ReactiveObject, IDisposable
{
    protected readonly IApplicationStateService AppState;
    private readonly CompositeDisposable _disposables = new();
    
    public BaseViewModel(IApplicationStateService appState)
    {
        AppState = appState;
        
        // Subscribe to user changes
        AppState.UserChanged
            .ObserveOn(RxApp.MainThreadScheduler)
            .Subscribe(OnUserChanged)
            .DisposeWith(_disposables);
            
        // Subscribe to connection status changes
        AppState.ConnectionStatusChanged
            .ObserveOn(RxApp.MainThreadScheduler)
            .Subscribe(OnConnectionStatusChanged)
            .DisposeWith(_disposables);
            
        // Subscribe to specific settings
        AppState.SettingChanged
            .Where(args =&gt; args.Key.StartsWith("UI."))
            .ObserveOn(RxApp.MainThreadScheduler)
            .Subscribe(OnUISettingChanged)
            .DisposeWith(_disposables);
    }
    
    protected virtual void OnUserChanged(UserChangedEventArgs args)
    {
        // Override in derived ViewModels for user-specific logic
        CurrentUser = args.NewUser;
    }
    
    protected virtual void OnConnectionStatusChanged(ConnectionStatusChangedEventArgs args)
    {
        // Override in derived ViewModels for connection-specific logic
        IsOnline = args.NewStatus == ConnectionStatus.Connected;
    }
    
    public void Dispose()
    {
        _disposables?.Dispose();
    }
}</div>
                </div>

                <div class="card">
                    <h3>üéØ Selective Subscriptions</h3>
                    <div class="code-block">
// Subscribe only to specific user role changes
AppState.UserChanged
    .Where(args =&gt; args.NewUser?.Role != args.PreviousUser?.Role)
    .Subscribe(args =&gt; RefreshPermissions());

// Subscribe to connection recovery
AppState.ConnectionStatusChanged
    .Where(args =&gt; args.PreviousStatus != ConnectionStatus.Connected && 
                   args.NewStatus == ConnectionStatus.Connected)
    .Subscribe(args =&gt; OnConnectionRestored());

// Subscribe to theme changes
AppState.SettingChanged
    .Where(args =&gt; args.Key == "UI.Theme")
    .Subscribe(args =&gt; ApplyTheme((string)args.NewValue));

// Subscribe to location changes
AppState.SettingChanged
    .Where(args =&gt; args.Key == "CurrentLocation")
    .Throttle(TimeSpan.FromMilliseconds(500)) // Debounce rapid changes
    .Subscribe(args =&gt; RefreshLocationData());</div>
                </div>
            </section>

            <!-- Performance Considerations -->
            <section>
                <h2>‚ö° Performance Optimization</h2>
                
                <div class="card">
                    <h3>üíæ Memory Management</h3>
                    <ul>
                        <li><strong>Weak References:</strong> Event subscriptions use weak references to prevent memory leaks</li>
                        <li><strong>Disposal Pattern:</strong> Proper disposal of reactive subscriptions and locks</li>
                        <li><strong>Settings Cleanup:</strong> Automatic cleanup of expired session data</li>
                        <li><strong>Observable Caching:</strong> Reactive streams are cached and reused</li>
                    </ul>
                </div>

                <div class="card">
                    <h3>üîÑ Threading Optimization</h3>
                    <ul>
                        <li><strong>Reader-Writer Locks:</strong> Allow concurrent reads while protecting writes</li>
                        <li><strong>Lock-Free Reads:</strong> Frequently accessed properties use lock-free patterns where possible</li>
                        <li><strong>Event Broadcasting:</strong> Notifications sent asynchronously to avoid blocking</li>
                        <li><strong>UI Thread Marshaling:</strong> Reactive notifications automatically marshaled to UI thread</li>
                    </ul>
                </div>
            </section>

            <!-- Testing -->
            <section>
                <h2>üß™ Testing Patterns</h2>
                
                <div class="card">
                    <h3>‚úÖ Unit Testing</h3>
                    <div class="code-block">
[Test]
public async Task SetCurrentUser_ValidUser_BroadcastsChange()
{
    // Arrange
    var logger = new Mock&lt;ILogger&lt;ApplicationStateService&gt;&gt;();
    var service = new ApplicationStateService(logger.Object);
    var newUser = new User { Username = "testuser", Role = UserRole.Operator };
    
    UserChangedEventArgs? receivedArgs = null;
    service.UserChanged.Subscribe(args =&gt; receivedArgs = args);
    
    // Act
    await service.SetCurrentUserAsync(newUser);
    
    // Assert
    Assert.AreEqual(newUser, service.CurrentUser);
    Assert.IsNotNull(receivedArgs);
    Assert.AreEqual(newUser, receivedArgs.NewUser);
    Assert.IsNull(receivedArgs.PreviousUser);
}</div>
                </div>

                <div class="card">
                    <h3>üß™ Integration Testing</h3>
                    <div class="code-block">
[Test]
public async Task ApplicationStateService_ConcurrentAccess_ThreadSafe()
{
    var service = new ApplicationStateService(Mock.Of&lt;ILogger&lt;ApplicationStateService&gt;&gt;());
    var tasks = new List&lt;Task&gt;();
    
    // Concurrent reads
    for (int i = 0; i &lt; 100; i++)
    {
        tasks.Add(Task.Run(() =&gt; 
        {
            var status = service.ConnectionStatus;
            var user = service.CurrentUser;
            var setting = service.GetSetting("TestKey", "default");
        }));
    }
    
    // Concurrent writes
    for (int i = 0; i &lt; 10; i++)
    {
        int index = i;
        tasks.Add(Task.Run(async () =&gt; 
        {
            await service.SetConnectionStatusAsync(ConnectionStatus.Connected);
            service.SetSetting($"Key{index}", $"Value{index}");
        }));
    }
    
    // All operations should complete without exceptions
    await Task.WhenAll(tasks);
}</div>
                </div>
            </section>

            <!-- Quick Navigation -->
            <section>
                <h2>üß≠ Related Documentation</h2>
                <div class="grid-3">
                    <a href="../../../PlainEnglish/FileDefinitions/Services/ApplicationStateService.html" class="nav-card">
                        <h3>üìñ Plain English</h3>
                        <p>Business-friendly explanation</p>
                    </a>
                    <a href="../ViewModels/BaseViewModel.html" class="nav-card">
                        <h3>üéØ BaseViewModel</h3>
                        <p>Primary consumer pattern</p>
                    </a>
                    <a href="../Models/Result.html" class="nav-card">
                        <h3>üìä User Model</h3>
                        <p>User data structure</p>
                    </a>
                </div>
            </section>
        </main>

        <footer>
            <p>üè≠ MTM WIP Application | ApplicationStateService Technical Documentation</p>
            <p>üîß Technical Documentation | <a href="../../../PlainEnglish/FileDefinitions/Services/ApplicationStateService.html">Switch to Plain English View</a></p>
        </footer>
    </div>
</body>
</html>