<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:MTM_WIP_Application_Avalonia.ViewModels.Overlay"
             x:Class="MTM_WIP_Application_Avalonia.Views.Overlays.ProgressOverlayView"
             x:DataType="vm:ProgressOverlayViewModel">

  <Border Background="{DynamicResource MTM_Shared_Logic.CardBackgroundBrush}"
          BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
          BorderThickness="1"
          CornerRadius="12"
          Padding="0"
          MinWidth="600"
          MinHeight="400"
          MaxWidth="800"
          MaxHeight="700">

    <Grid x:Name="MainContainer" RowDefinitions="Auto,*,Auto">

      <!-- Header -->
      <Border Grid.Row="0"
              Background="{DynamicResource MTM_Shared_Logic.PrimaryBrush}"
              CornerRadius="12,12,0,0"
              Padding="24,16">
        <Grid ColumnDefinitions="*,Auto,Auto">
          <StackPanel Grid.Column="0" Orientation="Vertical">
            <TextBlock Text="{Binding OperationName}"
                       FontSize="18"
                       FontWeight="SemiBold"
                       Foreground="White"/>
            <TextBlock Text="{Binding OperationDescription}"
                       FontSize="14"
                       Foreground="White"
                       Opacity="0.9"
                       TextWrapping="Wrap"
                       IsVisible="{Binding OperationDescription, Converter={StaticResource StringNotEmptyToBoolConverter}}"/>
          </StackPanel>

          <!-- View Toggle Buttons -->
          <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" Margin="0,0,16,0">
            <Button Background="Transparent"
                    BorderThickness="1"
                    BorderBrush="White"
                    Command="{Binding ToggleDetailedViewCommand}"
                    Width="32"
                    Height="32"
                    Padding="0"
                    ToolTip.Tip="Toggle detailed view">
              <TextBlock Text="ðŸ“Š"
                         FontSize="14"
                         Foreground="White"
                         HorizontalAlignment="Center"
                         VerticalAlignment="Center"/>
            </Button>

            <Button Background="Transparent"
                    BorderThickness="1"
                    BorderBrush="White"
                    Command="{Binding ToggleStepViewCommand}"
                    Width="32"
                    Height="32"
                    Padding="0"
                    ToolTip.Tip="Toggle step view">
              <TextBlock Text="ðŸ“‹"
                         FontSize="14"
                         Foreground="White"
                         HorizontalAlignment="Center"
                         VerticalAlignment="Center"/>
            </Button>
          </StackPanel>

          <!-- Close Button (only when allowed) -->
          <Button Grid.Column="2"
                  Background="Transparent"
                  BorderThickness="0"
                  Command="{Binding CloseProgressCommand}"
                  Width="32"
                  Height="32"
                  Padding="0"
                  VerticalAlignment="Top"
                  IsVisible="{Binding CanClose}">
            <TextBlock Text="âœ•"
                       FontSize="16"
                       Foreground="White"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"/>
          </Button>
        </Grid>
      </Border>

      <!-- Content -->
      <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="24">
        <StackPanel Spacing="20">

          <!-- Main Progress Bar -->
          <Border Background="{DynamicResource MTM_Shared_Logic.PanelBackgroundBrush}"
                  BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                  BorderThickness="1"
                  CornerRadius="8"
                  Padding="20">
            <StackPanel Spacing="16">

              <!-- Progress Header -->
              <Grid ColumnDefinitions="*,Auto">
                <TextBlock Grid.Column="0"
                           Text="{Binding CurrentStatusMessage}"
                           FontSize="16"
                           FontWeight="Medium"
                           Foreground="{DynamicResource MTM_Shared_Logic.ForegroundBrush}"/>
                <TextBlock Grid.Column="1"
                           Text="{Binding ProgressPercentage, StringFormat='{}{0:F1}%'}"
                           FontSize="16"
                           FontWeight="Bold"
                           Foreground="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                           IsVisible="{Binding !IsIndeterminate}"/>
              </Grid>

              <!-- Main Progress Bar -->
              <Grid>
                <ProgressBar Value="{Binding ProgressPercentage}"
                             Maximum="100"
                             Height="12"
                             Background="{DynamicResource MTM_Shared_Logic.BackgroundBrush}"
                             Foreground="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                             CornerRadius="6"
                             IsIndeterminate="{Binding IsIndeterminate}"
                             IsVisible="{Binding !IsIndeterminate}"/>

                <ProgressBar Height="12"
                             Background="{DynamicResource MTM_Shared_Logic.BackgroundBrush}"
                             Foreground="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                             CornerRadius="6"
                             IsIndeterminate="True"
                             IsVisible="{Binding IsIndeterminate}"/>
              </Grid>

              <!-- Time and Items Information -->
              <Grid ColumnDefinitions="*,*,*" IsVisible="{Binding ShowDetailedProgress}">
                <StackPanel Grid.Column="0" Spacing="4">
                  <TextBlock Text="Elapsed Time"
                             FontSize="12"
                             FontWeight="Medium"
                             Foreground="{DynamicResource MTM_Shared_Logic.SecondaryForegroundBrush}"/>
                  <TextBlock Text="{Binding ElapsedTime, StringFormat='{}{0:hh\\:mm\\:ss}'}"
                             FontSize="14"
                             FontWeight="Medium"
                             Foreground="{DynamicResource MTM_Shared_Logic.ForegroundBrush}"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Spacing="4" IsVisible="{Binding !IsIndeterminate}">
                  <TextBlock Text="Remaining Time"
                             FontSize="12"
                             FontWeight="Medium"
                             Foreground="{DynamicResource MTM_Shared_Logic.SecondaryForegroundBrush}"/>
                  <TextBlock Text="{Binding EstimatedTimeRemaining, StringFormat='{}{0:hh\\:mm\\:ss}'}"
                             FontSize="14"
                             FontWeight="Medium"
                             Foreground="{DynamicResource MTM_Shared_Logic.ForegroundBrush}"/>
                </StackPanel>

                <StackPanel Grid.Column="2" Spacing="4" IsVisible="{Binding TotalItems, Converter={StaticResource GreaterThanZeroConverter}}">
                  <TextBlock Text="Items Processed"
                             FontSize="12"
                             FontWeight="Medium"
                             Foreground="{DynamicResource MTM_Shared_Logic.SecondaryForegroundBrush}"/>
                  <TextBlock Text="{Binding ProcessedItems, StringFormat='{}{0:N0}'} / {Binding TotalItems, StringFormat='{}{0:N0}'}"
                             FontSize="14"
                             FontWeight="Medium"
                             Foreground="{DynamicResource MTM_Shared_Logic.ForegroundBrush}"/>
                </StackPanel>
              </Grid>

              <!-- Items per Second -->
              <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding ShowDetailedProgress}">
                <TextBlock Grid.Column="0"
                           Text="{Binding DetailedStatusMessage}"
                           FontSize="12"
                           Foreground="{DynamicResource MTM_Shared_Logic.SecondaryForegroundBrush}"
                           TextWrapping="Wrap"
                           IsVisible="{Binding DetailedStatusMessage, Converter={StaticResource StringNotEmptyToBoolConverter}}"/>

                <TextBlock Grid.Column="1"
                           Text="{Binding ItemsPerSecond, StringFormat='{}{0:F1} items/sec'}"
                           FontSize="12"
                           FontWeight="Medium"
                           Foreground="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                           IsVisible="{Binding ItemsPerSecond, Converter={StaticResource GreaterThanZeroConverter}}"/>
              </Grid>

            </StackPanel>
          </Border>

          <!-- Step Progress -->
          <Border Background="{DynamicResource MTM_Shared_Logic.PanelBackgroundBrush}"
                  BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                  BorderThickness="1"
                  CornerRadius="8"
                  Padding="20"
                  IsVisible="{Binding ShowStepProgress}">
            <StackPanel Spacing="16">

              <Grid ColumnDefinitions="*,Auto">
                <TextBlock Grid.Column="0"
                           Text="Progress Steps"
                           FontSize="16"
                           FontWeight="Medium"
                           Foreground="{DynamicResource MTM_Shared_Logic.ForegroundBrush}"/>
                <TextBlock Grid.Column="1"
                           Text="{Binding CurrentStepNumber}/{Binding TotalSteps}"
                           FontSize="14"
                           FontWeight="Medium"
                           Foreground="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                           IsVisible="{Binding TotalSteps, Converter={StaticResource GreaterThanZeroConverter}}"/>
              </Grid>

              <!-- Current Step Display -->
              <Border Background="{DynamicResource MTM_Shared_Logic.HighlightBackgroundBrush}"
                      BorderBrush="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                      BorderThickness="1"
                      CornerRadius="6"
                      Padding="16,12"
                      IsVisible="{Binding CurrentStep, Converter={StaticResource StringNotEmptyToBoolConverter}}">
                <Grid ColumnDefinitions="Auto,*">
                  <Border Grid.Column="0"
                          Background="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                          CornerRadius="12"
                          Width="24"
                          Height="24"
                          Margin="0,0,12,0">
                    <TextBlock Text="{Binding CurrentStepNumber}"
                               FontSize="12"
                               FontWeight="Bold"
                               Foreground="White"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>
                  </Border>
                  <TextBlock Grid.Column="1"
                             Text="{Binding CurrentStep}"
                             FontSize="14"
                             FontWeight="Medium"
                             Foreground="{DynamicResource MTM_Shared_Logic.ForegroundBrush}"
                             VerticalAlignment="Center"/>
                </Grid>
              </Border>

              <!-- Progress Steps List -->
              <ItemsControl ItemsSource="{Binding ProgressSteps}" IsVisible="{Binding ProgressSteps.Count, Converter={StaticResource GreaterThanZeroConverter}}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Background="Transparent"
                            BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                            BorderThickness="0,0,0,1"
                            Padding="0,8">
                      <Grid ColumnDefinitions="Auto,*,Auto,Auto">

                        <!-- Step Number -->
                        <Border Grid.Column="0"
                                Background="{Binding Status, Converter={StaticResource ProgressStepStatusToBrushConverter}}"
                                CornerRadius="10"
                                Width="20"
                                Height="20"
                                Margin="0,0,12,0">
                          <TextBlock Text="{Binding StepNumber}"
                                     FontSize="10"
                                     FontWeight="Bold"
                                     Foreground="White"
                                     HorizontalAlignment="Center"
                                     VerticalAlignment="Center"/>
                        </Border>

                        <!-- Step Name -->
                        <StackPanel Grid.Column="1" Spacing="2">
                          <TextBlock Text="{Binding StepName}"
                                     FontSize="13"
                                     FontWeight="Medium"
                                     Foreground="{DynamicResource MTM_Shared_Logic.ForegroundBrush}"/>
                          <TextBlock Text="{Binding ErrorMessage}"
                                     FontSize="11"
                                     Foreground="{DynamicResource MTM_Shared_Logic.ErrorBrush}"
                                     TextWrapping="Wrap"
                                     IsVisible="{Binding ErrorMessage, Converter={StaticResource StringNotEmptyToBoolConverter}}"/>
                        </StackPanel>

                        <!-- Duration -->
                        <TextBlock Grid.Column="2"
                                   Text="{Binding Duration, StringFormat='{}{0:mm\\:ss}'}"
                                   FontSize="11"
                                   Foreground="{DynamicResource MTM_Shared_Logic.SecondaryForegroundBrush}"
                                   VerticalAlignment="Center"
                                   Margin="8,0"
                                   IsVisible="{Binding Duration, Converter={StaticResource NullableToBoolConverter}}"/>

                        <!-- Status Icon -->
                        <TextBlock Grid.Column="3"
                                   Text="{Binding Status, Converter={StaticResource ProgressStepStatusToIconConverter}}"
                                   FontSize="14"
                                   Foreground="{Binding Status, Converter={StaticResource ProgressStepStatusToForegroundConverter}}"
                                   VerticalAlignment="Center"/>
                      </Grid>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>

            </StackPanel>
          </Border>

          <!-- Status History -->
          <Expander Header="Status History"
                    IsExpanded="False"
                    Background="{DynamicResource MTM_Shared_Logic.PanelBackgroundBrush}"
                    BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    IsVisible="{Binding ShowDetailedProgress}">
            <ScrollViewer MaxHeight="200" VerticalScrollBarVisibility="Auto" Margin="16">
              <ItemsControl ItemsSource="{Binding StatusHistory}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding}"
                               FontSize="11"
                               FontFamily="Consolas"
                               Foreground="{DynamicResource MTM_Shared_Logic.SecondaryForegroundBrush}"
                               TextWrapping="Wrap"
                               Margin="0,2"/>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </Expander>

          <!-- Error Display -->
          <Border Background="{DynamicResource MTM_Shared_Logic.ErrorBackgroundBrush}"
                  BorderBrush="{DynamicResource MTM_Shared_Logic.ErrorBorderBrush}"
                  BorderThickness="1"
                  CornerRadius="8"
                  Padding="16"
                  IsVisible="{Binding HasError}">
            <StackPanel Spacing="8">
              <Grid ColumnDefinitions="Auto,*">
                <TextBlock Grid.Column="0"
                           Text="âš ï¸"
                           FontSize="16"
                           Margin="0,0,8,0"/>
                <TextBlock Grid.Column="1"
                           Text="Operation Failed"
                           FontSize="14"
                           FontWeight="Bold"
                           Foreground="{DynamicResource MTM_Shared_Logic.ErrorForegroundBrush}"/>
              </Grid>
              <TextBlock Text="{Binding ErrorMessage}"
                         FontSize="12"
                         TextWrapping="Wrap"
                         Foreground="{DynamicResource MTM_Shared_Logic.ErrorForegroundBrush}"/>
            </StackPanel>
          </Border>

        </StackPanel>
      </ScrollViewer>

      <!-- Action Buttons -->
      <Border Grid.Row="2"
              Background="{DynamicResource MTM_Shared_Logic.PanelBackgroundBrush}"
              BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
              BorderThickness="0,1,0,0"
              CornerRadius="0,0,12,12"
              Padding="24,16">
        <Grid ColumnDefinitions="*,Auto">

          <!-- Status Indicator -->
          <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">

            <!-- Operation Status -->
            <StackPanel Orientation="Horizontal" Spacing="8">
              <Border Width="12" Height="12"
                      Background="{Binding IsCompleted, Converter={StaticResource BoolToCompletionStatusBrushConverter}}"
                      CornerRadius="6"/>
              <TextBlock Text="{Binding CurrentStatusMessage}"
                         FontSize="12"
                         FontWeight="Medium"
                         Foreground="{DynamicResource MTM_Shared_Logic.ForegroundBrush}"
                         VerticalAlignment="Center"/>
            </StackPanel>

            <!-- Cancellation Status -->
            <Border Background="{DynamicResource MTM_Shared_Logic.WarningBackgroundBrush}"
                    CornerRadius="12"
                    Padding="8,4"
                    IsVisible="{Binding IsCancellationRequested}">
              <TextBlock Text="Cancellation Requested"
                         FontSize="10"
                         FontWeight="Medium"
                         Foreground="{DynamicResource MTM_Shared_Logic.WarningForegroundBrush}"/>
            </Border>

          </StackPanel>

          <!-- Action Buttons -->
          <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12">
            <Button Content="Cancel Operation"
                    Command="{Binding RequestCancellationCommand}"
                    Background="Transparent"
                    BorderBrush="{DynamicResource MTM_Shared_Logic.ErrorBrush}"
                    BorderThickness="1"
                    Foreground="{DynamicResource MTM_Shared_Logic.ErrorBrush}"
                    FontSize="14"
                    FontWeight="Medium"
                    Padding="16,8"
                    CornerRadius="6"
                    MinWidth="120"
                    IsVisible="{Binding CanCancel}">
              <Button.Styles>
                <Style Selector="Button:pointerover">
                  <Setter Property="Background" Value="{DynamicResource MTM_Shared_Logic.ErrorBrush}"/>
                  <Setter Property="Foreground" Value="White"/>
                </Style>
              </Button.Styles>
            </Button>

            <Button Content="Close"
                    Command="{Binding CloseProgressCommand}"
                    Background="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                    BorderThickness="0"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Medium"
                    Padding="20,8"
                    CornerRadius="6"
                    MinWidth="100"
                    IsVisible="{Binding CanClose}">
              <Button.Styles>
                <Style Selector="Button:pointerover">
                  <Setter Property="Background" Value="{DynamicResource MTM_Shared_Logic.AccentHoverBrush}"/>
                </Style>
                <Style Selector="Button:disabled">
                  <Setter Property="Background" Value="{DynamicResource MTM_Shared_Logic.DisabledBrush}"/>
                  <Setter Property="Foreground" Value="{DynamicResource MTM_Shared_Logic.DisabledForegroundBrush}"/>
                </Style>
              </Button.Styles>
            </Button>
          </StackPanel>
        </Grid>
      </Border>

    </Grid>
  </Border>

</UserControl>
