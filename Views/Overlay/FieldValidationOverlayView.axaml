<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:MTM_WIP_Application_Avalonia.ViewModels.Overlay"
             x:Class="MTM_WIP_Application_Avalonia.Views.Overlays.FieldValidationOverlayView"
             x:DataType="vm:FieldValidationOverlayViewModel">

  <Border Background="{DynamicResource MTM_Shared_Logic.CardBackgroundBrush}"
          BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
          BorderThickness="1"
          CornerRadius="12"
          Padding="0"
          MinWidth="500"
          MinHeight="400"
          MaxWidth="700"
          MaxHeight="600">

    <Grid x:Name="MainContainer" RowDefinitions="Auto,*,Auto">

      <!-- Header -->
      <Border Grid.Row="0"
              Background="{DynamicResource MTM_Shared_Logic.PrimaryBrush}"
              CornerRadius="12,12,0,0"
              Padding="24,16">
        <Grid ColumnDefinitions="*,Auto">
          <StackPanel Grid.Column="0" Orientation="Vertical">
            <TextBlock Text="{Binding Title}"
                       FontSize="18"
                       FontWeight="SemiBold"
                       Foreground="White"/>
            <TextBlock Text="{Binding FieldLabel, StringFormat='Validating: {0}'}"
                       FontSize="14"
                       Foreground="White"
                       Opacity="0.9"/>
          </StackPanel>

          <!-- Close Button -->
          <Button Grid.Column="1"
                  Background="Transparent"
                  BorderThickness="0"
                  Command="{Binding CancelValidationCommand}"
                  Width="32"
                  Height="32"
                  Padding="0"
                  VerticalAlignment="Top">
            <TextBlock Text="âœ•"
                       FontSize="16"
                       Foreground="White"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"/>
          </Button>
        </Grid>
      </Border>

      <!-- Content -->
      <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="24">
        <StackPanel Spacing="20">

          <!-- Field Input Section -->
          <Border Background="{DynamicResource MTM_Shared_Logic.PanelBackgroundBrush}"
                  BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                  BorderThickness="1"
                  CornerRadius="8"
                  Padding="16">
            <StackPanel Spacing="12">
              <TextBlock Text="Field Value"
                         FontSize="14"
                         FontWeight="Medium"
                         Foreground="{DynamicResource MTM_Shared_Logic.ForegroundBrush}"/>

              <TextBox x:Name="FieldValueTextBox"
                       Text="{Binding FieldValue}"
                       Watermark="{Binding FieldLabel, StringFormat='Enter {0}...'}"
                       FontSize="14"
                       Padding="12,10"
                       BorderBrush="{Binding HasValidationErrors, Converter={StaticResource BoolToValidationBrushConverter}}"
                       BorderThickness="2">
                <TextBox.Styles>
                  <Style Selector="TextBox:focus">
                    <Setter Property="BorderBrush" Value="{DynamicResource MTM_Shared_Logic.AccentBrush}"/>
                  </Style>
                </TextBox.Styles>
              </TextBox>

              <!-- Real-time validation indicator -->
              <Grid ColumnDefinitions="Auto,*,Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" IsVisible="{Binding IsValidating}">
                  <Border Width="16" Height="16"
                          Background="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                          CornerRadius="8">
                    <!-- Simple loading indicator without complex animations -->
                    <TextBlock Text="â—"
                               FontSize="12"
                               Foreground="White"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center" />
                  </Border>
                  <TextBlock Text="Validating..."
                             FontSize="12"
                             Foreground="{DynamicResource MTM_Shared_Logic.SecondaryForegroundBrush}"/>
                </StackPanel>

                <TextBlock Grid.Column="1"
                           Text="{Binding ValidationMessage}"
                           FontSize="12"
                           FontWeight="Medium"
                           Foreground="{Binding HasValidationErrors, Converter={StaticResource BoolToValidationForegroundConverter}}"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           IsVisible="{Binding !IsValidating}"/>

                <Button Grid.Column="2"
                        Content="Validate"
                        Command="{Binding ValidateFieldCommand}"
                        Background="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                        Foreground="White"
                        FontSize="12"
                        Padding="12,6"
                        CornerRadius="4"
                        IsEnabled="{Binding !IsValidating}"/>
              </Grid>
            </StackPanel>
          </Border>

          <!-- Validation Errors -->
          <Border Background="{DynamicResource MTM_Shared_Logic.PanelBackgroundBrush}"
                  BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                  BorderThickness="1"
                  CornerRadius="8"
                  Padding="16"
                  IsVisible="{Binding HasValidationErrors}">
            <StackPanel Spacing="12">
              <TextBlock Text="Validation Issues"
                         FontSize="14"
                         FontWeight="Medium"
                         Foreground="{DynamicResource MTM_Shared_Logic.ForegroundBrush}"/>

              <ItemsControl ItemsSource="{Binding ValidationErrors}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Background="{Binding Severity, Converter={StaticResource SeverityToBackgroundConverter}}"
                            BorderBrush="{Binding Severity, Converter={StaticResource SeverityToBorderConverter}}"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="12,8"
                            Margin="0,2">
                      <Grid ColumnDefinitions="Auto,*">
                        <TextBlock Grid.Column="0"
                                   Text="{Binding Severity, Converter={StaticResource SeverityToIconConverter}}"
                                   FontFamily="{StaticResource IconFont}"
                                   FontSize="16"
                                   Foreground="{Binding Severity, Converter={StaticResource SeverityToForegroundConverter}}"
                                   VerticalAlignment="Top"
                                   Margin="0,0,8,0"/>
                        <StackPanel Grid.Column="1" Spacing="4">
                          <TextBlock Text="{Binding RuleName}"
                                     FontSize="13"
                                     FontWeight="Medium"
                                     Foreground="{Binding Severity, Converter={StaticResource SeverityToForegroundConverter}}"/>
                          <TextBlock Text="{Binding ErrorMessage}"
                                     FontSize="12"
                                     TextWrapping="Wrap"
                                     Foreground="{DynamicResource MTM_Shared_Logic.SecondaryForegroundBrush}"/>
                        </StackPanel>
                      </Grid>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </Border>

          <!-- Suggestions -->
          <Border Background="{DynamicResource MTM_Shared_Logic.PanelBackgroundBrush}"
                  BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                  BorderThickness="1"
                  CornerRadius="8"
                  Padding="16"
                  IsVisible="{Binding ShowSuggestions}">
            <StackPanel Spacing="12">
              <TextBlock Text="Suggestions"
                         FontSize="14"
                         FontWeight="Medium"
                         Foreground="{DynamicResource MTM_Shared_Logic.ForegroundBrush}"/>

              <ItemsControl ItemsSource="{Binding Suggestions}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel Orientation="Horizontal"/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Button Content="{Binding}"
                            Command="{Binding ((vm:FieldValidationOverlayViewModel)DataContext).ApplySuggestionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                            CommandParameter="{Binding}"
                            Background="Transparent"
                            BorderBrush="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                            BorderThickness="1"
                            CornerRadius="16"
                            Padding="12,6"
                            Margin="4,2"
                            FontSize="12">
                      <Button.Styles>
                        <Style Selector="Button:pointerover">
                          <Setter Property="Background" Value="{DynamicResource MTM_Shared_Logic.AccentBrush}"/>
                          <Setter Property="Foreground" Value="White"/>
                        </Style>
                      </Button.Styles>
                    </Button>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </Border>

          <!-- Validation Rules -->
          <Expander Header="Validation Rules"
                    IsExpanded="False"
                    Background="{DynamicResource MTM_Shared_Logic.PanelBackgroundBrush}"
                    BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                    BorderThickness="1"
                    CornerRadius="8">
            <StackPanel Margin="16" Spacing="8">
              <ItemsControl ItemsSource="{Binding ValidationRules}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Background="Transparent"
                            BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                            BorderThickness="0,0,0,1"
                            Padding="0,8">
                      <Grid ColumnDefinitions="Auto,*,Auto">
                        <CheckBox Grid.Column="0"
                                  IsChecked="{Binding IsEnabled}"
                                  IsEnabled="False"
                                  Margin="0,0,12,0"/>
                        <StackPanel Grid.Column="1" Spacing="4">
                          <TextBlock Text="{Binding Name}"
                                     FontSize="13"
                                     FontWeight="Medium"
                                     Foreground="{DynamicResource MTM_Shared_Logic.ForegroundBrush}"/>
                          <TextBlock Text="{Binding Description}"
                                     FontSize="11"
                                     TextWrapping="Wrap"
                                     Foreground="{DynamicResource MTM_Shared_Logic.SecondaryForegroundBrush}"/>
                        </StackPanel>
                        <Border Grid.Column="2"
                                Background="{Binding Severity, Converter={StaticResource SeverityToBackgroundConverter}}"
                                CornerRadius="12"
                                Padding="8,4">
                          <TextBlock Text="{Binding Severity}"
                                     FontSize="10"
                                     FontWeight="Medium"
                                     Foreground="{Binding Severity, Converter={StaticResource SeverityToForegroundConverter}}"/>
                        </Border>
                      </Grid>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </Expander>

          <!-- Help Text -->
          <Border Background="{DynamicResource MTM_Shared_Logic.InfoBackgroundBrush}"
                  BorderBrush="{DynamicResource MTM_Shared_Logic.InfoBorderBrush}"
                  BorderThickness="1"
                  CornerRadius="8"
                  Padding="16"
                  IsVisible="{Binding HelpText, Converter={StaticResource StringNotEmptyToBoolConverter}}">
            <StackPanel Spacing="8">
              <Grid ColumnDefinitions="Auto,*,Auto">
                <TextBlock Grid.Column="0"
                           Text="ðŸ’¡"
                           FontSize="16"
                           Margin="0,0,8,0"/>
                <TextBlock Grid.Column="1"
                           Text="Field Guidelines"
                           FontSize="14"
                           FontWeight="Medium"
                           Foreground="{DynamicResource MTM_Shared_Logic.ForegroundBrush}"/>
                <Button Grid.Column="2"
                        Content="More Help"
                        Command="{Binding ShowHelpCommand}"
                        Background="Transparent"
                        BorderThickness="0"
                        FontSize="12"
                        Foreground="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                        Padding="8,4"/>
              </Grid>
              <TextBlock Text="{Binding HelpText}"
                         FontSize="12"
                         TextWrapping="Wrap"
                         LineHeight="18"
                         Foreground="{DynamicResource MTM_Shared_Logic.SecondaryForegroundBrush}"/>
            </StackPanel>
          </Border>

        </StackPanel>
      </ScrollViewer>

      <!-- Action Buttons -->
      <Border Grid.Row="2"
              Background="{DynamicResource MTM_Shared_Logic.PanelBackgroundBrush}"
              BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
              BorderThickness="0,1,0,0"
              CornerRadius="0,0,12,12"
              Padding="24,16">
        <Grid ColumnDefinitions="*,Auto,Auto">

          <!-- Validation Status -->
          <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
            <Border Width="12" Height="12"
                    Background="{Binding HasValidationErrors, Converter={StaticResource BoolToValidationStatusBrush}}"
                    CornerRadius="6"/>
            <TextBlock Text="{Binding ValidationMessage}"
                       FontSize="12"
                       FontWeight="Medium"
                       Foreground="{Binding HasValidationErrors, Converter={StaticResource BoolToValidationForegroundConverter}}"
                       VerticalAlignment="Center"/>
          </StackPanel>

          <!-- Action Buttons -->
          <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="12">
            <Button Content="Cancel"
                    Command="{Binding CancelValidationCommand}"
                    Background="Transparent"
                    BorderBrush="{DynamicResource MTM_Shared_Logic.BorderMediumBrush}"
                    BorderThickness="1"
                    Foreground="{DynamicResource MTM_Shared_Logic.ForegroundBrush}"
                    FontSize="14"
                    FontWeight="Medium"
                    Padding="20,10"
                    CornerRadius="6"
                    MinWidth="100">
              <Button.Styles>
                <Style Selector="Button:pointerover">
                  <Setter Property="Background" Value="{DynamicResource MTM_Shared_Logic.HoverBrush}"/>
                </Style>
              </Button.Styles>
            </Button>

            <Button Content="Accept"
                    Command="{Binding AcceptValidationCommand}"
                    Background="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                    BorderThickness="0"
                    Foreground="White"
                    FontSize="14"
                    FontWeight="Medium"
                    Padding="20,10"
                    CornerRadius="6"
                    MinWidth="100">
              <Button.Styles>
                <Style Selector="Button:pointerover">
                  <Setter Property="Background" Value="{DynamicResource MTM_Shared_Logic.AccentHoverBrush}"/>
                </Style>
                <Style Selector="Button:disabled">
                  <Setter Property="Background" Value="{DynamicResource MTM_Shared_Logic.DisabledBrush}"/>
                  <Setter Property="Foreground" Value="{DynamicResource MTM_Shared_Logic.DisabledForegroundBrush}"/>
                </Style>
              </Button.Styles>
            </Button>
          </StackPanel>
        </Grid>
      </Border>

    </Grid>
  </Border>

</UserControl>
