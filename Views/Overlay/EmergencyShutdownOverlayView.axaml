<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:MTM_WIP_Application_Avalonia.ViewModels.Overlay"
             x:Class="MTM_WIP_Application_Avalonia.Views.Overlay.EmergencyShutdownOverlayView"
             x:DataType="vm:EmergencyShutdownOverlayViewModel">

  <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
    <Grid x:Name="MainContainer" RowDefinitions="*,Auto" MinWidth="500" MinHeight="400" Margin="8">

      <!-- Emergency Content Area -->
      <Border Grid.Row="0" Background="{DynamicResource MTM_Shared_Logic.CardBackgroundBrush}"
              BorderBrush="{DynamicResource MTM_Shared_Logic.ErrorBrush}"
              BorderThickness="2" CornerRadius="12" Padding="24" Margin="0,0,0,16">

        <Grid x:Name="EmergencyContentGrid" RowDefinitions="Auto,Auto,Auto,Auto,*,Auto">

          <!-- Emergency Header with Icon -->
          <Border Grid.Row="0" Background="{DynamicResource MTM_Shared_Logic.ErrorBrush}"
                  CornerRadius="8" Padding="16,12" Margin="0,0,0,16">
            <Grid x:Name="HeaderGrid" ColumnDefinitions="Auto,*">
              <!-- Warning Icon -->
              <Border Grid.Column="0" Background="White" CornerRadius="16"
                      Width="32" Height="32" Margin="0,0,12,0">
                <TextBlock Text="⚠" FontSize="20" HorizontalAlignment="Center"
                          VerticalAlignment="Center" Foreground="{DynamicResource MTM_Shared_Logic.ErrorBrush}"
                          FontWeight="Bold" />
              </Border>

              <!-- Emergency Title -->
              <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="4">
                <TextBlock Text="Emergency Shutdown Required"
                          FontSize="18" FontWeight="Bold" Foreground="White" />
                <TextBlock Text="{Binding ShutdownReason}"
                          FontSize="14" Foreground="White" TextWrapping="Wrap" />
              </StackPanel>
            </Grid>
          </Border>

          <!-- Emergency Details -->
          <Border Grid.Row="1" Background="{DynamicResource MTM_Shared_Logic.PanelBackgroundBrush}"
                  BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                  BorderThickness="1" CornerRadius="8" Padding="16" Margin="0,0,0,16"
                  IsVisible="{Binding EmergencyDetails, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">

            <StackPanel Spacing="8">
              <TextBlock Text="Additional Details:" FontWeight="SemiBold"
                        Foreground="{DynamicResource MTM_Shared_Logic.TextPrimaryBrush}" />
              <TextBlock Text="{Binding EmergencyDetails}" TextWrapping="Wrap"
                        Foreground="{DynamicResource MTM_Shared_Logic.TextSecondaryBrush}" />
            </StackPanel>
          </Border>

          <!-- Countdown Display -->
          <Border Grid.Row="2" Background="{DynamicResource MTM_Shared_Logic.WarningBrush}"
                  CornerRadius="8" Padding="16" Margin="0,0,0,16"
                  IsVisible="{Binding IsCountdownActive}">

            <Grid x:Name="CountdownGrid" ColumnDefinitions="Auto,*,Auto">
              <!-- Countdown Icon -->
              <Border Grid.Column="0" Background="White" CornerRadius="14"
                      Width="28" Height="28" Margin="0,0,12,0">
                <TextBlock Text="⏱" FontSize="16" HorizontalAlignment="Center"
                          VerticalAlignment="Center" />
              </Border>

              <!-- Countdown Text -->
              <StackPanel Grid.Column="1" VerticalAlignment="Center">
                <TextBlock Text="Automatic shutdown in:" FontWeight="SemiBold"
                          Foreground="White" />
                <TextBlock Text="{Binding CountdownSeconds, StringFormat='{0} seconds'}"
                          FontSize="16" FontWeight="Bold" Foreground="White" />
              </StackPanel>

              <!-- Cancel Button -->
              <Button Grid.Column="2" Content="Cancel"
                      Command="{Binding CancelShutdownCountdownCommand}"
                      Background="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                      Foreground="White" Padding="16,8" CornerRadius="6"
                      FontWeight="SemiBold" />
            </Grid>
          </Border>

          <!-- Shutdown Progress -->
          <Border Grid.Row="3" Background="{DynamicResource MTM_Shared_Logic.PanelBackgroundBrush}"
                  BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                  BorderThickness="1" CornerRadius="8" Padding="16" Margin="0,0,0,16"
                  IsVisible="{Binding IsShuttingDown}">

            <StackPanel Spacing="12">
              <TextBlock Text="Shutdown Progress" FontWeight="SemiBold"
                        Foreground="{DynamicResource MTM_Shared_Logic.TextPrimaryBrush}" />

              <!-- Progress Bar -->
              <ProgressBar Value="{Binding ShutdownProgress}" Maximum="100"
                          Height="8" CornerRadius="4"
                          Background="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                          Foreground="{DynamicResource MTM_Shared_Logic.AccentBrush}" />

              <!-- Progress Text -->
              <TextBlock Text="{Binding ShutdownStatusMessage}"
                        Foreground="{DynamicResource MTM_Shared_Logic.TextSecondaryBrush}"
                        TextAlignment="Center" />

              <!-- Progress Percentage -->
              <TextBlock Text="{Binding ShutdownProgress, StringFormat='{0}%'}"
                        FontWeight="Bold" FontSize="16"
                        Foreground="{DynamicResource MTM_Shared_Logic.AccentBrush}"
                        TextAlignment="Center" />
            </StackPanel>
          </Border>

          <!-- Options Panel -->
          <Border Grid.Row="4" Background="{DynamicResource MTM_Shared_Logic.CardBackgroundBrush}"
                  BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                  BorderThickness="1" CornerRadius="8" Padding="16" Margin="0,0,0,16"
                  IsVisible="{Binding IsShuttingDown, Converter={x:Static BoolConverters.Not}}">

            <StackPanel Spacing="16">
              <TextBlock Text="Shutdown Options" FontWeight="SemiBold"
                        Foreground="{DynamicResource MTM_Shared_Logic.TextPrimaryBrush}" />

              <!-- Data Save Option -->
              <CheckBox IsChecked="{Binding SaveDataBeforeShutdown}"
                        Content="Save critical data before shutdown"
                        Foreground="{DynamicResource MTM_Shared_Logic.TextPrimaryBrush}"
                        IsEnabled="{Binding IsShuttingDown, Converter={x:Static BoolConverters.Not}}" />

              <!-- Timeout Setting -->
              <StackPanel Spacing="8" IsEnabled="{Binding IsCountdownActive, Converter={x:Static BoolConverters.Not}}">
                <TextBlock Text="Shutdown timeout (seconds):"
                          Foreground="{DynamicResource MTM_Shared_Logic.TextPrimaryBrush}" />
                <Grid x:Name="TimeoutGrid" ColumnDefinitions="*,Auto,Auto,Auto">
                  <NumericUpDown Grid.Column="0" Value="{Binding ShutdownTimeoutSeconds}"
                                Minimum="5" Maximum="60" Increment="5"
                                Background="{DynamicResource MTM_Shared_Logic.InputBackgroundBrush}"
                                BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}" />

                  <Button Grid.Column="1" Content="5s" Margin="8,0,0,0" Padding="8,4"
                          Command="{Binding $parent[UserControl].((vm:EmergencyShutdownOverlayViewModel)DataContext).SetTimeoutCommand}"
                          CommandParameter="5" Background="{DynamicResource MTM_Shared_Logic.ButtonSecondaryBrush}" />
                  <Button Grid.Column="2" Content="10s" Margin="4,0,0,0" Padding="8,4"
                          Command="{Binding $parent[UserControl].((vm:EmergencyShutdownOverlayViewModel)DataContext).SetTimeoutCommand}"
                          CommandParameter="10" Background="{DynamicResource MTM_Shared_Logic.ButtonSecondaryBrush}" />
                  <Button Grid.Column="3" Content="30s" Margin="4,0,0,0" Padding="8,4"
                          Command="{Binding $parent[UserControl].((vm:EmergencyShutdownOverlayViewModel)DataContext).SetTimeoutCommand}"
                          CommandParameter="30" Background="{DynamicResource MTM_Shared_Logic.ButtonSecondaryBrush}" />
                </Grid>
              </StackPanel>

              <!-- Status Message -->
              <Border Background="{DynamicResource MTM_Shared_Logic.InfoBrush}"
                      CornerRadius="6" Padding="12">
                <TextBlock Text="{Binding ShutdownStatusMessage}"
                          Foreground="White" FontWeight="SemiBold" TextAlignment="Center" />
              </Border>
            </StackPanel>
          </Border>

          <!-- Current Status Display -->
          <Border Grid.Row="5" Background="{DynamicResource MTM_Shared_Logic.PanelBackgroundBrush}"
                  BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                  BorderThickness="1" CornerRadius="8" Padding="12">

            <Grid x:Name="StatusGrid" ColumnDefinitions="Auto,*">
              <!-- Status Icon -->
              <Border Grid.Column="0" Background="{DynamicResource MTM_Shared_Logic.InfoBrush}"
                      CornerRadius="10" Width="20" Height="20" Margin="0,0,8,0">
                <TextBlock Text="ℹ" FontSize="12" HorizontalAlignment="Center"
                          VerticalAlignment="Center" Foreground="White" FontWeight="Bold" />
              </Border>

              <!-- Status Text -->
              <TextBlock Grid.Column="1" Text="{Binding ShutdownStatusMessage}"
                        VerticalAlignment="Center" TextWrapping="Wrap"
                        Foreground="{DynamicResource MTM_Shared_Logic.TextSecondaryBrush}" />
            </Grid>
          </Border>
        </Grid>
      </Border>

      <!-- Action Buttons Panel -->
      <Border Grid.Row="1" Background="{DynamicResource MTM_Shared_Logic.PanelBackgroundBrush}"
              BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
              BorderThickness="1,0,1,1" CornerRadius="0,0,8,8" Padding="16">

        <Grid x:Name="ActionButtonsGrid" ColumnDefinitions="*,Auto,Auto,Auto,Auto">

          <!-- Continue Operation Button (Left) -->
          <Button Grid.Column="0" Content="Continue Operation"
                  Command="{Binding ContinueOperationCommand}"
                  Background="{DynamicResource MTM_Shared_Logic.SuccessBrush}"
                  Foreground="White" Padding="16,10" CornerRadius="6"
                  FontWeight="SemiBold" HorizontalAlignment="Left"
                  IsVisible="{Binding IsShuttingDown, Converter={x:Static BoolConverters.Not}}" />

          <!-- Countdown Start Button -->
          <Button Grid.Column="1" Content="Start Countdown"
                  Command="{Binding StartShutdownCountdownCommand}"
                  Background="{DynamicResource MTM_Shared_Logic.WarningBrush}"
                  Foreground="White" Padding="16,10" CornerRadius="6"
                  FontWeight="SemiBold" Margin="8,0,0,0"
                  IsVisible="{Binding IsCountdownActive, Converter={x:Static BoolConverters.Not}}" />

          <!-- Emergency Shutdown Button -->
          <Button Grid.Column="2" Content="Emergency Shutdown"
                  Command="{Binding InitiateEmergencyShutdownCommand}"
                  Background="{DynamicResource MTM_Shared_Logic.ErrorBrush}"
                  Foreground="White" Padding="16,10" CornerRadius="6"
                  FontWeight="Bold" Margin="8,0,0,0"
                  IsVisible="{Binding IsShuttingDown, Converter={x:Static BoolConverters.Not}}" />

          <!-- Force Immediate Button -->
          <Button Grid.Column="3" Content="Force Immediate"
                  Command="{Binding ForceImmediateShutdownCommand}"
                  Background="#8B0000" Foreground="White" Padding="16,10" CornerRadius="6"
                  FontWeight="Bold" Margin="8,0,0,0"
                  IsVisible="{Binding IsShuttingDown, Converter={x:Static BoolConverters.Not}}"
                  ToolTip.Tip="Force shutdown without saving data - use only in critical situations" />

          <!-- Cancel Button -->
          <Button Grid.Column="4" Content="Cancel"
                  Command="{Binding CancelCommand}"
                  Background="{DynamicResource MTM_Shared_Logic.ButtonSecondaryBrush}"
                  Foreground="{DynamicResource MTM_Shared_Logic.TextPrimaryBrush}"
                  Padding="16,10" CornerRadius="6"
                  FontWeight="SemiBold" Margin="8,0,0,0"
                  IsVisible="{Binding IsShuttingDown, Converter={x:Static BoolConverters.Not}}" />
        </Grid>
      </Border>
    </Grid>
  </ScrollViewer>
</UserControl>
