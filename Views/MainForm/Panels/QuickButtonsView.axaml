<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MTM_WIP_Application_Avalonia.ViewModels"
             xmlns:materialIcons="using:Material.Icons.Avalonia"
             xmlns:controls="using:MTM_WIP_Application_Avalonia.Controls"
             xmlns:overlay="using:MTM_WIP_Application_Avalonia.Views.Overlay"
             mc:Ignorable="d"
             d:DesignWidth="280"
             d:DesignHeight="720"
             x:Class="MTM_WIP_Application_Avalonia.Views.QuickButtonsView"
             x:CompileBindings="True"
             x:DataType="vm:QuickButtonsViewModel"
             MinWidth="240"
             MinHeight="400">

  <!-- Enhanced Context Menu Styling - Theme V2 Compatible -->
  <UserControl.Styles>
    <Style Selector="ContextMenu">
      <Setter Property="Background" Value="{DynamicResource ThemeV2.Background.Card}"/>
      <Setter Property="BorderBrush" Value="{DynamicResource ThemeV2.Border.Default}"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="CornerRadius" Value="{StaticResource ThemeV2.CornerRadius.Medium}"/>
      <Setter Property="Padding" Value="{StaticResource ThemeV2.Spacing.Small}"/>
    </Style>

    <Style Selector="MenuItem">
      <Setter Property="Foreground" Value="{DynamicResource ThemeV2.Content.Primary}"/>
      <Setter Property="Background" Value="Transparent"/>
      <Setter Property="CornerRadius" Value="{StaticResource ThemeV2.CornerRadius.Small}"/>
      <Setter Property="Padding" Value="{StaticResource ThemeV2.Spacing.Small}"/>
    </Style>

    <Style Selector="MenuItem:pointerover">
      <Setter Property="Background" Value="{DynamicResource ThemeV2.Action.Primary}"/>
      <Setter Property="Foreground" Value="{DynamicResource ThemeV2.Content.OnColor}"/>
    </Style>

    <Style Selector="MenuItem:pressed">
      <Setter Property="Background" Value="{DynamicResource ThemeV2.Action.Primary.Pressed}"/>
      <Setter Property="Foreground" Value="{DynamicResource ThemeV2.Content.OnColor}"/>
    </Style>
  </UserControl.Styles>

  <!-- Main Container - StyleSystem Card with Enhanced Layout -->
  <Border Classes="Card Elevated"
          Background="{DynamicResource ThemeV2.Background.Card}"
          BorderBrush="{DynamicResource ThemeV2.Border.Strong}"
          Margin="{StaticResource ThemeV2.Spacing.Small}"
          Padding="0"
          ClipToBounds="False">
    <Grid x:Name="MainContentGrid" RowDefinitions="Auto,*,Auto" Background="Transparent">
      <!-- Header Panel - StyleSystem Enhanced -->
      <Border Grid.Row="0"
              Classes="HeaderPanel"
              Background="{DynamicResource ThemeV2.Action.Primary}"
              Padding="{StaticResource ThemeV2.Spacing.Medium}"
              MinHeight="{StaticResource ThemeV2.ControlHeight.Standard}"
              Margin="0,0,0,8">
        <Grid ColumnDefinitions="*,Auto,*">
          <!-- Left: Quick Actions Toggle -->
          <Button Grid.Column="0"
                  Classes="HeaderToggle"
                  Classes.Active="{Binding !IsShowingHistory}"
                  Command="{Binding ShowQuickActionsCommand}"
                  HorizontalAlignment="Left"
                  VerticalAlignment="Center"
                  ToolTip.Tip="Show Quick Actions">
            <StackPanel Orientation="Horizontal" Spacing="{StaticResource ThemeV2.Space.XS}">
              <materialIcons:MaterialIcon Kind="Flash"
                                        Width="12"
                                        Height="12"
                                        Foreground="{DynamicResource ThemeV2.Content.OnColor}"/>
              <TextBlock Classes="Caption"
                         Text="Quick Actions"
                         Foreground="{DynamicResource ThemeV2.Content.OnColor}"
                         TextTrimming="CharacterEllipsis"/>
            </StackPanel>
          </Button>

          <!-- Right: Transaction History Toggle -->
          <Button Grid.Column="2"
                  Classes="HeaderToggle"
                  Classes.Active="{Binding IsShowingHistory}"
                  Command="{Binding ShowHistoryCommand}"
                  HorizontalAlignment="Right"
                  VerticalAlignment="Center"
                  ToolTip.Tip="Show Transaction History">
            <StackPanel Orientation="Horizontal" Spacing="{StaticResource ThemeV2.Spacing.XS}">
              <materialIcons:MaterialIcon Kind="ClockOutline"
                                        Width="12"
                                        Height="12"
                                        Foreground="{DynamicResource ThemeV2.Content.OnColor}"/>
              <TextBlock Classes="Caption"
                         Text="History"
                         Foreground="{DynamicResource ThemeV2.Content.OnColor}"
                         TextTrimming="CharacterEllipsis"/>
            </StackPanel>
          </Button>
        </Grid>
      </Border>

      <!-- Dynamic Content Area -->
      <Grid Grid.Row="1" Background="Transparent">

        <!-- Quick Actions Panel - Enhanced StyleSystem Implementation -->
        <Border IsVisible="{Binding !IsShowingHistory}"
                Background="Transparent"
                Padding="{StaticResource ThemeV2.Spacing.Medium}">
          <ItemsControl ItemsSource="{Binding NonEmptyQuickButtons}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <UniformGrid Columns="1" Rows="10"/>
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate DataType="vm:QuickButtonItemViewModel">
                <Button Classes="QuickAction"
                        Command="{Binding $parent[UserControl].((vm:QuickButtonsViewModel)DataContext).ExecuteQuickActionCommand}"
                        CommandParameter="{Binding}"
                        ToolTip.Tip="{Binding ToolTipText}"
                        MinHeight="{StaticResource ThemeV2.ControlHeight.Large}"
                        Height="{StaticResource ThemeV2.ControlHeight.Large}">
                  <Button.ContextMenu>
                    <ContextMenu>
                      <MenuItem Header="ðŸ—‘ï¸ Remove Button"
                                Click="OnRemoveButtonClick"
                                ToolTip.Tip="Delete this quick action"/>
                      <Separator/>
                      <MenuItem Header="â†‘ Move Up"
                                Command="{Binding $parent[UserControl].((vm:QuickButtonsViewModel)DataContext).MoveButtonUpCommand}"
                                CommandParameter="{Binding}"
                                ToolTip.Tip="Move button up in order"/>
                      <MenuItem Header="â†“ Move Down"
                                Command="{Binding $parent[UserControl].((vm:QuickButtonsViewModel)DataContext).MoveButtonDownCommand}"
                                CommandParameter="{Binding}"
                                ToolTip.Tip="Move button down in order"/>
                      <Separator/>
                      <MenuItem Header="ðŸ”„ Refresh Buttons"
                                Command="{Binding $parent[UserControl].((vm:QuickButtonsViewModel)DataContext).RefreshButtonsCommand}"
                                ToolTip.Tip="Reload quick actions from database"/>
                      <MenuItem Header="ðŸ§¹ Clear All Buttons"
                                Command="{Binding $parent[UserControl].((vm:QuickButtonsViewModel)DataContext).ClearAllButtonsCommand}"
                                ToolTip.Tip="Remove all quick actions"/>
                      <MenuItem Header="â†•ï¸ Reset Order"
                                Command="{Binding $parent[UserControl].((vm:QuickButtonsViewModel)DataContext).ResetOrderCommand}"
                                ToolTip.Tip="Restore default button order"/>
                    </ContextMenu>
                  </Button.ContextMenu>

                  <!-- 2-Row Layout with Position and Part ID Column Spanning -->
                  <Grid>
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="10*"/> <!-- Position -->
                      <ColumnDefinition Width="4"/>     <!-- Spacer -->
                      <ColumnDefinition Width="40*"/>     <!-- Part Info -->
                      <ColumnDefinition Width="4"/>     <!-- Spacer -->
                      <ColumnDefinition Width="25*"/>  <!-- QTY -->
                      <ColumnDefinition Width="4"/>     <!-- Spacer -->
                      <ColumnDefinition Width="25*"/>  <!-- OP -->
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                      <RowDefinition Height="*"/>       <!-- Top Row -->
                      <RowDefinition Height="*"/>       <!-- Bottom Row -->
                    </Grid.RowDefinitions>

                    <!-- Position Indicator - Spans both rows -->
                    <Border Grid.Column="0" Grid.RowSpan="2"
                            Background="{DynamicResource ThemeV2.MTM.QuickButton.Position.Background}"
                            BorderBrush="{DynamicResource ThemeV2.MTM.QuickButton.Position.Border}"
                            BorderThickness="1"
                            CornerRadius="{StaticResource ThemeV2.CornerRadius.Small}"
                            Width="20"
                            Height="20"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center">
                      <TextBlock Text="{Binding Position}"
                                 Classes="PositionIndicator"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center"/>
                    </Border>

                    <!-- Part Information - Spans both rows -->

                      <TextBlock Grid.Column="2" Grid.RowSpan="2"
                      Text="{Binding DisplayText}"
                      VerticalAlignment="Center"
                                 Classes="QuickButtonMain"
                                 TextTrimming="CharacterEllipsis"
                                 MaxWidth="100"/>

                    <!-- QTY Badge - Top Row -->
                    <Border Grid.Column="4" Grid.Row="0"
                            Background="{DynamicResource ThemeV2.MTM.QuickButton.Badge.Background}"
                            BorderBrush="{DynamicResource ThemeV2.MTM.QuickButton.Badge.Border}"
                            BorderThickness="1"
                            CornerRadius="{StaticResource ThemeV2.CornerRadius.XS}"
                            MinWidth="28"
                            VerticalAlignment="Center">
                      <TextBlock Text="QTY"
                                 Classes="BadgeLabel"
                                 HorizontalAlignment="Center"/>
                    </Border>

                    <!-- QTY Value - Bottom Row -->
                    <TextBlock Grid.Column="4" Grid.Row="1"
                               Text="{Binding Quantity}"
                               Classes="BadgeValue"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>

                    <!-- OP Badge - Top Row -->
                    <Border Grid.Column="6" Grid.Row="0"
                            Background="{DynamicResource ThemeV2.MTM.QuickButton.Badge.Background}"
                            BorderBrush="{DynamicResource ThemeV2.MTM.QuickButton.Badge.Border}"
                            BorderThickness="1"
                            CornerRadius="{StaticResource ThemeV2.CornerRadius.XS}"
                            MinWidth="28"
                            VerticalAlignment="Center">
                      <TextBlock Text="OP"
                                 Classes="BadgeLabel"
                                 HorizontalAlignment="Center"/>
                    </Border>

                    <!-- OP Value - Bottom Row -->
                    <TextBlock Grid.Column="6" Grid.Row="1"
                               Text="{Binding Operation}"
                               Classes="BadgeValue"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>
                  </Grid>
                  </Button>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </Border>

        <!-- Transaction History Panel - Pre-Approved ScrollViewer -->
        <ScrollViewer IsVisible="{Binding IsShowingHistory}"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled"
                      Background="{DynamicResource ThemeV2.SessionHistory.Background}"
                      Padding="{StaticResource ThemeV2.Spacing.Medium}">

          <!-- Session Transaction History -->
          <ItemsControl ItemsSource="{Binding SessionTransactionHistory}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <StackPanel Orientation="Vertical" Spacing="{StaticResource ThemeV2.Spacing.XS}"/>
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <controls:TransactionExpandableButton
                  PartId="{Binding PartId}"
                  Operation="{Binding Operation}"
                  Quantity="{Binding Quantity}"
                  Location="{Binding Location}"
                  User="{Binding User}"
                  TransactionTime="{Binding TransactionTime}"
                  Status="{Binding Status}"
                  ItemType="{Binding ItemType}"
                  TransactionId="{Binding BatchNumber}"
                  Notes="{Binding Notes}"
                  TransactionType="{Binding TransactionType}"/>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

        </ScrollViewer>

      </Grid>

      <!-- Footer Management Panel - StyleSystem Enhanced -->
      <Border Grid.Row="2"
              Classes="FooterPanel"
              Background="{DynamicResource ThemeV2.Background.Subtle}"
              Padding="{StaticResource ThemeV2.Spacing.Medium}"
              MinHeight="{StaticResource ThemeV2.ControlHeight.Standard}"
              Margin="0,8,0,0">
        <!-- Management Action Buttons -->
        <StackPanel Orientation="Horizontal"
                    Spacing="{StaticResource ThemeV2.Spacing.XS}"
                    HorizontalAlignment="Center">

          <!-- New Quick Button -->
          <Button Classes="FooterToggle"
                  Command="{Binding NewQuickButtonCommand}"
                  ToolTip.Tip="Create new quick button">
            <materialIcons:MaterialIcon Kind="Plus"
                                      Width="12"
                                      Height="12"
                                      Foreground="{DynamicResource ThemeV2.Content.Secondary}"/>
          </Button>

          <!-- Refresh All Buttons -->
          <Button Classes="FooterToggle"
                  Command="{Binding RefreshButtonsCommand}"
                  ToolTip.Tip="Refresh quick buttons from database">
            <materialIcons:MaterialIcon Kind="Refresh"
                                      Width="12"
                                      Height="12"
                                      Foreground="{DynamicResource ThemeV2.Content.Secondary}"/>
          </Button>

          <!-- Clear All Buttons -->
          <Button Classes="FooterToggle"
                  Command="{Binding ClearAllButtonsCommand}"
                  ToolTip.Tip="Remove all quick actions">
            <materialIcons:MaterialIcon Kind="DeleteSweep"
                                      Width="12"
                                      Height="12"
                                      Foreground="{DynamicResource ThemeV2.Content.Secondary}"/>
          </Button>

          <!-- Reset Button Order -->
          <Button Classes="FooterToggle"
                  Command="{Binding ResetOrderCommand}"
                  ToolTip.Tip="Reset button order to default">
            <materialIcons:MaterialIcon Kind="SortAlphabeticalAscending"
                                      Width="12"
                                      Height="12"
                                      Foreground="{DynamicResource ThemeV2.Content.Secondary}"/>
          </Button>

          <!-- Export Configuration -->
          <Button Classes="FooterToggle"
                  Command="{Binding ExportQuickButtonsCommand}"
                  ToolTip.Tip="Export quick buttons configuration">
            <materialIcons:MaterialIcon Kind="Export"
                                      Width="12"
                                      Height="12"
                                      Foreground="{DynamicResource ThemeV2.Content.Secondary}"/>
          </Button>

          <!-- Import Configuration -->
          <Button Classes="FooterToggle"
                  Command="{Binding ImportQuickButtonsCommand}"
                  ToolTip.Tip="Import quick buttons configuration">
            <materialIcons:MaterialIcon Kind="Import"
                                      Width="12"
                                      Height="12"
                                      Foreground="{DynamicResource ThemeV2.Content.Secondary}"/>
          </Button>

          <!-- Help and Support -->
          <Button Classes="FooterToggle"
                  ToolTip.Tip="Show quick buttons help and keyboard shortcuts">
            <materialIcons:MaterialIcon Kind="HelpCircleOutline"
                                      Width="12"
                                      Height="12"
                                      Foreground="{DynamicResource ThemeV2.Content.Secondary}"/>
          </Button>

        </StackPanel>
      </Border>
    </Grid>
  </Border>
</UserControl>
