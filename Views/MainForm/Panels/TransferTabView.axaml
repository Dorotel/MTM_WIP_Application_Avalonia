<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MTM_WIP_Application_Avalonia.ViewModels.MainForm"
             xmlns:materialIcons="using:Material.Icons.Avalonia"
             xmlns:views="using:MTM_WIP_Application_Avalonia.Views"
             xmlns:overlayViews="using:MTM_WIP_Application_Avalonia.Views.Overlay"
             xmlns:conv="using:MTM_WIP_Application_Avalonia.Converters"
             mc:Ignorable="d"
             d:DesignWidth="800"
             d:DesignHeight="600"
             x:Class="MTM_WIP_Application_Avalonia.Views.TransferTabView"
             x:CompileBindings="True"
             x:DataType="vm:TransferItemViewModel">

  <!-- ================================================================== -->
  <!-- RESOURCES -->
  <!-- ================================================================== -->
  <UserControl.Resources>
    <conv:NullToBoolConverter x:Key="NullToBoolConverter" />
  </UserControl.Resources>

  <!-- ================================================================== -->
  <!-- KEY BINDINGS -->
  <!-- ================================================================== -->
  <UserControl.KeyBindings>
    <KeyBinding Gesture="F5" Command="{Binding SearchCommand}" />
    <KeyBinding Gesture="Escape" Command="{Binding ResetCommand}" />
    <KeyBinding Gesture="Enter" Command="{Binding TransferCommand}" />
    <KeyBinding Gesture="Ctrl+P" Command="{Binding PrintCommand}" />
  </UserControl.KeyBindings>

  <!-- ================================================================== -->
  <!-- ROOT CONTAINER -->
  <!-- ================================================================== -->
  <Grid x:Name="RootContainer">

    <!-- ================================================================ -->
    <!-- MASTER CONTAINER -->
    <!-- ================================================================ -->
    <Border x:Name="MasterContainer"
            Background="Transparent"
            BorderThickness="0"
            CornerRadius="0"
            Padding="8"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch"
            ClipToBounds="True">

      <!-- ============================================================== -->
      <!-- MAIN CONTAINER GRID -->
      <!-- ============================================================== -->
      <Grid x:Name="MainContainer"
            RowDefinitions="Auto,*,Auto"
            Background="Transparent"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch"
            ClipToBounds="True">

        <!-- ============================================================ -->
        <!-- SEARCH CRITERIA SECTION -->
        <!-- ============================================================ -->
        <Border Grid.Row="0"
                Classes="Card"
                Padding="16"
                Margin="0,4,0,4"
                HorizontalAlignment="Stretch">

          <StackPanel Spacing="16" HorizontalAlignment="Stretch">

          <!-- ========================================================================================= -->
          <!-- FORM TITLE SECTION - Manufacturing header with icon -->
          <!-- ========================================================================================= -->
          <StackPanel Classes="ManufacturingFormTitle"  Margin="0" >
            <Border Classes="ManufacturingTitleIcon" Margin="0">
              <materialIcons:MaterialIcon Kind="SwapHorizontal" Classes="ManufacturingTitleIcon"/>
            </Border>
            <TextBlock Classes="ManufacturingFormTitle" Margin="0" Text="Transfer Inventory Item"/>
          </StackPanel>

            <!-- Search Form Grid -->
            <Grid Classes="ManufacturingForm"
                  RowDefinitions="Auto"
                  HorizontalAlignment="Stretch">

              <!-- Search Fields Row -->
              <Grid Grid.Row="0"
                    Classes="ManufacturingTwoColumn"
                    ColumnDefinitions="1*,6,1*">

                <!-- Part ID Field -->
                <Border Grid.Column="0" Classes="ManufacturingField">
                  <StackPanel Classes="ManufacturingFieldContent">

                    <StackPanel Classes="ManufacturingFieldHeader">
                      <materialIcons:MaterialIcon Kind="Identifier" Classes="ManufacturingFieldIcon"/>
                      <TextBlock Classes="ManufacturingFieldLabel" Text="Part ID"/>
                    </StackPanel>

                    <TextBox x:Name="PartTextBox"
                             Classes="ManufacturingInput"
                             Text="{Binding PartText, Mode=TwoWay}"
                             Watermark="Enter part ID for transfer..."
                             ToolTip.Tip="Enter part number to search"
                             TabIndex="1"
                             IsEnabled="{Binding CanSearch}"/>
                  </StackPanel>
                </Border>

                <!-- Operation Field -->
                <Border Grid.Column="2" Classes="ManufacturingField">
                  <StackPanel Classes="ManufacturingFieldContent">

                    <StackPanel Classes="ManufacturingFieldHeader">
                      <materialIcons:MaterialIcon Kind="Cog" Classes="ManufacturingFieldIcon"/>
                      <TextBlock Classes="ManufacturingFieldLabel" Text="Operation"/>
                    </StackPanel>

                    <TextBox x:Name="OperationTextBox"
                             Classes="ManufacturingInput"
                             Text="{Binding OperationText, Mode=TwoWay}"
                             Watermark="Enter operation number (optional)..."
                             ToolTip.Tip="Enter operation number (90, 100, 110)"
                             TabIndex="2"
                             IsEnabled="{Binding CanSearch}"/>
                  </StackPanel>
                </Border>

              </Grid>
            </Grid>

            <!-- Search Actions -->
            <Grid Classes="ManufacturingActions" ColumnDefinitions="Auto,*,Auto">

                <!-- Search Button - Left Side -->
                <StackPanel Grid.Column="0"
                                        Orientation="Horizontal"
                                        Spacing="8"
                                        HorizontalAlignment="Left">

                    <Button x:Name="SearchButton"
                                    Classes="Primary ManufacturingSave"
                                    Command="{Binding SearchCommand}"
                                    ToolTip.Tip="Search inventory (F5)"
                                    Height="32"
                                    MinWidth="100"
                                    TabIndex="3">
                        <StackPanel Orientation="Horizontal"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                Spacing="6">
                            <materialIcons:MaterialIcon Kind="Magnify" Classes="ManufacturingActionIcon"/>
                            <TextBlock Classes="Caption" Text="Search"/>
                        </StackPanel>
                    </Button>

                </StackPanel>

                <!-- Reset Button - Right Side -->
                <StackPanel Grid.Column="2"
                                        Orientation="Horizontal"
                                        Spacing="8"
                                        HorizontalAlignment="Right">

                    <Button Classes="Tertiary ManufacturingAdvanced"
                                    Command="{Binding ResetCommand}"
                                    ToolTip.Tip="Reset search criteria (Escape)"
                                    Height="32"
                                    MinWidth="80">
                        <StackPanel Orientation="Horizontal"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                Spacing="6">
                            <materialIcons:MaterialIcon Kind="Refresh" Classes="ManufacturingLargeIcon"/>
                            <TextBlock Classes="Caption" Text="Reset"/>
                        </StackPanel>
                    </Button>

                </StackPanel>
            </Grid>

          </StackPanel>
        </Border>

        <!-- ============================================================ -->
        <!-- RESULTS DATAGRID SECTION -->
        <!-- ============================================================ -->
        <Border Grid.Row="1"
                Classes="Card"
                Padding="16"
                Margin="0,4,0,4"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                ClipToBounds="True">

          <Grid RowDefinitions="Auto,*">

            <!-- Column Customization Toolbar -->
            <Border Grid.Row="0"
                    Classes="ManufacturingToolbar"
                    Padding="0,0,0,8"
                    IsVisible="{Binding HasInventoryItems}">

              <Grid ColumnDefinitions="Auto,*,Auto">

                <!-- Column Visibility Label -->
                <StackPanel Grid.Column="0"
                            Orientation="Horizontal"
                            Spacing="6"
                            VerticalAlignment="Center">
                  <materialIcons:MaterialIcon Kind="ViewColumn"
                                              Classes="ManufacturingFieldIcon"/>
                  <TextBlock Classes="ManufacturingFieldLabel"
                             Text="Columns:"
                             VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Column Customization Dropdown Button -->
                <Button Grid.Column="2"
                        x:Name="ColumnCustomizationButton"
                        Classes="Primary ManufacturingAdvanced"
                        HorizontalContentAlignment="Left"
                        VerticalAlignment="Center"
                        Padding="8,4"
                        ToolTip.Tip="Show/hide columns">

                  <Button.Content>
                    <StackPanel Orientation="Horizontal"
                                Spacing="6"
                                VerticalAlignment="Center">
                      <materialIcons:MaterialIcon Kind="ViewColumn"
                                                  Classes="ManufacturingFieldIcon"/>
                      <materialIcons:MaterialIcon Kind="ChevronDown"
                                                  Classes="ManufacturingSecondaryIcon"
                                                  Width="12"
                                                  Height="12"
                                                  VerticalAlignment="Center"/>
                    </StackPanel>
                  </Button.Content>

                  <Button.Flyout>
                    <Flyout Placement="BottomEdgeAlignedRight"
                            ShowMode="TransientWithDismissOnPointerMoveAway">
                      <Border Classes="Card"
                              Padding="8"
                              MinWidth="220"
                              MaxWidth="300">

                        <StackPanel Spacing="4">

                          <!-- Header -->
                          <Border Classes="ManufacturingFieldHeader"
                                  Padding="8,4"
                                  Margin="0,0,0,8">
                            <TextBlock Classes="Caption"
                                       Text="Column Visibility"
                                       FontWeight="SemiBold"
                                       HorizontalAlignment="Center"/>
                          </Border>

                          <!-- Column Toggle List -->
                          <ScrollViewer MaxHeight="300"
                                        VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding AvailableColumns}">
                              <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                  <Border Classes="ManufacturingField"
                                          Padding="8,4"
                                          Margin="0,1">
                                    <Grid ColumnDefinitions="Auto,*">

                                      <CheckBox Grid.Column="0"
                                                IsChecked="{Binding IsVisible, Mode=TwoWay}"
                                                VerticalAlignment="Center"
                                                Margin="0,0,12,0"/>

                                      <TextBlock Grid.Column="1"
                                                 Classes="Caption"
                                                 Text="{Binding DisplayName}"
                                                 VerticalAlignment="Center"/>
                                    </Grid>
                                  </Border>
                                </DataTemplate>
                              </ItemsControl.ItemTemplate>
                            </ItemsControl>
                          </ScrollViewer>

                          <!-- Footer Actions -->
                          <Border Classes="ManufacturingActions"
                                  Padding="4,8,4,4"
                                  Margin="0,8,0,0"
                                  BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                                  BorderThickness="0,1,0,0">

                            <Grid ColumnDefinitions="Auto,8,Auto"
                                  HorizontalAlignment="Center">
                              <Button Grid.Column="0"
                                      Classes="Tertiary"
                                      Content="Show All"
                                      FontSize="11"
                                      Padding="12,4"
                                      Command="{Binding ShowAllColumnsCommand}"
                                      ToolTip.Tip="Show all columns"/>

                              <Button Grid.Column="2"
                                      Classes="Tertiary"
                                      Content="Hide All"
                                      FontSize="11"
                                      Padding="12,4"
                                      Command="{Binding HideAllColumnsCommand}"
                                      ToolTip.Tip="Hide all columns"/>
                            </Grid>
                          </Border>

                        </StackPanel>
                      </Border>
                    </Flyout>
                  </Button.Flyout>
                </Button>

              </Grid>
            </Border>

            <!-- Inventory Results DataGrid -->
            <DataGrid Grid.Row="1"
                      x:Name="InventoryDataGrid"
                      ItemsSource="{Binding InventoryItems}"
                      SelectedItem="{Binding SelectedInventoryItem, Mode=TwoWay}"
                      IsVisible="{Binding HasInventoryItems}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      CanUserReorderColumns="True"
                      CanUserResizeColumns="True"
                      CanUserSortColumns="True"
                      GridLinesVisibility="All"
                      HeadersVisibility="All"
                      Background="{DynamicResource MTM_Shared_Logic.DataGridBackgroundBrush}"
                      BorderBrush="{DynamicResource MTM_Shared_Logic.BorderLightBrush}"
                      BorderThickness="1"
                      CornerRadius="4"
                      HorizontalAlignment="Stretch"
                      VerticalAlignment="Stretch"
                      ScrollViewer.HorizontalScrollBarVisibility="Auto"
                      ScrollViewer.VerticalScrollBarVisibility="Auto"
                      ToolTip.Tip="Double-click row to edit inventory item">

              <!-- Explicit Column Definitions -->
              <DataGrid.Columns>

                <!-- Part ID Column -->
                <DataGridTextColumn Header="Part Number"
                                    Binding="{Binding PartId}"
                                    Width="120"
                                    CanUserReorder="True"
                                    CanUserResize="True"
                                    CanUserSort="True"
                                    IsVisible="True" />

                <!-- Operation Column -->
                <DataGridTextColumn Header="Operation"
                                    Binding="{Binding Operation}"
                                    Width="80"
                                    CanUserReorder="True"
                                    CanUserResize="True"
                                    CanUserSort="True"
                                    IsVisible="True" />

                <!-- Current Location Column -->
                <DataGridTextColumn Header="Current Location"
                                    Binding="{Binding Location}"
                                    Width="100"
                                    CanUserReorder="True"
                                    CanUserResize="True"
                                    CanUserSort="True"
                                    IsVisible="True" />

                <!-- Quantity Column -->
                <DataGridTextColumn Header="Quantity"
                                    Binding="{Binding Quantity}"
                                    Width="80"
                                    CanUserReorder="True"
                                    CanUserResize="True"
                                    CanUserSort="True"
                                    IsVisible="True" />

                <!-- Item Type Column -->
                <DataGridTextColumn Header="Item Type"
                                    Binding="{Binding ItemType}"
                                    Width="80"
                                    CanUserReorder="True"
                                    CanUserResize="True"
                                    CanUserSort="True"
                                    IsVisible="True" />

                <!-- Transfer Quantity Column -->
                <DataGridTextColumn Header="Transfer Qty"
                                    Binding="{Binding TransferQuantity}"
                                    Width="100"
                                    CanUserReorder="True"
                                    CanUserResize="True"
                                    CanUserSort="True"
                                    IsVisible="True" />

                <!-- Last Updated Column -->
                <DataGridTextColumn Header="Last Updated"
                                    Binding="{Binding LastUpdated}"
                                    Width="130"
                                    CanUserReorder="True"
                                    CanUserResize="True"
                                    CanUserSort="True"
                                    IsVisible="True" />

                <!-- Updated By Column -->
                <DataGridTextColumn Header="Updated By"
                                    Binding="{Binding User}"
                                    Width="100"
                                    CanUserReorder="True"
                                    CanUserResize="True"
                                    CanUserSort="True"
                                    IsVisible="True" />

                <!-- Notes Column -->
                <DataGridTextColumn Header="Notes"
                                    Binding="{Binding Notes}"
                                    Width="200"
                                    CanUserReorder="True"
                                    CanUserResize="True"
                                    CanUserSort="True"
                                    IsVisible="True" />

              </DataGrid.Columns>
            </DataGrid>

            <!-- Nothing Found Indicator -->
            <Border Grid.Row="1"
                    IsVisible="{Binding !HasInventoryItems}"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch"
                    MinHeight="200">

              <StackPanel HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          Spacing="16">

                <materialIcons:MaterialIcon Kind="SwapHorizontal"
                                            Width="48"
                                            Height="48"
                                            Classes="ManufacturingSecondaryIcon"/>

                <TextBlock Classes="ManufacturingFieldLabel"
                           Text="No transfer candidates found"
                           HorizontalAlignment="Center" />

                <TextBlock Classes="Caption"
                           Text="Enter search criteria above and click Search"
                           HorizontalAlignment="Center" />
              </StackPanel>
            </Border>

            <!-- Loading Indicator -->
            <Border Grid.Row="0"
                    IsVisible="{Binding IsLoading}"
                    Background="#80000000"
                    MinHeight="200">

              <StackPanel HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          Spacing="16">

                <ProgressBar IsIndeterminate="True"
                             Width="20"
                             Height="4"/>

                <TextBlock Text="Loading inventory data..."
                           Classes="Caption"
                           HorizontalAlignment="Center" />
              </StackPanel>
            </Border>

          </Grid>
        </Border>

        <!-- ============================================================ -->
        <!-- ACTION BUTTONS PANEL -->
        <!-- ============================================================ -->
          <Grid Classes="ManufacturingActions"
                ColumnDefinitions="Auto,*,Auto"
                Grid.Row="2"
                Margin="0,4,0,4">

            <!-- Primary Actions -->
            <StackPanel Grid.Column="0"
                        Orientation="Horizontal"
                        Spacing="8"
                        HorizontalAlignment="Left">

              <!-- Transfer Selected Button -->
              <Button x:Name="TransferButton"
                      Classes="Primary ManufacturingSave"
                      Command="{Binding TransferCommand}"
                      IsEnabled="{Binding CanTransfer}"
                      ToolTip.Tip="Transfer selected items (Enter key)"
                      Height="32"
                      MinWidth="120"
                      TabIndex="4">
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Spacing="6">
                  <materialIcons:MaterialIcon Kind="SwapHorizontal" Classes="ManufacturingActionIcon"/>
                  <TextBlock Classes="Caption" Text="Transfer Selected"/>
                </StackPanel>
              </Button>

              <!-- Edit Button -->
              <Button Classes="Secondary ManufacturingReset"
                      Command="{Binding EditItemCommand}"
                      IsEnabled="{Binding SelectedInventoryItem, Converter={x:Static ObjectConverters.IsNotNull}}"
                      ToolTip.Tip="Edit selected item"
                      Height="32"
                      MinWidth="80"
                      TabIndex="5">
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Spacing="6">
                  <materialIcons:MaterialIcon Kind="Edit" Classes="ManufacturingSecondaryIcon"/>
                  <TextBlock Classes="Caption" Text="Edit"/>
                </StackPanel>
              </Button>

            </StackPanel>

            <!-- Secondary Actions -->
            <StackPanel Grid.Column="2"
                        Orientation="Horizontal"
                        Spacing="8"
                        HorizontalAlignment="Right">

              <!-- Print Button -->
              <Button Classes="Icon ManufacturingAdvanced"
                      Command="{Binding PrintCommand}"
                      IsEnabled="{Binding HasInventoryItems}"
                      ToolTip.Tip="Print inventory list (Ctrl+P)"
                      Height="32"
                      Width="32"
                      TabIndex="6">
                <materialIcons:MaterialIcon Kind="Printer" Classes="ManufacturingLargeIcon"/>
              </Button>

            </StackPanel>
          </Grid>

      </Grid>
    </Border>

    <!-- ================================================================ -->
    <!-- OVERLAY SECTIONS -->
    <!-- ================================================================ -->

    <!-- Edit Inventory Dialog Overlay -->
    <Border x:Name="EditInventoryDialogOverlay"
            IsVisible="{Binding ShowEditInventoryView}"
            Background="#CC000000"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch">

      <Border Classes="Card"
              Margin="30"
              HorizontalAlignment="Stretch"
              VerticalAlignment="Stretch">
        <overlayViews:EditInventoryView DataContext="{Binding EditInventoryViewModel}" />
      </Border>
    </Border>

  </Grid>
</UserControl>
