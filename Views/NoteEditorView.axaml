<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:MTM_WIP_Application_Avalonia.ViewModels.Overlay"
             xmlns:conv="using:MTM_WIP_Application_Avalonia.Converters"
             xmlns:materialIcons="using:Material.Icons.Avalonia"
             x:Class="MTM_WIP_Application_Avalonia.Views.NoteEditorView"
             x:DataType="vm:NoteEditorViewModel"
             Background="#FFFFFF"
             Focusable="True"
             IsTabStop="True"
             KeyDown="OnUserControlKeyDown">

  <UserControl.Resources>
    <conv:NullToBoolConverter x:Key="NullToBoolConverter" />
  </UserControl.Resources>

  <UserControl.Styles>
    <!-- MTM Amber Theme Button Styles -->
    <Style Selector="Button.action-button">
      <Setter Property="Padding" Value="8,6"/>
      <Setter Property="Margin" Value="3"/>
      <Setter Property="FontSize" Value="11"/>
      <Setter Property="FontWeight" Value="SemiBold"/>
      <Setter Property="CornerRadius" Value="4"/>
      <Setter Property="Cursor" Value="Hand"/>
      <Setter Property="HorizontalContentAlignment" Value="Center"/>
      <Setter Property="VerticalContentAlignment" Value="Center"/>
      <Setter Property="BorderThickness" Value="1"/>
    </Style>

    <Style Selector="Button.primary">
      <Setter Property="Background" Value="#2196F3"/>
      <Setter Property="Foreground" Value="#FFFFFF"/>
      <Setter Property="BorderBrush" Value="#2196F3"/>
    </Style>

    <Style Selector="Button.primary:pointerover">
      <Setter Property="Background" Value="#1976D2"/>
      <Setter Property="BorderBrush" Value="#1976D2"/>
    </Style>

    <Style Selector="Button.secondary">
      <Setter Property="Background" Value="#FFFFFF"/>
      <Setter Property="Foreground" Value="#1976D2"/>
      <Setter Property="BorderBrush" Value="#BDBDBD"/>
    </Style>

    <Style Selector="Button.secondary:pointerover">
      <Setter Property="Background" Value="#616161"/>
      <Setter Property="Foreground" Value="#FFFFFF"/>
      <Setter Property="BorderBrush" Value="#616161"/>
    </Style>

    <!-- Header panel styling -->
    <Style Selector="Border.header-panel">
      <Setter Property="Background" Value="#EEEEEE"/>
      <Setter Property="CornerRadius" Value="12,12,0,0"/>
      <Setter Property="BorderBrush" Value="#2196F3"/>
      <Setter Property="BorderThickness" Value="1,1,1,0"/>
    </Style>

    <!-- Content panel styling -->
    <Style Selector="Border.content-panel">
      <Setter Property="Background" Value="#F5F5F5"/>
      <Setter Property="BorderBrush" Value="#2196F3"/>
      <Setter Property="BorderThickness" Value="1,0,1,0"/>
      <Setter Property="CornerRadius" Value="0"/>
      <Setter Property="Margin" Value="0,1,0,1"/>
    </Style>

    <!-- Action panel styling -->
    <Style Selector="Border.action-panel">
      <Setter Property="Background" Value="#F5F5F5"/>
      <Setter Property="BorderBrush" Value="#2196F3"/>
      <Setter Property="BorderThickness" Value="1,0,1,1"/>
      <Setter Property="CornerRadius" Value="0,0,12,12"/>
    </Style>

    <!-- TextBox styling -->
    <Style Selector="TextBox.note-editor">
      <Setter Property="Background" Value="#FFFFFF"/>
      <Setter Property="BorderBrush" Value="#2196F3"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="CornerRadius" Value="4"/>
      <Setter Property="Foreground" Value="#424242"/>
      <Setter Property="Padding" Value="8"/>
      <Setter Property="FontFamily" Value="Consolas,Monaco,monospace"/>
      <Setter Property="FontSize" Value="12"/>
    </Style>

    <Style Selector="TextBox.note-editor:focus">
      <Setter Property="BorderBrush" Value="#2196F3"/>
      <Setter Property="Background" Value="#F5F5F5"/>
    </Style>

    <!-- Force transparent backgrounds on Material Icons -->
    <Style Selector="materialIcons|MaterialIcon">
      <Setter Property="Background" Value="Transparent"/>
      <Setter Property="Foreground" Value="#1976D2"/>
      <Setter Property="HorizontalAlignment" Value="Center"/>
      <Setter Property="VerticalAlignment" Value="Center"/>
    </Style>
  </UserControl.Styles>

  <!-- Main container with MTM modern panel layout -->
  <Grid RowDefinitions="Auto,*,Auto"
        HorizontalAlignment="Stretch"
        VerticalAlignment="Stretch"
        Margin="4"
        MinWidth="500"
        MinHeight="300">

    <!-- Header Panel with gradient and top rounded corners -->
    <Border Grid.Row="0"
            Classes="header-panel"
            Padding="16,12">
      <Grid ColumnDefinitions="Auto,*,Auto">
        <materialIcons:MaterialIcon Grid.Column="0"
                                    Kind="NoteEdit"
                                    Width="20"
                                    Height="20"
                                    Margin="0,0,12,0"
                                    Foreground="#1976D2"/>
        <StackPanel Grid.Column="1" VerticalAlignment="Center">
          <TextBlock Text="Edit Note"
                     FontWeight="Bold"
                     FontSize="16"
                     Foreground="#FFFFFF"/>
          <TextBlock Text="{Binding PartId, StringFormat='Part: {0}'}"
                     FontSize="12"
                     Foreground="#FFFFFF"
                     Opacity="0.8"
                     Margin="0,2,0,0"/>
        </StackPanel>
        <Button Grid.Column="2"
                Background="Transparent"
                BorderThickness="0"
                Padding="4"
                Cursor="Hand"
                Click="OnCloseClicked">
          <materialIcons:MaterialIcon Kind="Close"
                                      Width="16"
                                      Height="16"
                                      Foreground="#FFFFFF"/>
        </Button>
      </Grid>
    </Border>

    <!-- Main content panel -->
    <Border Grid.Row="1"
            Classes="content-panel"
            Padding="16">
      <Grid RowDefinitions="Auto,Auto,*">

        <!-- Item Info -->
        <Grid Grid.Row="0" ColumnDefinitions="*,*,*" ColumnSpacing="16" Margin="0,0,0,12">
          <StackPanel Grid.Column="0">
            <TextBlock Text="Part ID" FontSize="11" FontWeight="SemiBold"
                       Foreground="#757575" />
            <TextBlock Text="{Binding PartId}" FontSize="12"
                       Foreground="#424242" />
          </StackPanel>
          <StackPanel Grid.Column="1">
            <TextBlock Text="Operation" FontSize="11" FontWeight="SemiBold"
                       Foreground="#757575" />
            <TextBlock Text="{Binding Operation}" FontSize="12"
                       Foreground="#424242" />
          </StackPanel>
          <StackPanel Grid.Column="2">
            <TextBlock Text="Location" FontSize="11" FontWeight="SemiBold"
                       Foreground="#757575" />
            <TextBlock Text="{Binding Location}" FontSize="12"
                       Foreground="#424242" />
          </StackPanel>
        </Grid>

        <!-- Note Label -->
        <TextBlock Grid.Row="1"
                   Text="Note:"
                   FontSize="12"
                   FontWeight="SemiBold"
                   Margin="0,0,0,8"
                   Foreground="#212121"/>

        <!-- Note TextBox Editor with ScrollViewer -->
        <ScrollViewer Grid.Row="2"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Auto">
          <TextBox Classes="note-editor"
                   Text="{Binding NoteText, Mode=TwoWay}"
                   AcceptsReturn="True"
                   TextWrapping="Wrap"
                   IsReadOnly="{Binding IsReadOnly}"
                   x:Name="NoteTextBox"
                   VerticalAlignment="Stretch"
                   VerticalContentAlignment="Top"
                   Watermark="Enter your note here..."
                   MinHeight="150">
            <TextBox.KeyBindings>
              <!-- Escape to cancel -->
              <KeyBinding Gesture="Escape" Command="{Binding CancelCommand}" />
              <!-- Ctrl+S to save -->
              <KeyBinding Gesture="Ctrl+S" Command="{Binding SaveCommand}" />
            </TextBox.KeyBindings>
          </TextBox>
        </ScrollViewer>
      </Grid>
    </Border>

    <!-- Bottom Action Panel with rounded bottom corners -->
    <Border Grid.Row="2"
            Classes="action-panel"
            Padding="12">
      <Grid ColumnDefinitions="*,Auto">

        <!-- Left side - help text -->
        <StackPanel Grid.Column="0"
                    Orientation="Horizontal"
                    VerticalAlignment="Center"
                    Spacing="6">
          <materialIcons:MaterialIcon Kind="Information"
                                      Width="14"
                                      Height="14"
                                      Foreground="#1976D2"/>
          <TextBlock Text="Changes are saved to the database. Press Escape to cancel."
                     FontSize="11"
                     Foreground="#424242"/>
        </StackPanel>

        <!-- Right side buttons -->
        <StackPanel Grid.Column="1"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Spacing="8">
          <Button Classes="action-button secondary"
                  Content="Cancel"
                  Command="{Binding CancelCommand}"
                  Width="80"
                  Height="32"
                  IsEnabled="True">
          </Button>
          <Button x:Name="SaveButton"
                  Classes="action-button primary"
                  Command="{Binding SaveCommand}"
                  Width="80"
                  Height="32"
                  IsEnabled="{Binding !IsLoading}"
                  IsVisible="{Binding !IsReadOnly}">
            <StackPanel Orientation="Horizontal" Spacing="6"
                        HorizontalAlignment="Center" VerticalAlignment="Center">
              <materialIcons:MaterialIcon Kind="ContentSave" Width="14" Height="14"/>
              <TextBlock Text="Save" FontSize="11" FontWeight="SemiBold"/>
            </StackPanel>
          </Button>
        </StackPanel>
      </Grid>
    </Border>
  </Grid>
</UserControl>
